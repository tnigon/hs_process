<!DOCTYPE html>

<html lang="python">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hs_process.batch &#8212; hs_process 0.0.4 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          hs_process</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="https://github.com/tnigon/hs_process">Github</a></li>
                <li><a href="https://anaconda.org/conda-forge/hs-process">Download</a></li>
                <li><a href="http://www.spectralpython.net/">Spectral Python</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Contents <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html">1. Setup and Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial_hsio.html">2. Tutorial: <code class="docutils literal notranslate"><span class="pre">hsio</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial_hstools.html">3. Tutorial: <code class="docutils literal notranslate"><span class="pre">hstools</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial_segment.html">4. Tutorial: <code class="docutils literal notranslate"><span class="pre">segment</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial_spec_mod.html">5. Tutorial: <code class="docutils literal notranslate"><span class="pre">spec_mod</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial_spatial_mod.html">6. Tutorial: <code class="docutils literal notranslate"><span class="pre">spatial_mod</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial_batch.html">7. Tutorial: <code class="docutils literal notranslate"><span class="pre">batch</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../my_hs_process_api.html">8. API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/hs_process.batch.html">8.1.1. batch</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/hs_process.defaults.html">8.1.2. defaults</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/hs_process.hsio.html">8.1.3. hsio</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/hs_process.hstools.html">8.1.4. hstools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/hs_process.segment.html">8.1.5. segment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/hs_process.spatial_mod.html">8.1.6. spatial_mod</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/hs_process.spec_mod.html">8.1.7. spec_mod</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../license.html">9. License</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog.html">10. Change Log</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">1. Setup and Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_hsio.html">2. Tutorial: <code class="docutils literal notranslate"><span class="pre">hsio</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_hstools.html">3. Tutorial: <code class="docutils literal notranslate"><span class="pre">hstools</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_segment.html">4. Tutorial: <code class="docutils literal notranslate"><span class="pre">segment</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_spec_mod.html">5. Tutorial: <code class="docutils literal notranslate"><span class="pre">spec_mod</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_spatial_mod.html">6. Tutorial: <code class="docutils literal notranslate"><span class="pre">spatial_mod</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial_batch.html">7. Tutorial: <code class="docutils literal notranslate"><span class="pre">batch</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../my_hs_process_api.html">8. API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/hs_process.batch.html">8.1.1. batch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/hs_process.defaults.html">8.1.2. defaults</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/hs_process.hsio.html">8.1.3. hsio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/hs_process.hstools.html">8.1.4. hstools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/hs_process.segment.html">8.1.5. segment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/hs_process.spatial_mod.html">8.1.6. spatial_mod</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/hs_process.spec_mod.html">8.1.7. spec_mod</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">9. License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">10. Change Log</a></li>
</ul>
</ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">
<form action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <h1>Source code for hs_process.batch</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">hs_process.utilities</span> <span class="kn">import</span> <span class="n">defaults</span>
<span class="kn">from</span> <span class="nn">hs_process.utilities</span> <span class="kn">import</span> <span class="n">hsio</span>
<span class="kn">from</span> <span class="nn">hs_process.segment</span> <span class="kn">import</span> <span class="n">segment</span>
<span class="kn">from</span> <span class="nn">hs_process.spec_mod</span> <span class="kn">import</span> <span class="n">spec_mod</span>
<span class="kn">from</span> <span class="nn">hs_process.spatial_mod</span> <span class="kn">import</span> <span class="n">spatial_mod</span>

<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">as_completed</span>


<div class="viewcode-block" id="batch"><a class="viewcode-back" href="../../hs_process.html#hs_process.batch">[docs]</a><span class="k">class</span> <span class="nc">batch</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class for batch processing hyperspectral image data. Makes use of</span>
<span class="sd">    `segment`_, `spatial_mod`_, and `spec_mod`_ to batch process many</span>
<span class="sd">    datacubes in a given directory. Supports options to save full</span>
<span class="sd">    datacubes, geotiff renders, as well as summary statistics and/or</span>
<span class="sd">    reports for the various tools.</span>

<span class="sd">    Note:</span>
<span class="sd">        It may be a good idea to review and understand the `defaults`_,</span>
<span class="sd">        `hsio`_, `hstools`_, `segment`_, `spatial_mod`_, and `spec_mod`_</span>
<span class="sd">        classes prior to using the ``batch`` module.</span>

<span class="sd">    .. _defaults: hs_process.defaults.html</span>
<span class="sd">    .. _hsio: hs_process.hsio.html</span>
<span class="sd">    .. _hstools: hs_process.hstools.html</span>
<span class="sd">    .. _segment: hs_process.segment.html</span>
<span class="sd">    .. _spatial_mod: hs_process.spatial_mod.html</span>
<span class="sd">    .. _spec_mod: hs_process.spec_mod.html</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;.bip&#39;</span><span class="p">,</span> <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">lock</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Parameters:</span>
<span class="sd">            base_dir (``str``, optional): directory path to search for files to</span>
<span class="sd">                spectrally clip; if ``fname_list`` is not ``None``, ``base_dir`` will</span>
<span class="sd">                be ignored (default: ``None``).</span>
<span class="sd">            search_ext (``str``): file format/extension to search for in all</span>
<span class="sd">                directories and subdirectories to determine which files to</span>
<span class="sd">                process; if ``fname_list`` is not ``None``, ``search_ext`` will</span>
<span class="sd">                be ignored (default: &#39;bip&#39;).</span>
<span class="sd">            dir_level (``int``): The number of directory levels to search; if</span>
<span class="sd">                ``None``, searches all directory levels (default: 0).</span>
<span class="sd">            lock (``multiprocessing.Lock``): Can be passed to ensure lock is in</span>
<span class="sd">                place when writing to a file during multiprocessing.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">base_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search_ext</span> <span class="o">=</span> <span class="n">search_ext</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir_level</span> <span class="o">=</span> <span class="n">dir_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">lock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="o">=</span> <span class="n">progress_bar</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fname_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">io</span> <span class="o">=</span> <span class="n">hsio</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_try_spat_crop_col_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">df_row</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gets value of ``key`` (column name) from ``df_row``; returns</span>
<span class="sd">        ``None`` if there is a KeyError</span>

<span class="sd">        This is tricky for crop_X and buf_X columns, because we must decipher</span>
<span class="sd">        whether to get these values from the default pool or not. If we get a</span>
<span class="sd">        KeyError, our first instinct is to gather the default, but we must</span>
<span class="sd">        check the &quot;inverse&quot; first (the &quot;inverse&quot; of crop_e_pix is crop_e_m) to</span>
<span class="sd">        avoid overwriting a value passed in df_row unintentionally. Therefore,</span>
<span class="sd">        this function handles keys differently if &quot;crop&quot; or &quot;buf&quot; are part of</span>
<span class="sd">        ``key`` than if they are not part of ``key``</span>

<span class="sd">        Adds ``key`` to batch.io.defaults.spat_crop_cols if it does not yet</span>
<span class="sd">        exist, but then of course the ``value`` that is returned will be</span>
<span class="sd">        ``None``</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">spat_crop_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding key &quot;</span><span class="si">{0}</span><span class="s1">&quot; to defaults.spat_crop_cols dictionary&#39;</span>
                  <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">spat_crop_cols</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">df_row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">spat_crop_cols</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c1"># try to retrieve a default value</span>
            <span class="c1"># decide whehter to get default or not.. how?</span>
            <span class="c1"># check the inverse to see if it is accesible</span>
            <span class="c1"># try:</span>
            <span class="c1">#     value = self.io.defaults.crop_defaults[key]</span>
            <span class="c1"># except KeyError:</span>
            <span class="c1">#     value = None</span>
            <span class="k">if</span> <span class="s1">&#39;crop&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="s1">&#39;buf&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">key_base</span> <span class="o">=</span> <span class="n">key</span><span class="p">[:</span><span class="n">key</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))]</span>
                <span class="n">key_unit</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)):]</span>
                <span class="k">if</span> <span class="n">key_unit</span> <span class="o">==</span> <span class="s1">&#39;_m&#39;</span><span class="p">:</span>
                    <span class="n">key_unit_inv</span> <span class="o">=</span> <span class="s1">&#39;_pix&#39;</span>
                <span class="k">elif</span> <span class="n">key_unit</span> <span class="o">==</span> <span class="s1">&#39;_pix&#39;</span><span class="p">:</span>
                    <span class="n">key_unit_inv</span> <span class="o">=</span> <span class="s1">&#39;_m&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value_inv</span> <span class="o">=</span> <span class="n">df_row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">spat_crop_cols</span><span class="p">[</span><span class="n">key_base</span><span class="o">+</span><span class="n">key_unit_inv</span><span class="p">]]</span>  <span class="c1"># exists; set to NaN and carry on</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c1"># neither exist, gather default</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">crop_defaults</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># proceed as normal</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">crop_defaults</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># if key in [&#39;crop_e_m&#39;, &#39;crop_n_m&#39;, &#39;crop_e_pix&#39;, &#39;crop_n_pix&#39;]:</span>
        <span class="c1">#     print(&#39;Key: {0}  Value: {1}&#39;.format(key, value))</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_check_processed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                         <span class="n">name_append</span><span class="p">,</span> <span class="n">append_extra</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks if any files in fname_list have already (presumably) undergone</span>
<span class="sd">        processing. This is determined by checking if a file exists with a</span>
<span class="sd">        particular name based on the filename in fname_list and naming</span>
<span class="sd">        parameters (i.e,. ``folder_name`` and ``name_append``).</span>

<span class="sd">        Parameters:</span>
<span class="sd">            ext (``str``): e.g., &#39;.spec&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">append_extra</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">append_extra</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">fname_list_final</span> <span class="o">=</span> <span class="n">fname_list</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ext</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="n">append_extra</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="n">append_extra</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">)):</span>
                <span class="n">fname_list_final</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">msg1</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;There are no files to process. Please check if files have &#39;</span>
                <span class="s1">&#39;already undergone processing. If existing files should be &#39;</span>
                <span class="s1">&#39;overwritten, be sure to set the ``out_force`` parameter.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">msg2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Processing </span><span class="si">{0}</span><span class="s1"> files. If existing files should be &#39;</span>
                <span class="s1">&#39;overwritten, be sure to set the ``out_force`` parameter.</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fname_list_final</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">fname_list_final</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg1</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     print(msg2)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># when using progress bar, this keeps from splitting lines</span>
        <span class="k">return</span> <span class="n">fname_list_final</span>

    <span class="k">def</span> <span class="nf">_crop_read_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reads the necessary information from the spreadsheet and saves it</span>
<span class="sd">        to a dictionary</span>

<span class="sd">        If this function causes an error, try checking</span>
<span class="sd">        ``batch.io.defaults.spat_crop_col`` - these should be adjusted</span>
<span class="sd">        according to the default column names of the input (i.e.,</span>
<span class="sd">        ``fname_sheet``).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">crop_specs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;directory&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;directory&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;fname&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;fname&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;name_short&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;name_short&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;name_long&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;name_long&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;ext&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;ext&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;plot_id_ref&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;plot_id_ref&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;pix_e_ul&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;pix_e_ul&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;pix_n_ul&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;pix_n_ul&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;alley_size_e_m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;alley_size_e_m&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;alley_size_n_m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;alley_size_n_m&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;alley_size_e_pix&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;alley_size_e_pix&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;alley_size_n_pix&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;alley_size_n_pix&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;buf_e_m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;buf_e_m&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;buf_n_m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;buf_n_m&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;buf_e_pix&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;buf_e_pix&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;buf_n_pix&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;buf_n_pix&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;crop_e_m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;crop_e_m&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;crop_n_m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;crop_n_m&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;crop_e_pix&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;crop_e_pix&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;crop_n_pix&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;crop_n_pix&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;gdf_shft_e_pix&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;gdf_shft_e_pix&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;gdf_shft_n_pix&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;gdf_shft_n_pix&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;gdf_shft_e_m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;gdf_shft_e_m&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;gdf_shft_n_m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;gdf_shft_n_m&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;n_plots_x&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;n_plots_x&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;n_plots_y&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;n_plots_y&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;n_plots&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_spat_crop_col_key</span><span class="p">(</span><span class="s1">&#39;n_plots&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">)}</span>
        <span class="k">if</span> <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;name_short&#39;</span><span class="p">]</span> <span class="o">+</span>
                                       <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;name_long&#39;</span><span class="p">]</span> <span class="o">+</span>
                                       <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;ext&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;name_short&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;name_short&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_name</span><span class="p">[</span>
                        <span class="p">:</span><span class="n">base_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))]</span>
            <span class="k">if</span> <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;name_long&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;name_long&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_name</span><span class="p">[</span>
                        <span class="n">base_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)):]</span>
            <span class="k">if</span> <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;ext&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;ext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">spat_crop_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">crop_specs</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;name_long&#39;</span><span class="p">]):</span>
            <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;name_long&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;plot_id_ref&#39;</span><span class="p">]):</span>
            <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;plot_id_ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;name_short&#39;</span><span class="p">]):</span>
            <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;name_short&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">crop_specs</span> <span class="o">=</span> <span class="n">crop_specs</span>
        <span class="k">return</span> <span class="n">crop_specs</span>

    <span class="k">def</span> <span class="nf">_pix_to_mapunit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crop_specs</span><span class="p">,</span> <span class="n">spyfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Looks over specifications of ``crop_specs``, and converts betweeen pixel</span>
<span class="sd">        units and map units if one is populated and the other is ``None``</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">crop_specs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">spyfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spyfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span>
        <span class="n">spy_ps_e</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spyfile</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;map info&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">spy_ps_n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spyfile</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;map info&#39;</span><span class="p">][</span><span class="mi">6</span><span class="p">])</span>
        <span class="c1"># Crop size</span>
<span class="c1">#        if cs[&#39;crop_e_pix&#39;] is None and cs[&#39;crop_e_m&#39;] is not None:</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_pix&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_m&#39;</span><span class="p">]):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_m&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">spy_ps_e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_pix&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_m&#39;</span><span class="p">]):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_pix&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">spy_ps_e</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_pix&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_m&#39;</span><span class="p">]):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_m&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">spy_ps_n</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_pix&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_m&#39;</span><span class="p">]):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_pix&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">spy_ps_n</span>
        <span class="c1"># Buffer</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_pix&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_m&#39;</span><span class="p">]):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_m&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">spy_ps_e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_pix&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_m&#39;</span><span class="p">]):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_pix&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">spy_ps_e</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_pix&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_m&#39;</span><span class="p">]):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_m&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">spy_ps_e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_pix&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_m&#39;</span><span class="p">]):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_pix&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">spy_ps_e</span>
        <span class="c1"># Shift</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_e_pix&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_e_m&#39;</span><span class="p">]):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_e_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_e_m&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">spy_ps_e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_e_pix&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_e_m&#39;</span><span class="p">]):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_e_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_e_pix&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">spy_ps_e</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_n_pix&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_n_m&#39;</span><span class="p">]):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_n_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_n_m&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">spy_ps_e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_n_pix&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_n_m&#39;</span><span class="p">]):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_n_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_n_pix&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">spy_ps_e</span>
        <span class="c1"># Alley size</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_e_pix&#39;</span><span class="p">])</span> <span class="ow">and</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_e_m&#39;</span><span class="p">])):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_e_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_e_m&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">spy_ps_e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_e_pix&#39;</span><span class="p">])</span> <span class="ow">and</span>
                  <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_e_m&#39;</span><span class="p">])):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_e_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_e_pix&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">spy_ps_e</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_n_pix&#39;</span><span class="p">])</span> <span class="ow">and</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_n_m&#39;</span><span class="p">])):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_n_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_n_m&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">spy_ps_n</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_n_pix&#39;</span><span class="p">])</span> <span class="ow">and</span>
                  <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_n_m&#39;</span><span class="p">])):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_n_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_n_pix&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">spy_ps_n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crop_specs</span> <span class="o">=</span> <span class="n">cs</span>
        <span class="k">return</span> <span class="n">cs</span>

    <span class="k">def</span> <span class="nf">_composite_band_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">):</span>
         <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">         &#39;&#39;&#39;</span>
         <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
             <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
             <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                     <span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
             <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                     <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
         <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">()</span>
         <span class="k">return</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_print</span><span class="p">,</span> <span class="n">name_append</span>

    <span class="k">def</span> <span class="nf">_band_math_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">name_append</span><span class="p">,</span>
                         <span class="n">method</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;``method`` must be one of either &quot;ndi&quot;, &quot;ratio&quot;, &quot;derivative&quot;, &#39;</span>
               <span class="s1">&#39;or &quot;mcari2&quot;.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ndi&#39;</span><span class="p">,</span> <span class="s1">&#39;ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;derivative&#39;</span><span class="p">,</span> <span class="s1">&#39;mcari2&#39;</span><span class="p">],</span> <span class="n">msg</span>

        <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                    <span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                    <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
        <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_print</span><span class="p">,</span> <span class="n">name_append</span>

        <span class="c1"># if method == &#39;ndi&#39;:</span>
        <span class="c1">#     print(&#39;Calculating normalized difference index for: {0}&#39;</span>
        <span class="c1">#           &#39;&#39;.format(name_print))</span>
        <span class="c1"># elif method == &#39;ratio&#39;:</span>
        <span class="c1">#     print(&#39;Calculating simple ratio index for: {0}&#39;</span>
        <span class="c1">#           &#39;&#39;.format(name_print))</span>
        <span class="c1"># elif method == &#39;mcari2&#39;:</span>
        <span class="c1">#     print(&#39;Calculating MCARI2 index for: {0}&#39;</span>
        <span class="c1">#           &#39;&#39;.format(name_print))</span>


    <span class="k">def</span> <span class="nf">_mask_stats_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_thresh</span><span class="p">,</span> <span class="n">mask_percentile</span><span class="p">,</span> <span class="n">mask_side</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Parse thesholds and percentiles to dynamically set column names for</span>
<span class="sd">        masked df_stats</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">mask_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask_thresh</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">mask_thresh</span> <span class="o">=</span> <span class="p">[</span><span class="n">mask_thresh</span><span class="p">]</span>
            <span class="n">mask_thresh_print</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mask_thresh</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">mask_percentile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask_percentile</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">mask_percentile</span> <span class="o">=</span> <span class="p">[</span><span class="n">mask_percentile</span><span class="p">]</span>
            <span class="n">mask_pctl_print</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mask_percentile</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">mask_side</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask_side</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">mask_side</span> <span class="o">=</span> <span class="p">[</span><span class="n">mask_side</span><span class="p">]</span>
            <span class="n">mask_side_print</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mask_side</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">mask_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mask_percentile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">type_mask</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;mask-</span><span class="si">{0}</span><span class="s1">-thresh-</span><span class="si">{1}</span><span class="s1">-pctl-</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">mask_side_print</span><span class="p">,</span> <span class="n">mask_thresh_print</span><span class="p">,</span> <span class="n">mask_pctl_print</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">mask_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mask_percentile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">type_mask</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;mask-</span><span class="si">{0}</span><span class="s1">-thresh-</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">mask_side_print</span><span class="p">,</span> <span class="n">mask_thresh_print</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">mask_thresh</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mask_percentile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">type_mask</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;mask-</span><span class="si">{0}</span><span class="s1">-pctl-</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">mask_side_print</span><span class="p">,</span> <span class="n">mask_pctl_print</span><span class="p">))</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">,</span> <span class="s1">&#39;plot_id&#39;</span><span class="p">,</span> <span class="n">type_mask</span> <span class="o">+</span> <span class="s1">&#39;-count&#39;</span><span class="p">,</span>
                   <span class="n">type_mask</span> <span class="o">+</span> <span class="s1">&#39;-mean&#39;</span><span class="p">,</span> <span class="n">type_mask</span> <span class="o">+</span> <span class="s1">&#39;-stdev&#39;</span><span class="p">,</span>
                   <span class="n">type_mask</span> <span class="o">+</span> <span class="s1">&#39;-median&#39;</span><span class="p">]</span>
        <span class="n">df_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_stats</span><span class="p">,</span> <span class="n">type_mask</span>

    <span class="k">def</span> <span class="nf">_mask_single_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">array_bm</span><span class="p">,</span> <span class="n">metadata_bm</span><span class="p">,</span>
                           <span class="n">mask_thresh</span><span class="p">,</span> <span class="n">mask_percentile</span><span class="p">,</span> <span class="n">mask_side</span><span class="p">,</span> <span class="n">df_stats</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Creates the bandmath mask and summarizes the band math values after</span>
<span class="sd">        masking unwanted pixels. Returns the single masked bandmath array and</span>
<span class="sd">        the stats dataframe with the new image data appended as a row</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">array_mask</span><span class="p">,</span> <span class="n">metadata_bm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">mask_array</span><span class="p">(</span>
                <span class="n">array_bm</span><span class="p">,</span> <span class="n">metadata_bm</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="n">mask_thresh</span><span class="p">,</span>
                <span class="n">percentile</span><span class="o">=</span><span class="n">mask_percentile</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="n">mask_side</span><span class="p">)</span>
        <span class="c1"># array_mask, metadata_bm = hsbatch.io.tools.mask_array(</span>
        <span class="c1">#         array_bandmath1, metadata_bandmath1, thresh=mask_thresh,</span>
        <span class="c1">#         percentile=mask_percentile, side=mask_side)</span>

        <span class="c1"># stat_mask_count = np.count_nonzero(~np.isnan(array_mask))</span>
        <span class="c1"># all nan values should be masked from mask_array() function</span>
        <span class="n">stat_mask_count</span> <span class="o">=</span> <span class="n">array_mask</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">stat_mask_mean</span> <span class="o">=</span> <span class="n">array_mask</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">stat_mask_std</span> <span class="o">=</span> <span class="n">array_mask</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">stat_mask_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">array_mask</span><span class="p">)</span>
        <span class="c1"># stat_mask_mean = np.nanmean(array_mask)</span>
        <span class="c1"># stat_mask_std = np.nanstd(array_mask)</span>
        <span class="c1"># stat_mask_med = np.nanmedian(array_mask)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">name_plot</span><span class="p">,</span> <span class="n">stat_mask_count</span><span class="p">,</span> <span class="n">stat_mask_mean</span><span class="p">,</span>
                <span class="n">stat_mask_std</span><span class="p">,</span> <span class="n">stat_mask_med</span><span class="p">]</span>
        <span class="n">df_stats_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_stats</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">df_stats</span> <span class="o">=</span> <span class="n">df_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_stats_temp</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">array_mask</span><span class="p">,</span> <span class="n">df_stats</span>


    <span class="k">def</span> <span class="nf">_mask_two_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_dir</span><span class="p">,</span> <span class="n">mask_side</span><span class="p">,</span> <span class="n">mask_thresh</span><span class="p">,</span>
                       <span class="n">mask_percentile</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">df_stats1</span><span class="p">,</span> <span class="n">df_stats2</span><span class="p">,</span>
                       <span class="n">name_label</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Performs a two-step masking process. The masked masked</span>
<span class="sd">        bandmath arrays and stats for each step are returned.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">msg1</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Either ``mask_thresh`` or ``mask_percentile`` is a &#39;</span>
                <span class="s1">&#39;list, but ``mask_dir`` is not a list. If trying to &#39;</span>
                <span class="s1">&#39;perform a &quot;two-step&quot; masking process, please be sure &#39;</span>
                <span class="s1">&#39;to pass a list with length of two for both &#39;</span>
                <span class="s1">&#39;``mask_dir`` and ``mask_side``, as well as either &#39;</span>
                <span class="s1">&#39;for ``mask_thresh`` or ``mask_percentile``.</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;``mask_dir``: </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">``mask_side``: </span><span class="si">{1}</span><span class="s1">&#39;</span>
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">,</span> <span class="n">mask_side</span><span class="p">))</span>
        <span class="n">msg2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Either ``mask_thresh`` or ``mask_percentile`` is a &#39;</span>
                <span class="s1">&#39;list, but ``mask_side`` is not a list. If trying to &#39;</span>
                <span class="s1">&#39;perform a &quot;two-step&quot; masking process, please be sure &#39;</span>
                <span class="s1">&#39;to pass a list with length of two for both &#39;</span>
                <span class="s1">&#39;``mask_dir`` and ``mask_side``, as well as either &#39;</span>
                <span class="s1">&#39;for ``mask_thresh`` or ``mask_percentile``.</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;``mask_dir``: </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">``mask_side``: </span><span class="si">{1}</span><span class="s1">&#39;</span>
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">,</span> <span class="n">mask_side</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="n">msg1</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask_side</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="n">msg2</span>

        <span class="n">array_bandmath1</span><span class="p">,</span> <span class="n">metadata_bandmath1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_array_similar</span><span class="p">(</span>
                <span class="n">mask_dir</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">array_bandmath2</span><span class="p">,</span> <span class="n">metadata_bandmath2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_array_similar</span><span class="p">(</span>
                <span class="n">mask_dir</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask_thresh</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">array_mask1</span><span class="p">,</span> <span class="n">df_stats1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_single_stats</span><span class="p">(</span>
                <span class="n">fname</span><span class="p">,</span> <span class="n">array_bandmath1</span><span class="p">,</span> <span class="n">metadata_bandmath1</span><span class="p">,</span>
                <span class="n">mask_thresh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mask_side</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">df_stats1</span><span class="p">)</span>
            <span class="n">array_mask2</span><span class="p">,</span> <span class="n">df_stats2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_single_stats</span><span class="p">(</span>
                <span class="n">fname</span><span class="p">,</span> <span class="n">array_bandmath2</span><span class="p">,</span> <span class="n">metadata_bandmath2</span><span class="p">,</span>
                <span class="n">mask_thresh</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mask_side</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">df_stats2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask_percentile</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">array_mask1</span><span class="p">,</span> <span class="n">df_stats1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_single_stats</span><span class="p">(</span>
                <span class="n">fname</span><span class="p">,</span> <span class="n">array_bandmath1</span><span class="p">,</span> <span class="n">metadata_bandmath1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">mask_percentile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mask_side</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">df_stats1</span><span class="p">)</span>
            <span class="n">array_mask2</span><span class="p">,</span> <span class="n">df_stats2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_single_stats</span><span class="p">(</span>
                <span class="n">fname</span><span class="p">,</span> <span class="n">array_bandmath2</span><span class="p">,</span> <span class="n">metadata_bandmath2</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">mask_percentile</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mask_side</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">df_stats2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">array_mask1</span><span class="p">,</span> <span class="n">array_mask2</span><span class="p">,</span> <span class="n">df_stats1</span><span class="p">,</span> <span class="n">df_stats2</span>

    <span class="k">def</span> <span class="nf">_execute_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">,</span> <span class="n">mask_dir</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                      <span class="n">name_append</span><span class="p">,</span> <span class="n">write_datacube</span><span class="p">,</span> <span class="n">write_spec</span><span class="p">,</span> <span class="n">write_geotiff</span><span class="p">,</span>
                      <span class="n">mask_thresh</span><span class="p">,</span> <span class="n">mask_percentile</span><span class="p">,</span> <span class="n">mask_side</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Actually creates the mask to keep the main function a bit cleaner</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">mask_side</span> <span class="o">==</span> <span class="s1">&#39;outside&#39;</span><span class="p">:</span>  <span class="c1"># thresh/pctl will be a list, so take care of this first</span>
            <span class="n">df_stats1</span><span class="p">,</span> <span class="n">type_mask1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_stats_setup</span><span class="p">(</span>
                <span class="n">mask_thresh</span><span class="p">,</span> <span class="n">mask_percentile</span><span class="p">,</span> <span class="n">mask_side</span><span class="p">)</span>
            <span class="n">df_stats2</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">type_mask2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># if mask_side is not &quot;outside&quot; and thresh is list, then it&#39;s a 2-step</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask_thresh</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask_side</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">maskside</span> <span class="o">=</span> <span class="p">[</span><span class="n">mask_side</span><span class="p">,</span> <span class="n">mask_side</span><span class="p">]</span>  <span class="c1"># ensure that mask_side is two parts as well</span>
            <span class="n">df_stats1</span><span class="p">,</span> <span class="n">type_mask1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_stats_setup</span><span class="p">(</span><span class="n">mask_thresh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mask_side</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">df_stats2</span><span class="p">,</span> <span class="n">type_mask2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_stats_setup</span><span class="p">(</span><span class="n">mask_thresh</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mask_side</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask_percentile</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask_side</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">maskside</span> <span class="o">=</span> <span class="p">[</span><span class="n">mask_side</span><span class="p">,</span> <span class="n">mask_side</span><span class="p">]</span>  <span class="c1"># ensure that mask_side is two parts as well</span>
            <span class="n">df_stats1</span><span class="p">,</span> <span class="n">type_mask1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_stats_setup</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask_percentile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mask_side</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">df_stats2</span><span class="p">,</span> <span class="n">type_mask2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_stats_setup</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask_percentile</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mask_side</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_stats1</span><span class="p">,</span> <span class="n">type_mask1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_stats_setup</span><span class="p">(</span><span class="n">mask_thresh</span><span class="p">,</span> <span class="n">mask_percentile</span><span class="p">,</span> <span class="n">mask_side</span><span class="p">)</span>
            <span class="n">df_stats2</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">type_mask2</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">fname_list_p</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">fname_list</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fname_list_p</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">fname_list_p</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s1">&#39;Processing file </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">metadata_geotiff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">()</span>
            <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_exists_check</span><span class="p">(</span>
                    <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">write_datacube</span><span class="o">=</span><span class="n">write_datacube</span><span class="p">,</span>
                    <span class="n">write_spec</span><span class="o">=</span><span class="n">write_spec</span><span class="p">,</span> <span class="n">write_geotiff</span><span class="o">=</span><span class="n">write_geotiff</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># array = self.io.spyfile.load()</span>
            <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="o">.</span><span class="n">open_memmap</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">mask_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mask_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;band_math&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">df_stats2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">array_mask1</span><span class="p">,</span> <span class="n">array_mask2</span><span class="p">,</span> <span class="n">df_stats1</span><span class="p">,</span> <span class="n">df_stats2</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">_mask_two_step</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">,</span> <span class="n">mask_side</span><span class="p">,</span> <span class="n">mask_thresh</span><span class="p">,</span>
                                        <span class="n">mask_percentile</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">df_stats1</span><span class="p">,</span>
                                        <span class="n">df_stats2</span><span class="p">,</span> <span class="n">name_label</span><span class="p">)</span>
                <span class="n">array_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">array_mask1</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span>
                                           <span class="n">array_mask2</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># things are much simpler</span>
                <span class="n">array_bandmath1</span><span class="p">,</span> <span class="n">metadata_bandmath1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_array_similar</span><span class="p">(</span>
                        <span class="n">mask_dir</span><span class="p">)</span>
                <span class="n">array_mask</span><span class="p">,</span> <span class="n">df_stats1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_single_stats</span><span class="p">(</span>
                    <span class="n">fname</span><span class="p">,</span> <span class="n">array_bandmath1</span><span class="p">,</span> <span class="n">metadata_bandmath1</span><span class="p">,</span> <span class="n">mask_thresh</span><span class="p">,</span>
                    <span class="n">mask_percentile</span><span class="p">,</span> <span class="n">mask_side</span><span class="p">,</span> <span class="n">df_stats1</span><span class="p">)</span>
                <span class="n">array_mask</span> <span class="o">=</span> <span class="n">array_mask</span><span class="o">.</span><span class="n">mask</span>

            <span class="n">spec_mean</span><span class="p">,</span> <span class="n">spec_std</span><span class="p">,</span> <span class="n">datacube_masked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">mean_datacube</span><span class="p">(</span>
                    <span class="n">array</span><span class="p">,</span> <span class="n">array_mask</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spec_mean</span> <span class="o">=</span> <span class="n">spec_mean</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spec_std</span> <span class="o">=</span> <span class="n">spec_std</span>
            <span class="n">hist_str</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot; -&gt; hs_process.batch.segment_create_mask[&lt;&quot;</span>
                        <span class="s2">&quot;label: &#39;mask_thresh?&#39; value:</span><span class="si">{0}</span><span class="s2">; &quot;</span>
                        <span class="s2">&quot;label: &#39;mask_percentile?&#39; value:</span><span class="si">{1}</span><span class="s2">; &quot;</span>
                        <span class="s2">&quot;label: &#39;mask_side?&#39; value:</span><span class="si">{2}</span><span class="s2">&gt;]&quot;</span>
                        <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mask_thresh</span><span class="p">,</span> <span class="n">mask_percentile</span><span class="p">,</span> <span class="n">mask_side</span><span class="p">))</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">hist_str</span>
            <span class="n">metadata_geotiff</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">hist_str</span>

            <span class="k">if</span> <span class="n">write_datacube</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_datacube</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">datacube_masked</span><span class="p">,</span>
                                     <span class="n">metadata</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">write_spec</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">name_label_spec</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name_label</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                                   <span class="s1">&#39;-mean.spec&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_spec</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label_spec</span><span class="p">,</span> <span class="n">spec_mean</span><span class="p">,</span> <span class="n">spec_std</span><span class="p">,</span>
                                 <span class="n">metadata</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">array_mask</span> <span class="o">=</span> <span class="n">array_mask</span>
            <span class="k">if</span> <span class="n">write_geotiff</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_geotiff</span><span class="p">(</span><span class="n">array_mask</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span>
                                    <span class="n">metadata_geotiff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_stats1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fname_stats1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">type_mask1</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
            <span class="n">df_stats1</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname_stats1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df_stats2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_stats2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># fname_csv2 = &#39;mask-stats2.csv&#39;</span>
                <span class="n">fname_stats2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">type_mask2</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
                <span class="n">df_stats2</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname_stats2</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1">#            # should we make an option to save a mean spectra as well?</span>
<span class="c1">#            # Yes - we aren&#39;t required to save intermediate results and do</span>
<span class="c1">#            # another batch process..? we get everything done in one shot -</span>
<span class="c1">#            # after all, why do we want to do band math if we aren&#39;t also</span>
<span class="c1">#            # calculating the average of the area (unless cropping hasn&#39;t</span>
<span class="c1">#            # been perfomed yet)?</span>
<span class="c1">#            # No - Keep it simpler and keep batch functions more specific in</span>
<span class="c1">#            # their capabilities (e.g., batch.band_math, batch.mask_array,</span>
<span class="c1">#            # batch.veg_spectra)</span>
<span class="c1">#</span>
    <span class="k">def</span> <span class="nf">_write_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">df_stats</span><span class="p">,</span> <span class="n">fname_csv</span><span class="o">=</span><span class="s1">&#39;stats.csv&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Writes df_stats to &lt;dir_out&gt;, ensuring lock is in place if it exists to</span>
<span class="sd">        work as expected with parallel processing.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">fname_stats</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">fname_csv</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname_stats</span><span class="p">):</span>
                    <span class="n">df_stats_in</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_stats</span><span class="p">)</span>
                    <span class="n">df_stats</span> <span class="o">=</span> <span class="n">df_stats_in</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_stats</span><span class="p">)</span>
                <span class="n">df_stats</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname_stats</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname_stats</span><span class="p">):</span>
                <span class="n">df_stats_in</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_stats</span><span class="p">)</span>
                <span class="n">df_stats</span> <span class="o">=</span> <span class="n">df_stats_in</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_stats</span><span class="p">)</span>
            <span class="n">df_stats</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname_stats</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_composite_band</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                                <span class="n">name_append</span><span class="p">,</span> <span class="n">write_geotiff</span><span class="p">,</span> <span class="n">wl1</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span>
                                <span class="n">list_range</span><span class="p">,</span> <span class="n">plot_out</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Actually executes the composit band to keep the main function a bit</span>
<span class="sd">        cleaner</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">type_bm</span> <span class="o">=</span> <span class="s1">&#39;-comp-</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)))</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">,</span> <span class="s1">&#39;plot_id&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std_dev&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;pctl_10th&#39;</span><span class="p">,</span> <span class="s1">&#39;pctl_25th&#39;</span><span class="p">,</span> <span class="s1">&#39;pctl_50th&#39;</span><span class="p">,</span> <span class="s1">&#39;pctl_75th&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;pctl_90th&#39;</span><span class="p">,</span> <span class="s1">&#39;pctl_95th&#39;</span><span class="p">]</span>
        <span class="n">df_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>

        <span class="n">fname_list_p</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">fname_list</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fname_list_p</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">fname_list_p</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s1">&#39;Processing file </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_print</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composite_band_setup</span><span class="p">(</span>
                    <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span> <span class="o">=</span> <span class="n">segment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="p">)</span>
            <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="n">type_bm</span> <span class="o">+</span> <span class="s1">&#39;.</span><span class="si">{0}</span><span class="s1">&#39;</span>
                          <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_exists_check</span><span class="p">(</span>
                    <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">write_datacube</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">write_geotiff</span><span class="o">=</span><span class="n">write_geotiff</span><span class="p">,</span> <span class="n">write_plot</span><span class="o">=</span><span class="n">plot_out</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">array_b1</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span><span class="o">.</span><span class="n">composite_band</span><span class="p">(</span>
                <span class="n">wl1</span><span class="o">=</span><span class="n">wl1</span><span class="p">,</span> <span class="n">b1</span><span class="o">=</span><span class="n">b1</span><span class="p">,</span> <span class="n">list_range</span><span class="o">=</span><span class="n">list_range</span><span class="p">,</span> <span class="n">print_out</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">stat_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">array_b1</span><span class="p">))</span>
            <span class="n">stat_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">array_b1</span><span class="p">)</span>
            <span class="n">stat_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">array_b1</span><span class="p">)</span>
            <span class="n">stat_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">array_b1</span><span class="p">)</span>
            <span class="n">stat_pctls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">array_b1</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">95</span><span class="p">])</span>

            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">name_plot</span><span class="p">,</span> <span class="n">stat_count</span><span class="p">,</span> <span class="n">stat_mean</span><span class="p">,</span> <span class="n">stat_std</span><span class="p">,</span>
                    <span class="n">stat_med</span><span class="p">,</span> <span class="n">stat_pctls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stat_pctls</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stat_pctls</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">stat_pctls</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">stat_pctls</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">stat_pctls</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
            <span class="n">df_stats_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">df_stats</span> <span class="o">=</span> <span class="n">df_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_stats_temp</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">plot_out</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">fname_fig</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span>
                                         <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name_label</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                                         <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">plot_histogram</span><span class="p">(</span>
                        <span class="n">array_b1</span><span class="p">,</span> <span class="n">fname_fig</span><span class="o">=</span><span class="n">fname_fig</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">name_print</span><span class="p">,</span>
                        <span class="n">xlabel</span><span class="o">=</span><span class="n">array_b1</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">percentile</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                        <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#444444&#39;</span><span class="p">)</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_label</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_write_datacube</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">array_b1</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">write_geotiff</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_geotiff</span><span class="p">(</span><span class="n">array_b1</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span>
                                    <span class="n">metadata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span><span class="o">.</span><span class="n">tools</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_stats</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_stats</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">df_stats</span><span class="p">,</span> <span class="n">fname_csv</span><span class="o">=</span><span class="n">name_append</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="s1">&#39;-stats.csv&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_band_math</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                           <span class="n">name_append</span><span class="p">,</span> <span class="n">write_geotiff</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">wl1</span><span class="p">,</span> <span class="n">wl2</span><span class="p">,</span> <span class="n">wl3</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span>
                           <span class="n">b3</span><span class="p">,</span> <span class="n">list_range</span><span class="p">,</span> <span class="n">plot_out</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Actually executes the band math to keep the main function a bit</span>
<span class="sd">        cleaner</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ndi&#39;</span> <span class="ow">or</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ratio&#39;</span><span class="p">:</span>
            <span class="n">type_bm</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">))))</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;derivative&#39;</span><span class="p">:</span>
            <span class="n">type_bm</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">-</span><span class="si">{3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                                <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">)),</span>
                                                <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">))))</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mcari2&#39;</span><span class="p">:</span>
            <span class="n">type_bm</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">-</span><span class="si">{3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                                <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">)),</span>
                                                <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">))))</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">,</span> <span class="s1">&#39;plot_id&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std_dev&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;pctl_10th&#39;</span><span class="p">,</span> <span class="s1">&#39;pctl_25th&#39;</span><span class="p">,</span> <span class="s1">&#39;pctl_50th&#39;</span><span class="p">,</span> <span class="s1">&#39;pctl_75th&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;pctl_90th&#39;</span><span class="p">,</span> <span class="s1">&#39;pctl_95th&#39;</span><span class="p">]</span>
        <span class="n">df_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>

        <span class="n">fname_list_p</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">fname_list</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fname_list_p</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">fname_list_p</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s1">&#39;Processing file </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_print</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_math_setup</span><span class="p">(</span>
                    <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">name_append</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span> <span class="o">=</span> <span class="n">segment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ndi&#39;</span><span class="p">:</span>
                <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;-</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">.</span><span class="si">{3}</span><span class="s1">&#39;</span>
                              <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">)),</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_exists_check</span><span class="p">(</span>
                        <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">write_datacube</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">write_geotiff</span><span class="o">=</span><span class="n">write_geotiff</span><span class="p">,</span>
                        <span class="n">write_plot</span><span class="o">=</span><span class="n">plot_out</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">array_bm</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span><span class="o">.</span><span class="n">band_math_ndi</span><span class="p">(</span>
                        <span class="n">wl1</span><span class="o">=</span><span class="n">wl1</span><span class="p">,</span> <span class="n">wl2</span><span class="o">=</span><span class="n">wl2</span><span class="p">,</span> <span class="n">b1</span><span class="o">=</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="o">=</span><span class="n">b2</span><span class="p">,</span> <span class="n">list_range</span><span class="o">=</span><span class="n">list_range</span><span class="p">,</span>
                        <span class="n">print_out</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ratio&#39;</span><span class="p">:</span>
                <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;-</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">.</span><span class="si">{3}</span><span class="s1">&#39;</span>
                              <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">)),</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_exists_check</span><span class="p">(</span>
                        <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">write_datacube</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">write_geotiff</span><span class="o">=</span><span class="n">write_geotiff</span><span class="p">,</span>
                        <span class="n">write_plot</span><span class="o">=</span><span class="n">plot_out</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">array_bm</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span><span class="o">.</span><span class="n">band_math_ratio</span><span class="p">(</span>
                        <span class="n">wl1</span><span class="o">=</span><span class="n">wl1</span><span class="p">,</span> <span class="n">wl2</span><span class="o">=</span><span class="n">wl2</span><span class="p">,</span> <span class="n">b1</span><span class="o">=</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="o">=</span><span class="n">b2</span><span class="p">,</span> <span class="n">list_range</span><span class="o">=</span><span class="n">list_range</span><span class="p">,</span>
                        <span class="n">print_out</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;derivative&#39;</span><span class="p">:</span>
                <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;-</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">-</span><span class="si">{3}</span><span class="s1">.</span><span class="si">{4}</span><span class="s1">&#39;</span>
                              <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">)),</span>
                                        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl3</span><span class="p">)),</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_exists_check</span><span class="p">(</span>
                        <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">write_datacube</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">write_geotiff</span><span class="o">=</span><span class="n">write_geotiff</span><span class="p">,</span>
                        <span class="n">write_plot</span><span class="o">=</span><span class="n">plot_out</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">array_bm</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span><span class="o">.</span><span class="n">band_math_derivative</span><span class="p">(</span>
                        <span class="n">wl1</span><span class="o">=</span><span class="n">wl1</span><span class="p">,</span> <span class="n">wl2</span><span class="o">=</span><span class="n">wl2</span><span class="p">,</span> <span class="n">wl3</span><span class="o">=</span><span class="n">wl3</span><span class="p">,</span> <span class="n">b1</span><span class="o">=</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="o">=</span><span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="o">=</span><span class="n">b3</span><span class="p">,</span>
                        <span class="n">list_range</span><span class="o">=</span><span class="n">list_range</span><span class="p">,</span> <span class="n">print_out</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mcari2&#39;</span><span class="p">:</span>
                <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;-</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">-</span><span class="si">{3}</span><span class="s1">.</span><span class="si">{4}</span><span class="s1">&#39;</span>
                              <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">)),</span>
                                        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl3</span><span class="p">)),</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_exists_check</span><span class="p">(</span>
                        <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">write_datacube</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">write_geotiff</span><span class="o">=</span><span class="n">write_geotiff</span><span class="p">,</span>
                        <span class="n">write_plot</span><span class="o">=</span><span class="n">plot_out</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">array_bm</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span><span class="o">.</span><span class="n">band_math_mcari2</span><span class="p">(</span>
                        <span class="n">wl1</span><span class="o">=</span><span class="n">wl1</span><span class="p">,</span> <span class="n">wl2</span><span class="o">=</span><span class="n">wl2</span><span class="p">,</span> <span class="n">wl3</span><span class="o">=</span><span class="n">wl3</span><span class="p">,</span> <span class="n">b1</span><span class="o">=</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="o">=</span><span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="o">=</span><span class="n">b3</span><span class="p">,</span>
                        <span class="n">list_range</span><span class="o">=</span><span class="n">list_range</span><span class="p">,</span> <span class="n">print_out</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">stat_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">array_bm</span><span class="p">))</span>
            <span class="n">stat_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">array_bm</span><span class="p">)</span>
            <span class="n">stat_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">array_bm</span><span class="p">)</span>
            <span class="n">stat_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">array_bm</span><span class="p">)</span>
            <span class="n">stat_pctls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">array_bm</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">95</span><span class="p">])</span>

            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">name_plot</span><span class="p">,</span> <span class="n">stat_count</span><span class="p">,</span> <span class="n">stat_mean</span><span class="p">,</span> <span class="n">stat_std</span><span class="p">,</span>
                    <span class="n">stat_med</span><span class="p">,</span> <span class="n">stat_pctls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stat_pctls</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stat_pctls</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">stat_pctls</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">stat_pctls</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">stat_pctls</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
            <span class="n">df_stats_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">df_stats</span> <span class="o">=</span> <span class="n">df_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_stats_temp</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">plot_out</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">fname_fig</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span>
                                         <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name_label</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                                         <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">plot_histogram</span><span class="p">(</span>
                        <span class="n">array_bm</span><span class="p">,</span> <span class="n">fname_fig</span><span class="o">=</span><span class="n">fname_fig</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">name_print</span><span class="p">,</span>
                        <span class="n">xlabel</span><span class="o">=</span><span class="n">type_bm</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">percentile</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                        <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#444444&#39;</span><span class="p">)</span>

            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_label</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_write_datacube</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">array_bm</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">write_geotiff</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_geotiff</span><span class="p">(</span><span class="n">array_bm</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span>
                                    <span class="n">metadata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span><span class="o">.</span><span class="n">tools</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_stats</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_stats</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">df_stats</span><span class="p">,</span> <span class="n">fname_csv</span><span class="o">=</span><span class="n">name_append</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="s1">&#39;-stats.csv&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_get_ndvi_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_class_spec</span><span class="p">,</span> <span class="n">n_classes</span><span class="p">,</span> <span class="n">plot_out</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find kmeans class with lowest NDVI, which represents the soil class</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">nir_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">get_band</span><span class="p">(</span><span class="mi">760</span><span class="p">)</span>
        <span class="n">re_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">get_band</span><span class="p">(</span><span class="mi">715</span><span class="p">)</span>
        <span class="n">red_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">get_band</span><span class="p">(</span><span class="mi">681</span><span class="p">)</span>
        <span class="n">green_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">get_band</span><span class="p">(</span><span class="mi">555</span><span class="p">)</span>

        <span class="n">nir</span> <span class="o">=</span> <span class="n">df_class_spec</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">nir_b</span><span class="p">]</span>
        <span class="n">re</span> <span class="o">=</span> <span class="n">df_class_spec</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">re_b</span><span class="p">]</span>
        <span class="n">red</span> <span class="o">=</span> <span class="n">df_class_spec</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">red_b</span><span class="p">]</span>
        <span class="n">green</span> <span class="o">=</span> <span class="n">df_class_spec</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">green_b</span><span class="p">]</span>

        <span class="n">df_ndvi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nir</span><span class="o">-</span><span class="n">red</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nir</span><span class="o">+</span><span class="n">red</span><span class="p">)</span>
        <span class="n">class_soil</span> <span class="o">=</span> <span class="n">df_ndvi</span><span class="p">[</span><span class="n">df_ndvi</span> <span class="o">==</span> <span class="n">df_ndvi</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">class_veg</span> <span class="o">=</span> <span class="n">df_ndvi</span><span class="p">[</span><span class="n">df_ndvi</span> <span class="o">==</span> <span class="n">df_ndvi</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">plot_out</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">df_class_spec</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">meta_bands</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_class_spec</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">legend</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;K-means classes&#39;</span><span class="p">)</span>
            <span class="n">legend</span><span class="o">.</span><span class="n">texts</span><span class="p">[</span><span class="n">class_soil</span><span class="p">]</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;Soil&#39;</span><span class="p">)</span>
            <span class="n">legend</span><span class="o">.</span><span class="n">texts</span><span class="p">[</span><span class="n">class_veg</span><span class="p">]</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;Vegetation&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">class_soil</span><span class="p">,</span> <span class="n">class_veg</span>

    <span class="k">def</span> <span class="nf">_crop_check_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_sheet</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks that either `fname_sheet` or `fname_list` were passed (and not</span>
<span class="sd">        both)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">fname_sheet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fname_sheet</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">fname_list</span><span class="p">):</span>
                <span class="n">df_plots</span> <span class="o">=</span> <span class="n">fname_sheet</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname_sheet</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.csv&#39;</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">fname_list</span><span class="p">):</span>
                <span class="n">df_plots</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_sheet</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Both ``fname_sheet`` and ``fname_list`` were passed. &#39;</span>
                        <span class="s1">&#39;``fname_list`` (perhaps from ``base_dir``) will be &#39;</span>
                        <span class="s1">&#39;ignored.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg2</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fname_sheet</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                    <span class="n">df_plots</span> <span class="o">=</span> <span class="n">fname_sheet</span>
                <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname_sheet</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.csv&#39;</span><span class="p">:</span>
                    <span class="n">df_plots</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_sheet</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df_plots</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">fname_sheet</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)):</span>
            <span class="n">msg1</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Neither ``fname_sheet`` nor ``fname_list`` were passed. &#39;</span>
                    <span class="s1">&#39;Please pass one or the other (not both) and run &#39;</span>
                    <span class="s1">&#39;``batch.spatial_crop`` again.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># fname_list was passed and df_plots will be figured out later</span>
            <span class="n">msg3</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;``method`` is &quot;single&quot;, but ``fname_list`` was passed &#39;</span>
                    <span class="s1">&#39;instead of ``fname_sheet``.</span><span class="se">\n\n</span><span class="s1">If performing &#39;</span>
                    <span class="s1">&#39;``crop_single``, please pass ``fname_sheet``.</span><span class="se">\n\n</span><span class="s1">If &#39;</span>
                    <span class="s1">&#39;performing ``crop_many_gdf``, please pass ``fname_list`` &#39;</span>
                    <span class="s1">&#39;(perhaps via ``base_dir``).</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;many_grid&#39;</span><span class="p">,</span> <span class="s1">&#39;many_gdf&#39;</span><span class="p">],</span> <span class="n">msg3</span>
            <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_file_exists_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span>
                           <span class="n">write_datacube</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">write_spec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">write_geotiff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">write_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks if all files to be created exist already; if so, returns True;</span>
<span class="sd">        if not, returns False.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">force</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">write_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;write_datacube&#39;</span><span class="p">:</span> <span class="n">write_datacube</span><span class="p">,</span>
                      <span class="s1">&#39;write_spec&#39;</span><span class="p">:</span> <span class="n">write_spec</span><span class="p">,</span>
                      <span class="s1">&#39;write_geotiff&#39;</span><span class="p">:</span> <span class="n">write_geotiff</span><span class="p">,</span>
                      <span class="s1">&#39;write_plot&#39;</span><span class="p">:</span> <span class="n">write_plot</span><span class="p">}</span>
        <span class="n">ext_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;write_datacube&#39;</span><span class="p">:</span> <span class="s1">&#39;.bip&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;write_spec&#39;</span><span class="p">:</span> <span class="s1">&#39;-mean.spec&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;write_geotiff&#39;</span><span class="p">:</span> <span class="s1">&#39;.tif&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;write_plot&#39;</span><span class="p">:</span> <span class="s1">&#39;.png&#39;</span><span class="p">}</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Skipping file - it appears as if this image has already &#39;</span>
               <span class="s1">&#39;been processed. Overwrite files by passing out_force=True</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="s1">&#39;Filename (short): </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_label</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">write_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">write_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ext_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>  <span class="c1"># if we need the file and it doesn&#39;t exist, we&#39;re done checking</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># if we get here without already exiting, all files should exist</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_crop_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_plots</span><span class="p">,</span> <span class="n">gdf</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                   <span class="n">name_append</span><span class="p">,</span> <span class="n">write_geotiff</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        ``df_plots`` is assumed to contain all the necessary information to</span>
<span class="sd">        crop *each plot* from an image or from multiple images. In other words,</span>
<span class="sd">        _crop_loop() will perform a single cropping procedure (via</span>
<span class="sd">        ``spatial_mod.crop_single()``) for each row in ``df_plots``. Thus,</span>
<span class="sd">        all the necessary information should be contained in df_plots to run</span>
<span class="sd">        crop_single(). This function is not meant for dataframes containing</span>
<span class="sd">        information to perform crop_many(), so be sure to hone in on that</span>
<span class="sd">        information before passing ``_crop_loop``.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">df_iter</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">df_plots</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">total</span><span class="o">=</span><span class="n">df_plots</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">df_plots</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_iter</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">df_iter</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s1">&#39;Processing file </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_plots</span><span class="p">)))</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crop_read_sheet</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;directory&#39;</span><span class="p">],</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">])</span>
            <span class="c1"># print(&#39;\nSpatially cropping: {0}&#39;.format(fname))</span>
            <span class="n">name_long</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;name_long&#39;</span><span class="p">]</span>  <span class="c1"># ``None`` if it was never set</span>
            <span class="n">plot_id_ref</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;plot_id_ref&#39;</span><span class="p">]</span>
            <span class="n">name_short</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;name_short&#39;</span><span class="p">]</span>
            <span class="n">fname_hdr</span> <span class="o">=</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname_hdr</span><span class="p">,</span> <span class="n">name_long</span><span class="o">=</span><span class="n">name_long</span><span class="p">,</span>
                              <span class="n">name_plot</span><span class="o">=</span><span class="n">plot_id_ref</span><span class="p">,</span> <span class="n">name_short</span><span class="o">=</span><span class="n">name_short</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span> <span class="o">=</span> <span class="n">spatial_mod</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="p">,</span> <span class="n">gdf</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">name_long</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">name_long</span><span class="p">,</span>
                <span class="n">name_short</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">name_short</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span>
            <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;directory&#39;</span><span class="p">],</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">()</span>
            <span class="n">name_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_label</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">name_print</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_exists_check</span><span class="p">(</span>
                    <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">write_datacube</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">write_geotiff</span><span class="o">=</span><span class="n">write_geotiff</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pix_to_mapunit</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">cs</span>
<span class="c1">#            if method == &#39;single&#39;:</span>
            <span class="c1"># print(cs)</span>
            <span class="n">array_crop</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span><span class="o">.</span><span class="n">crop_single</span><span class="p">(</span>
                    <span class="n">pix_e_ul</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;pix_e_ul&#39;</span><span class="p">],</span> <span class="n">pix_n_ul</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;pix_n_ul&#39;</span><span class="p">],</span>
                    <span class="n">crop_e_pix</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_pix&#39;</span><span class="p">],</span> <span class="n">crop_n_pix</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_pix&#39;</span><span class="p">],</span>
                    <span class="n">buf_e_pix</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_pix&#39;</span><span class="p">],</span> <span class="n">buf_n_pix</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_pix&#39;</span><span class="p">],</span>
                    <span class="n">gdf_shft_e_pix</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_e_pix&#39;</span><span class="p">],</span> <span class="n">gdf_shft_n_pix</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_n_pix&#39;</span><span class="p">],</span>
                    <span class="n">plot_id_ref</span><span class="o">=</span><span class="n">plot_id_ref</span><span class="p">,</span> <span class="n">gdf</span><span class="o">=</span><span class="n">gdf</span><span class="p">)</span>

            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;directory&#39;</span><span class="p">],</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_datacube</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">array_crop</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">write_geotiff</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_geotiff</span><span class="p">(</span><span class="n">array_crop</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span>
                                    <span class="n">metadata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span><span class="o">.</span><span class="n">tools</span><span class="p">,</span>
                                    <span class="n">show_img</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_append_cropping_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_plots_many</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Appends all &quot;row&quot; columns to df_plots_many so they carry through</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">])</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_plots_many</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df_plots_many</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">df_plots_many</span>

    <span class="k">def</span> <span class="nf">_crop_many_read_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">gdf</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Helper function for reading a row of a dataframe with information about</span>
<span class="sd">        how to crop an image many times</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crop_read_sheet</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>  <span class="c1"># this function creates cs[&#39;fname&#39;]</span>
        <span class="n">fname_in</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;directory&#39;</span><span class="p">],</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Filename: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname_in</span><span class="p">))</span>
        <span class="n">name_long</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;name_long&#39;</span><span class="p">]</span>  <span class="c1"># ``None`` if it was never set</span>
        <span class="n">plot_id_ref</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;plot_id_ref&#39;</span><span class="p">]</span>
        <span class="n">name_short</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;name_short&#39;</span><span class="p">]</span>
        <span class="n">fname_hdr</span> <span class="o">=</span> <span class="n">fname_in</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname_hdr</span><span class="p">,</span> <span class="n">name_long</span><span class="o">=</span><span class="n">name_long</span><span class="p">,</span>
                          <span class="n">name_plot</span><span class="o">=</span><span class="n">plot_id_ref</span><span class="p">,</span> <span class="n">name_short</span><span class="o">=</span><span class="n">name_short</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span> <span class="o">=</span> <span class="n">spatial_mod</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="p">,</span> <span class="n">gdf</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">name_long</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">name_long</span><span class="p">,</span>
            <span class="n">name_short</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">name_short</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;many_gdf&#39;</span><span class="p">:</span>
            <span class="n">df_plots_many</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_many_gdf</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;many_grid&#39;</span><span class="p">:</span>
            <span class="n">df_plots_many</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_many_grid</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;``method`` must be either &quot;many_gdf&quot; or &quot;many_grid&quot;.</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;Method: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">df_plots_many</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append_cropping_details</span><span class="p">(</span><span class="n">df_plots_many</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_plots_many</span>

    <span class="k">def</span> <span class="nf">_many_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Wrapper to get consice access to ``spatial_mod.crop_many_grid()&#39;&#39;&#39;</span>
        <span class="n">df_plots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span><span class="o">.</span><span class="n">crop_many_grid</span><span class="p">(</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;plot_id_ref&#39;</span><span class="p">],</span> <span class="n">pix_e_ul</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;pix_e_ul&#39;</span><span class="p">],</span> <span class="n">pix_n_ul</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;pix_n_ul&#39;</span><span class="p">],</span>
            <span class="n">crop_e_m</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_m&#39;</span><span class="p">],</span> <span class="n">crop_n_m</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_m&#39;</span><span class="p">],</span>
            <span class="n">alley_size_n_m</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_n_m&#39;</span><span class="p">],</span> <span class="n">buf_e_m</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_m&#39;</span><span class="p">],</span>
            <span class="n">buf_n_m</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_m&#39;</span><span class="p">],</span> <span class="n">n_plots_x</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;n_plots_x&#39;</span><span class="p">],</span>
            <span class="n">n_plots_y</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;n_plots_y&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df_plots</span>

    <span class="k">def</span> <span class="nf">_many_gdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Wrapper to get consice access to ``spatial_mod.crop_many_gdf();</span>
<span class="sd">        ``my_spatial_mod`` already has access to ``spyfile`` and ``gdf``, so no</span>
<span class="sd">        need to pass them here.</span>

<span class="sd">        If the buffer settings are None, but there are default settings for</span>
<span class="sd">        them, they are passed here</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;plot_id_ref&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;plot_id_ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">crop_defaults</span><span class="o">.</span><span class="n">plot_id_ref</span>
        <span class="n">df_plots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span><span class="o">.</span><span class="n">crop_many_gdf</span><span class="p">(</span>
            <span class="n">plot_id_ref</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;plot_id_ref&#39;</span><span class="p">],</span> <span class="n">pix_e_ul</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;pix_e_ul&#39;</span><span class="p">],</span>
            <span class="n">pix_n_ul</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;pix_n_ul&#39;</span><span class="p">],</span>
            <span class="n">crop_e_m</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_m&#39;</span><span class="p">],</span> <span class="n">crop_n_m</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_m&#39;</span><span class="p">],</span>
            <span class="n">crop_e_pix</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_pix&#39;</span><span class="p">],</span> <span class="n">crop_n_pix</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_pix&#39;</span><span class="p">],</span>
            <span class="n">buf_e_m</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_m&#39;</span><span class="p">],</span> <span class="n">buf_n_m</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_m&#39;</span><span class="p">],</span>
            <span class="n">buf_e_pix</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_pix&#39;</span><span class="p">],</span> <span class="n">buf_n_pix</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_pix&#39;</span><span class="p">],</span>
            <span class="n">gdf_shft_e_m</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_e_m&#39;</span><span class="p">],</span> <span class="n">gdf_shft_n_m</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_n_m&#39;</span><span class="p">],</span>
            <span class="n">gdf_shft_e_pix</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_e_pix&#39;</span><span class="p">],</span>
            <span class="n">gdf_shft_n_pix</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;gdf_shft_n_pix&#39;</span><span class="p">],</span>
            <span class="n">n_plots</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;n_plots&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df_plots</span>

    <span class="k">def</span> <span class="nf">_crop_check_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_plots</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        If file already exists and out_force is False, removes that file from</span>
<span class="sd">        the df_plots</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">df_plots</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_plots_out</span> <span class="o">=</span> <span class="n">df_plots</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_plots</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;directory&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;name_short&#39;</span><span class="p">]</span> <span class="o">+</span>
                                 <span class="n">row</span><span class="p">[</span><span class="s1">&#39;name_long&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ext&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
                <span class="n">df_plots_out</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_plots_out</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_plots_out</span>

    <span class="k">def</span> <span class="nf">_execute_crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_sheet</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                      <span class="n">name_append</span><span class="p">,</span> <span class="n">write_geotiff</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">gdf</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Actually executes the spatial crop to keep the main function a bit</span>
<span class="sd">        cleaner</span>

<span class="sd">        Either `fname_sheet` or `fname_list` should be None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">df_plots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crop_check_input</span><span class="p">(</span><span class="n">fname_sheet</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
        <span class="c1"># if not pd.isnull(df_plots):</span>
        <span class="k">if</span> <span class="n">df_plots</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">df_plots</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;date&#39;</span> <span class="ow">in</span> <span class="n">df_plots</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_plots</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">df_plots</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_plots</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
            <span class="c1"># self._crop_loop(df_plots)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_crop_loop</span><span class="p">(</span><span class="n">df_plots</span><span class="p">,</span> <span class="n">gdf</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                   <span class="n">name_append</span><span class="p">,</span> <span class="n">write_geotiff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;many_gdf&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_plots</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="c1"># if user passes a dataframe, just do whatever it says..</span>
            <span class="c1"># loop through each row, doing crop_many_gdf() on each row with</span>
            <span class="c1"># whatever parameters are passed via the columns..</span>
            <span class="c1"># we should assume that each row of df_plots contains an image that</span>
            <span class="c1"># should have crop_many_gdf performed on it to create a new</span>
            <span class="c1"># dataframe that can be passed to _crop_loop()</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_plots</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Computing information to spatially crop via &#39;</span>
                      <span class="s1">&#39;``spatial_mod.crop_many_gdf``:&#39;</span><span class="p">)</span>
                <span class="n">df_plots_many</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crop_many_read_row</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">gdf</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_plots_many</span> <span class="o">=</span> <span class="n">df_plots_many</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_crop_loop</span><span class="p">(</span><span class="n">df_plots_many</span><span class="p">,</span> <span class="n">gdf</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                                <span class="n">name_append</span><span class="p">,</span> <span class="n">write_geotiff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;many_gdf&#39;</span> <span class="ow">and</span> <span class="n">df_plots</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Because ``fname_list`` was passed instead of &#39;</span>
                  <span class="s1">&#39;``fname_sheet``, there is not a way to infer the study &#39;</span>
                  <span class="s1">&#39;name and date. Therefore, &quot;study&quot; and &quot;date&quot; will be &#39;</span>
                  <span class="s1">&#39;omitted from the output file name. If you would like &#39;</span>
                  <span class="s1">&#39;output file names to include &quot;study&quot; and &quot;date&quot;, please &#39;</span>
                  <span class="s1">&#39;pass ``fname_sheet`` with &quot;study&quot; and &quot;date&quot; columns.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fname_in</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname_in</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span> <span class="o">=</span> <span class="n">spatial_mod</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="p">,</span> <span class="n">gdf</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span>
                    <span class="n">name_long</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">name_long</span><span class="p">,</span>
                    <span class="n">name_short</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">name_short</span><span class="p">)</span>
                <span class="c1"># as long as defaults are set ahead of time, they should carry through</span>
                <span class="c1"># e.g., batch.io.defaults.crop_defaults.n_plots = 40 to limit to 40 plots</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span>
                <span class="n">df_plots_many</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span><span class="o">.</span><span class="n">crop_many_gdf</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_crop_loop</span><span class="p">(</span><span class="n">df_plots_many</span><span class="p">,</span> <span class="n">gdf</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                                <span class="n">name_append</span><span class="p">,</span> <span class="n">write_geotiff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;many_grid&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_plots</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_plots</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Computing information to spatially crop via &#39;</span>
                      <span class="s1">&#39;``spatial_mod.crop_many_grid``:&#39;</span><span class="p">)</span>
                <span class="n">df_plots_many</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crop_many_read_row</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">gdf</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_crop_loop</span><span class="p">(</span><span class="n">df_plots_many</span><span class="p">,</span> <span class="n">gdf</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                                <span class="n">name_append</span><span class="p">,</span> <span class="n">write_geotiff</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Either ``method`` or ``df_plots`` are not defined &#39;</span>
                   <span class="s1">&#39;correctly. If using &quot;many_grid&quot; method, please be sure &#39;</span>
                   <span class="s1">&#39;``df_plots`` is being populated correcty</span><span class="se">\n\n</span><span class="s1">``method``: &#39;</span>
                   <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_datacube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Writes a datacube to file using ``hsio.write_cube()``</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_label</span>
        <span class="n">hdr_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_cube</span><span class="p">(</span><span class="n">hdr_file</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                           <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                           <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                           <span class="n">ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">ext</span><span class="p">,</span>
                           <span class="n">interleave</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">,</span>
                           <span class="n">byteorder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">byteorder</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_geotiff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
                       <span class="n">tools</span><span class="p">,</span> <span class="n">show_img</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_label</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Projection and Geotransform information are required for &#39;</span>
               <span class="s1">&#39;writing the geotiff. This comes from the input filename, &#39;</span>
               <span class="s1">&#39;so please be sure the correct filename is passed to &#39;</span>
               <span class="s1">&#39;``fname``.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">msg</span>
        <span class="n">fname_tif</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span>
                                 <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name_label</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span><span class="p">)</span>
        <span class="n">img_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">_read_envi_gdal</span><span class="p">(</span><span class="n">fname_in</span><span class="o">=</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">projection_out</span> <span class="o">=</span> <span class="n">img_ds</span><span class="o">.</span><span class="n">GetProjection</span><span class="p">()</span>
<span class="c1">#            geotransform_out = img_ds.GetGeotransform()</span>
        <span class="n">img_ds</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># I only want to use GDAL when I have to..</span>

        <span class="n">map_set</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;map info&#39;</span><span class="p">]</span>
        <span class="n">ul_x_utm</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">get_meta_set</span><span class="p">(</span><span class="n">map_set</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">ul_y_utm</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">get_meta_set</span><span class="p">(</span><span class="n">map_set</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">size_x_m</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">get_meta_set</span><span class="p">(</span><span class="n">map_set</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">size_y_m</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">get_meta_set</span><span class="p">(</span><span class="n">map_set</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="c1"># Note the last pixel size must be negative to begin at upper left</span>
        <span class="n">geotransform_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">ul_x_utm</span><span class="p">,</span> <span class="n">size_x_m</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">ul_y_utm</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                            <span class="o">-</span><span class="n">size_y_m</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_tif</span><span class="p">(</span><span class="n">fname_tif</span><span class="p">,</span> <span class="n">spyfile</span><span class="o">=</span><span class="n">array</span><span class="p">,</span>
                          <span class="n">projection_out</span><span class="o">=</span><span class="n">projection_out</span><span class="p">,</span>
                          <span class="n">geotransform_out</span><span class="o">=</span><span class="n">geotransform_out</span><span class="p">,</span>
                          <span class="n">show_img</span><span class="o">=</span><span class="n">show_img</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">spec_mean</span><span class="p">,</span> <span class="n">spec_std</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="p">,</span> <span class="n">folder_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        folder_name added to support an extra level on foler if desired. If</span>
<span class="sd">        left to ``None``, spec will be written to dir_out, but if a str is</span>
<span class="sd">        passed, spec will be written to os.path.join(dir_out, str).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_label</span>
        <span class="k">if</span> <span class="n">folder_name</span><span class="p">:</span>  <span class="c1"># else just use dir_out as is</span>
            <span class="n">dir_out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">hdr_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_spec</span><span class="p">(</span><span class="n">hdr_file</span><span class="p">,</span> <span class="n">spec_mean</span><span class="p">,</span> <span class="n">spec_std</span><span class="p">,</span>
                           <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                           <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                           <span class="n">ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">ext</span><span class="p">,</span>
                           <span class="n">interleave</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">,</span>
                           <span class="n">byteorder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span>
                           <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_spec_clip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                           <span class="n">name_append</span><span class="p">,</span> <span class="n">wl_bands</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Actually executes the spectral clip to keep the main function a bit</span>
<span class="sd">        cleaner</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">fname_list_p</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">fname_list</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fname_list_p</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">fname_list_p</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s1">&#39;Processing file </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)))</span>
            <span class="c1"># print(&#39;\nSpectrally clipping: {0}&#39;.format(fname))</span>
            <span class="c1"># options for io.read_cube():</span>
            <span class="c1"># name_long, name_plot, name_short, individual_plot, overwrite</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span> <span class="o">=</span> <span class="n">spec_mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="p">)</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">()</span>
            <span class="n">array_clip</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span><span class="o">.</span><span class="n">spectral_clip</span><span class="p">(</span>
                    <span class="n">wl_bands</span><span class="o">=</span><span class="n">wl_bands</span><span class="p">)</span>

            <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">)</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_label</span>

            <span class="n">hdr_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_cube</span><span class="p">(</span><span class="n">hdr_file</span><span class="p">,</span> <span class="n">array_clip</span><span class="p">,</span>
                               <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                               <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                               <span class="n">ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">ext</span><span class="p">,</span>
                               <span class="n">interleave</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">,</span>
                               <span class="n">byteorder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span>
                               <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_spec_clip_pp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">,</span> <span class="n">wl_bands</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Actually executes the spectral clip to keep the main function a bit</span>
<span class="sd">        cleaner</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># print(&#39;Arglist: {0}&#39;.format(arg_list))</span>
        <span class="c1"># fname, base_dir_out, folder_name, name_append, wl_bands = arg_list</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Spectrally clipping: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
        <span class="c1"># options for io.read_cube():</span>
        <span class="c1"># name_long, name_plot, name_short, individual_plot, overwrite</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span> <span class="o">=</span> <span class="n">spec_mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="p">)</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                    <span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                    <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
        <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">()</span>
        <span class="n">array_clip</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span><span class="o">.</span><span class="n">spectral_clip</span><span class="p">(</span>
                <span class="n">wl_bands</span><span class="o">=</span><span class="n">wl_bands</span><span class="p">)</span>

        <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_label</span>

        <span class="n">hdr_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_cube</span><span class="p">(</span><span class="n">hdr_file</span><span class="p">,</span> <span class="n">array_clip</span><span class="p">,</span>
                           <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                           <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                           <span class="n">ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">ext</span><span class="p">,</span>
                           <span class="n">interleave</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">,</span>
                           <span class="n">byteorder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span>
                           <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_spec_combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Actually executes the spectra combine to keep the main function a bit</span>
<span class="sd">        cleaner</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">df_specs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_dir_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pix_n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_spec</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">spy_mem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile_spec</span><span class="o">.</span><span class="n">open_memmap</span><span class="p">()</span>
            <span class="n">pix_n</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">spy_mem</span><span class="p">))</span> <span class="o">/</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile_spec</span><span class="o">.</span><span class="n">nbands</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Combining datacubes/spectra into a single mean spectra.</span><span class="se">\n</span><span class="s1">&#39;</span>
              <span class="s1">&#39;Number of input datacubes/spectra: </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">Total number of &#39;</span>
              <span class="s1">&#39;pixels: </span><span class="si">{1}</span><span class="s1">&#39;</span>
              <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fname_list</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">pix_n</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_spec</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile_spec</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">pixels</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                       <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pixels</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">df_specs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df_specs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">df_specs</span> <span class="o">=</span> <span class="n">df_specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_temp</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_mean</span> <span class="o">=</span> <span class="n">df_specs</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mean</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_std</span> <span class="o">=</span> <span class="n">df_specs</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_std</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;std&#39;</span><span class="p">)</span>
        <span class="n">df_cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mean</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_std</span>
        <span class="n">df_cv</span> <span class="o">=</span> <span class="n">df_cv</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;cv&#39;</span><span class="p">)</span>

        <span class="n">hdr_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir_out</span><span class="p">,</span> <span class="s1">&#39;spec_mean_spy.spec.hdr&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_spec</span><span class="p">(</span><span class="n">hdr_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_std</span><span class="p">,</span>
                           <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                           <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                           <span class="n">ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">ext</span><span class="p">,</span>
                           <span class="n">interleave</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">,</span>
                           <span class="n">byteorder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span>
                           <span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile_spec</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_spec_mimic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                            <span class="n">name_append</span><span class="p">,</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">df_band_response</span><span class="p">,</span> <span class="n">col_wl</span><span class="p">,</span>
                            <span class="n">center_wl</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Actually executes the spectral resample to keep the main function a bit</span>
<span class="sd">        cleaner.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">fname_list_p</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">fname_list</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fname_list_p</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">fname_list_p</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s1">&#39;Processing file </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span>
                                             <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span> <span class="o">=</span> <span class="n">spec_mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="p">)</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">()</span>
            <span class="n">array_mimic</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span><span class="o">.</span><span class="n">spectral_mimic</span><span class="p">(</span>
                    <span class="n">sensor</span><span class="o">=</span><span class="n">sensor</span><span class="p">,</span> <span class="n">df_band_response</span><span class="o">=</span><span class="n">df_band_response</span><span class="p">,</span>
                    <span class="n">col_wl</span><span class="o">=</span><span class="n">col_wl</span><span class="p">,</span> <span class="n">center_wl</span><span class="o">=</span><span class="n">center_wl</span><span class="p">)</span>

            <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">)</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_label</span>

            <span class="n">hdr_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_cube</span><span class="p">(</span><span class="n">hdr_file</span><span class="p">,</span> <span class="n">array_mimic</span><span class="p">,</span>
                               <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                               <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                               <span class="n">ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">ext</span><span class="p">,</span>
                               <span class="n">interleave</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">,</span>
                               <span class="n">byteorder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span>
                               <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_spec_resample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                               <span class="n">name_append</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">,</span> <span class="n">bins_n</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Actually executes the spectral resample to keep the main function a bit</span>
<span class="sd">        cleaner.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">fname_list_p</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">fname_list</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fname_list_p</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">fname_list_p</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s1">&#39;Processing file </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span>
                                             <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span> <span class="o">=</span> <span class="n">spec_mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="p">)</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">()</span>
            <span class="n">array_bin</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span><span class="o">.</span><span class="n">spectral_resample</span><span class="p">(</span>
                    <span class="n">bandwidth</span><span class="o">=</span><span class="n">bandwidth</span><span class="p">,</span> <span class="n">bins_n</span><span class="o">=</span><span class="n">bins_n</span><span class="p">)</span>

            <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">)</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_label</span>

            <span class="n">hdr_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_cube</span><span class="p">(</span><span class="n">hdr_file</span><span class="p">,</span> <span class="n">array_bin</span><span class="p">,</span>
                               <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                               <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                               <span class="n">ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">ext</span><span class="p">,</span>
                               <span class="n">interleave</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">,</span>
                               <span class="n">byteorder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span>
                               <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_spec_smooth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                             <span class="n">name_append</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">stats</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Actually executes the spectral smooth to keep the main function a bit</span>
<span class="sd">        cleaner</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">stats</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">df_smooth_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;cv&#39;</span><span class="p">])</span>

        <span class="n">fname_list_p</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">fname_list</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fname_list_p</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">fname_list_p</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s1">&#39;Processing file </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)))</span>
            <span class="c1"># print(&#39;\nSpectrally smoothing: {0}&#39;.format(fname))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span> <span class="o">=</span> <span class="n">spec_mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="p">)</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">()</span>
            <span class="n">array_smooth</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span><span class="o">.</span><span class="n">spectral_smooth</span><span class="p">(</span>
                    <span class="n">window_size</span><span class="o">=</span><span class="n">window_size</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

            <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">)</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_label</span>

            <span class="n">hdr_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_cube</span><span class="p">(</span><span class="n">hdr_file</span><span class="p">,</span> <span class="n">array_smooth</span><span class="p">,</span>
                               <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                               <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                               <span class="n">ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">ext</span><span class="p">,</span>
                               <span class="n">interleave</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">,</span>
                               <span class="n">byteorder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span>
                               <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">stats</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">array_smooth</span><span class="p">)</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">array_smooth</span><span class="p">)</span>
                <span class="n">cv</span> <span class="o">=</span> <span class="n">std</span><span class="o">/</span><span class="n">mean</span>
                <span class="n">df_smooth_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">fname</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">cv</span><span class="p">]],</span>
                                              <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;cv&#39;</span><span class="p">])</span>
                <span class="n">df_smooth_stats</span> <span class="o">=</span> <span class="n">df_smooth_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_smooth_temp</span><span class="p">,</span>
                                                         <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stats</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_stats</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">df_smooth_stats</span><span class="p">,</span> <span class="n">fname_csv</span><span class="o">=</span><span class="n">name_append</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="s1">&#39;-stats.csv&#39;</span><span class="p">)</span>
            <span class="c1"># return df_smooth_stats</span>

    <span class="k">def</span> <span class="nf">_execute_spec_smooth_pp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                                <span class="n">name_append</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">stats</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Actually executes the spectral smooth to keep the main function a bit</span>
<span class="sd">        cleaner</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Spectrally smoothing: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">stats</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">df_smooth_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;cv&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span> <span class="o">=</span> <span class="n">spec_mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="p">)</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                    <span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                    <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
        <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">()</span>
        <span class="n">array_smooth</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span><span class="o">.</span><span class="n">spectral_smooth</span><span class="p">(</span>
                <span class="n">window_size</span><span class="o">=</span><span class="n">window_size</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

        <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_label</span>

        <span class="n">hdr_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_cube</span><span class="p">(</span><span class="n">hdr_file</span><span class="p">,</span> <span class="n">array_smooth</span><span class="p">,</span>
                           <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                           <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                           <span class="n">ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">ext</span><span class="p">,</span>
                           <span class="n">interleave</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">,</span>
                           <span class="n">byteorder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span>
                           <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stats</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">array_smooth</span><span class="p">)</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">array_smooth</span><span class="p">)</span>
            <span class="n">cv</span> <span class="o">=</span> <span class="n">std</span><span class="o">/</span><span class="n">mean</span>
            <span class="n">df_smooth_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">fname</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">cv</span><span class="p">]],</span>
                                          <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;cv&#39;</span><span class="p">])</span>
            <span class="n">df_smooth_stats</span> <span class="o">=</span> <span class="n">df_smooth_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_smooth_temp</span><span class="p">,</span>
                                                     <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df_smooth_stats</span>

    <span class="k">def</span> <span class="nf">_get_fname_similar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_to_match</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;bip&#39;</span><span class="p">,</span>
                           <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gets a similar filename from another directory</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="n">search_ext</span><span class="p">,</span>
                                      <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">)</span>
        <span class="n">fname_similar</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">fname_short</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:</span><span class="n">f</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
            <span class="c1"># if name_to_match in fname:</span>
            <span class="k">if</span> <span class="n">name_to_match</span> <span class="o">==</span> <span class="n">fname_short</span><span class="p">:</span>
                <span class="n">fname_similar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">msg1</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;No files found with a similar name to &quot;</span><span class="si">{0}</span><span class="s1">&quot;. Please be &#39;</span>
                <span class="s1">&#39;sure the images are created before continuing (e.g., did &#39;</span>
                <span class="s1">&#39;you perform band math yet?)</span><span class="se">\n\n</span><span class="s1">base_dir: </span><span class="si">{1}</span><span class="s1">&#39;</span>
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_to_match</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">))</span>
        <span class="n">msg2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Multiple files found with a similar name to </span><span class="si">{0}</span><span class="s1">. Please &#39;</span>
                <span class="s1">&#39;delete files that are not relevant to continue.</span><span class="se">\n\n</span><span class="s1">base_dir: &#39;</span>
                <span class="s1">&#39;</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_to_match</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fname_similar</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg1</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fname_similar</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg2</span>
        <span class="k">return</span> <span class="n">fname_similar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_array_similar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_search</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Retrieves the array from a directory with a similar name to the loaded</span>
<span class="sd">        datacube (i.e., there must be a datacube loaded; self.io.spyfile should</span>
<span class="sd">        not be ``None``; compares to ``self.io.name_short``).</span>

<span class="sd">        Parameters:</span>
<span class="sd">            dir_search: directory to search</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please load a SpyFile prior to using this function&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dir_search</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The passed directory does not exist; please pass a valid &#39;</span>
                   <span class="s1">&#39;directory path.</span><span class="se">\n</span><span class="s1">Directory: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dir_search</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">fname_similar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fname_similar</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">name_short</span><span class="p">,</span> <span class="n">dir_search</span><span class="p">,</span>
                <span class="n">search_ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">fpath_similar</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_search</span><span class="p">,</span> <span class="n">fname_similar</span><span class="p">)</span>
        <span class="n">io_mask</span> <span class="o">=</span> <span class="n">hsio</span><span class="p">()</span>
        <span class="n">io_mask</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fpath_similar</span><span class="p">)</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">io_mask</span><span class="o">.</span><span class="n">spyfile</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">io_mask</span><span class="o">.</span><span class="n">spyfile</span><span class="o">.</span><span class="n">metadata</span>
        <span class="k">return</span> <span class="n">array</span><span class="p">,</span> <span class="n">metadata</span>

    <span class="k">def</span> <span class="nf">_get_class_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">filter_cols</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finds the class with the lowest NDVI in ``row`` and returns the class ID</span>
<span class="sd">        to be used to dictate which pixels get masked</span>

<span class="sd">        Parameters:</span>
<span class="sd">            n_classes (``int``): number of classes to mask; if 1, then will mask</span>
<span class="sd">            the minimum ndvi; if more than 1, all classes (default: 1)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">row_ndvi</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">filter_cols</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">row_ndvi</span> <span class="o">=</span> <span class="n">row_ndvi</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">row_ndvi</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">n_classes</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_ndvi</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_classes</span><span class="p">:</span>
            <span class="n">n_classes</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">row_ndvi_small</span> <span class="o">=</span> <span class="n">row_ndvi</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_classes</span><span class="p">)</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="n">row_ndvi_small</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">class_mask</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">class_name</span><span class="p">:</span>
            <span class="n">class_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>
            <span class="n">class_mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_int</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">class_mask</span>

    <span class="k">def</span> <span class="nf">_recurs_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Searches all folders and subfolders recursively within &lt;base_dir&gt;</span>
<span class="sd">        for filetypes of &lt;search_exp&gt;.</span>
<span class="sd">        Returns sorted &lt;outFiles&gt;, a list of full path strings of each result.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            base_dir: directory path that should include files to be returned</span>
<span class="sd">            search_ext: file format/extension to search for in all directories</span>
<span class="sd">                and subdirectories</span>
<span class="sd">            level: how many levels to search; if None, searches all levels</span>

<span class="sd">        Returns:</span>
<span class="sd">            out_files: include the full pathname, filename, and ext of all</span>
<span class="sd">                files that have ``search_exp`` in their name.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">d_str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">out_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">d_str</span><span class="p">:</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">search_ext</span><span class="p">):</span>
                <span class="n">out_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">new_dir</span> <span class="o">=</span> <span class="n">full_path</span>  <span class="c1"># If dir, then search in that</span>
                <span class="n">out_files_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">new_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">out_files_temp</span><span class="p">:</span>  <span class="c1"># if list is not empty</span>
                    <span class="n">out_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">out_files_temp</span><span class="p">)</span>  <span class="c1"># add items</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">out_files</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_save_file_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Basic setup items when saving manipulated image files to disk</span>

<span class="sd">        Parameters:</span>
<span class="sd">            base_dir_out (``str``): Parent directory that all processed datacubes</span>
<span class="sd">                will be saved.</span>
<span class="sd">            folder_name (``str`` or ``None``): Folder to add to</span>
<span class="sd">                ``base_dir_out`` to save all the processed datacubes.</span>
<span class="sd">            name_append (``str``): name to append to the filename.</span>
<span class="sd">        &#39;&#39;&#39;</span>
<span class="c1">#        if base_dir_out is None:</span>
<span class="c1">#            base_dir_out = os.path.join(self.base_dir, folder_name)</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">folder_name</span><span class="p">):</span>
            <span class="n">folder_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">dir_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dir_out</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dir_out</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name_append</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name_append</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name_append</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                <span class="n">name_append</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">name_append</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span>

    <span class="k">def</span> <span class="nf">_get_name_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">name_print</span><span class="p">,</span> <span class="n">name_append</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gets the name label for the datacube. By doing this before the</span>
<span class="sd">        processing operation, we can check to see if the datacube has</span>
<span class="sd">        already been processed and pass over if desired.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;study&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;study&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">name_study</span> <span class="o">=</span> <span class="s1">&#39;study_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;study&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name_study</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;date&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
                <span class="n">name_date</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;date_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
                             <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
                             <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name_date</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;plot_id_ref&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name_plot</span> <span class="o">=</span> <span class="s1">&#39;plot_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;plot_id_ref&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name_plot</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">name_study</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">name_date</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">name_plot</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)):</span>  <span class="c1"># then remove the name_print variable</span>
            <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_study</span> <span class="o">+</span> <span class="n">name_date</span> <span class="o">+</span> <span class="n">name_plot</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span>
                          <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name_label1</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">name_study</span> <span class="o">+</span> <span class="n">name_date</span> <span class="o">+</span>
                           <span class="n">name_plot</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name_label1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
                <span class="n">name_label1</span> <span class="o">=</span> <span class="n">name_label1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_label1</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name_label</span>

    <span class="k">def</span> <span class="nf">_get_name_print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_in</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">name_short</span>
        <span class="k">if</span> <span class="n">name_print</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fname_in</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fname_in</span><span class="p">)</span>
            <span class="n">name_print</span> <span class="o">=</span> <span class="n">base_name</span><span class="p">[:</span><span class="n">base_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Could not get a name for input datacube.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">name_print</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
        <span class="k">return</span> <span class="n">name_print</span>

    <span class="k">def</span> <span class="nf">_read_spectra_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reads a single spectra from file</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_spec</span><span class="p">(</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span><span class="p">)</span>
        <span class="n">meta_bands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">meta_bands</span>
        <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile_spec</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">name_plot</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
        <span class="n">df_spec_file</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_spec_file</span>

    <span class="k">def</span> <span class="nf">_print_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                       <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bar_length</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call in a loop to create terminal progress bar</span>
<span class="sd">        @params:</span>
<span class="sd">            iteration   - Required  : current iteration (Int)</span>
<span class="sd">            total       - Required  : total iterations (Int)</span>
<span class="sd">            prefix      - Optional  : prefix string (Str)</span>
<span class="sd">            suffix      - Optional  : suffix string (Str)</span>
<span class="sd">            decimals    - Optional  : positive number of decimals in percent complete (Int)</span>
<span class="sd">            bar_length  - Optional  : character length of bar (Int)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">str_format</span> <span class="o">=</span> <span class="s2">&quot;{0:.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decimals</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;f}&quot;</span>
        <span class="n">percents</span> <span class="o">=</span> <span class="n">str_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">total</span><span class="p">)))</span>
        <span class="n">filled_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">bar_length</span> <span class="o">*</span> <span class="n">iteration</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">total</span><span class="p">)))</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;&quot;</span> <span class="o">*</span> <span class="n">filled_length</span><span class="si">}{</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">bar_length</span> <span class="o">-</span> <span class="n">filled_length</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\r</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1"> |</span><span class="si">{</span><span class="n">bar</span><span class="si">}</span><span class="s1">| </span><span class="si">{</span><span class="n">percents</span><span class="si">}</span><span class="s1">% </span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span>
        <span class="c1"># sys.stdout.write(&#39;%s |%s| %s%s %s\r&#39; % (prefix, bar, percents, &#39;%&#39;, suffix))</span>
        <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="n">total</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<div class="viewcode-block" id="batch.cube_to_spectra"><a class="viewcode-back" href="../../hs_process.html#hs_process.batch.cube_to_spectra">[docs]</a>    <span class="k">def</span> <span class="nf">cube_to_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;bip&#39;</span><span class="p">,</span>
                        <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">folder_name</span><span class="o">=</span><span class="s1">&#39;cube_to_spec&#39;</span><span class="p">,</span>
                        <span class="n">name_append</span><span class="o">=</span><span class="s1">&#39;cube-to-spec&#39;</span><span class="p">,</span>
                        <span class="n">write_geotiff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">out_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_force</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">out_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_interleave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">out_byteorder</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the mean and standard deviation for each cube in</span>
<span class="sd">        ``fname_list`` and writes the result to a &quot;.spec&quot; file.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fname_list (``list``, optional): list of filenames to process; if</span>
<span class="sd">                left to ``None``, will look at ``base_dir``, ``search_ext``, and</span>
<span class="sd">                ``dir_level`` parameters for files to process (default: ``None``).</span>
<span class="sd">            base_dir (``str``, optional): directory path to search for files to</span>
<span class="sd">                spectrally clip; if ``fname_list`` is not ``None``, ``base_dir`` will</span>
<span class="sd">                be ignored (default: ``None``).</span>
<span class="sd">            search_ext (``str``): file format/extension to search for in all</span>
<span class="sd">                directories and subdirectories to determine which files to</span>
<span class="sd">                process; if ``fname_list`` is not ``None``, ``search_ext`` will</span>
<span class="sd">                be ignored (default: &#39;bip&#39;).</span>
<span class="sd">            dir_level (``int``): The number of directory levels to search; if</span>
<span class="sd">                ``None``, searches all directory levels (default: 0).</span>
<span class="sd">            base_dir_out (``str``): directory path to save all processed</span>
<span class="sd">                spectra; if set to ``None``, a folder named according to the</span>
<span class="sd">                ``folder_name`` parameter is added to ``base_dir``</span>
<span class="sd">            folder_name (``str``): folder to add to ``base_dir_out`` to save all</span>
<span class="sd">                the processed datacubes (default: &#39;cube_to_spec&#39;).</span>
<span class="sd">            name_append (``str``): name to append to the filename (default:</span>
<span class="sd">                &#39;cube-to-spec&#39;).</span>
<span class="sd">            write_geotiff (``bool``): whether to save the masked RGB image as a</span>
<span class="sd">                geotiff alongside the masked datacube.</span>
<span class="sd">            out_XXX: Settings for saving the output files can be adjusted here</span>
<span class="sd">                if desired. They are stored in ``batch.io.defaults``, and are</span>
<span class="sd">                therefore accessible at a high level. See</span>
<span class="sd">                ``hsio.set_io_defaults()`` for more information on each of the</span>
<span class="sd">                settings.</span>

<span class="sd">        Note:</span>
<span class="sd">            The following ``batch`` example builds on the API example results</span>
<span class="sd">            of the `spatial_mod.crop_many_gdf`_ function. Please complete the</span>
<span class="sd">            `spatial_mod.crop_many_gdf`_ example to be sure your directory</span>
<span class="sd">            (i.e., ``base_dir``) is populated with multiple hyperspectral</span>
<span class="sd">            datacubes. The following example will be using datacubes located in</span>
<span class="sd">            the following directory:</span>
<span class="sd">            ``F:\\nigo0024\Documents\hs_process_demo\spatial_mod\crop_many_gdf``</span>

<span class="sd">        Example:</span>
<span class="sd">            Load and initialize the ``batch`` module, checking to be sure the</span>
<span class="sd">            directory exists.</span>

<span class="sd">            &gt;&gt;&gt; import os</span>
<span class="sd">            &gt;&gt;&gt; from hs_process import batch</span>
<span class="sd">            &gt;&gt;&gt; data_dir = r&#39;F:\\nigo0024\Documents\hs_process_demo&#39;</span>
<span class="sd">            &gt;&gt;&gt; base_dir = os.path.join(data_dir, &#39;spatial_mod&#39;, &#39;crop_many_gdf&#39;)</span>
<span class="sd">            &gt;&gt;&gt; print(os.path.isdir(base_dir))</span>
<span class="sd">            &gt;&gt;&gt; hsbatch = batch(base_dir, search_ext=&#39;.bip&#39;, progress_bar=True)  # searches for all files in ``base_dir`` with a &quot;.bip&quot; file extension</span>
<span class="sd">            True</span>

<span class="sd">            Use ``batch.cube_to_spectra`` to calculate the *mean* and *standard</span>
<span class="sd">            deviation* across all pixels for each of the datacubes in</span>
<span class="sd">            ``base_dir``.</span>

<span class="sd">            &gt;&gt;&gt; hsbatch.cube_to_spectra(base_dir=base_dir, write_geotiff=False, out_force=True)</span>
<span class="sd">            Processing file 39/40: 100%|| 40/40 [00:03&lt;00:00, 13.28it/s]------------------------------------------------| 0.0%</span>


<span class="sd">            Use ``seaborn`` to visualize the spectra of plots 1011, 1012, and</span>
<span class="sd">            1013. Notice how ``hsbatch.io.name_plot`` is utilized to retrieve</span>
<span class="sd">            the plot ID, and how the *&quot;history&quot;* tag is referenced from the</span>
<span class="sd">            metadata to determine the number of pixels whose reflectance was</span>
<span class="sd">            averaged to create the mean spectra. Also remember that pixels</span>
<span class="sd">            across the original input image likely represent a combination of</span>
<span class="sd">            soil, vegetation, and shadow.</span>

<span class="sd">            &gt;&gt;&gt; import seaborn as sns</span>
<span class="sd">            &gt;&gt;&gt; import re</span>
<span class="sd">            &gt;&gt;&gt; fname_list = [os.path.join(base_dir, &#39;cube_to_spec&#39;, &#39;Wells_rep2_20180628_16h56m_pika_gige_7_plot_1011-cube-to-spec-mean.spec&#39;),</span>
<span class="sd">                              os.path.join(base_dir, &#39;cube_to_spec&#39;, &#39;Wells_rep2_20180628_16h56m_pika_gige_7_plot_1012-cube-to-spec-mean.spec&#39;),</span>
<span class="sd">                              os.path.join(base_dir, &#39;cube_to_spec&#39;, &#39;Wells_rep2_20180628_16h56m_pika_gige_7_plot_1013-cube-to-spec-mean.spec&#39;)]</span>
<span class="sd">            &gt;&gt;&gt; ax = None</span>
<span class="sd">            &gt;&gt;&gt; for fname in fname_list:</span>
<span class="sd">            &gt;&gt;&gt;     hsbatch.io.read_spec(fname)</span>
<span class="sd">            &gt;&gt;&gt;     meta_bands = list(hsbatch.io.tools.meta_bands.values())</span>
<span class="sd">            &gt;&gt;&gt;     data = hsbatch.io.spyfile_spec.load().flatten() * 100</span>
<span class="sd">            &gt;&gt;&gt;     hist = hsbatch.io.spyfile_spec.metadata[&#39;history&#39;]</span>
<span class="sd">            &gt;&gt;&gt;     pix_n = re.search(&#39;&lt;pixel number: (.*)&gt;&#39;, hist).group(1)</span>
<span class="sd">            &gt;&gt;&gt;     if ax is None:</span>
<span class="sd">            &gt;&gt;&gt;         ax = sns.lineplot(x=meta_bands, y=data, label=&#39;Plot &#39;+hsbatch.io.name_plot+&#39; (n=&#39;+pix_n+&#39;)&#39;)</span>
<span class="sd">            &gt;&gt;&gt;     else:</span>
<span class="sd">            &gt;&gt;&gt;         ax = sns.lineplot(x=meta_bands, y=data, label=&#39;Plot &#39;+hsbatch.io.name_plot+&#39; (n=&#39;+pix_n+&#39;)&#39;, ax=ax)</span>
<span class="sd">            &gt;&gt;&gt; ax.set_xlabel(&#39;Wavelength (nm)&#39;, weight=&#39;bold&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ax.set_ylabel(&#39;Reflectance (%)&#39;, weight=&#39;bold&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ax.set_title(r&#39;API Example: `batch.cube_to_spectra`&#39;, weight=&#39;bold&#39;)</span>

<span class="sd">            .. image:: ../img/batch/cube_to_spectra.png</span>

<span class="sd">        .. _spatial_mod.crop_many_gdf: hs_process.spatial_mod.html#hs_process.spatial_mod.crop_many_gdf</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">set_io_defaults</span><span class="p">(</span><span class="n">out_dtype</span><span class="p">,</span> <span class="n">out_force</span><span class="p">,</span> <span class="n">out_ext</span><span class="p">,</span> <span class="n">out_interleave</span><span class="p">,</span>
                                <span class="n">out_byteorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the ``batch`` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set ``fname_list`` or ``base_dir`` to indicate which &#39;</span>
                   <span class="s1">&#39;datacubes should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>

        <span class="n">append_extra</span> <span class="o">=</span> <span class="s1">&#39;-mean&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">force</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># otherwise just overwrites if it exists</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_processed</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span>
                                               <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">,</span>
                                               <span class="n">append_extra</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.spec&#39;</span><span class="p">)</span>

        <span class="c1"># pb_i = 0</span>
        <span class="c1"># pb_len = len(fname_list)</span>
        <span class="c1"># pb_prefix = &#39;cube_to_spectra:&#39;</span>
        <span class="c1"># self._print_progress(pb_i, pb_len, prefix=pb_prefix)</span>

        <span class="n">fname_list_p</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">fname_list</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fname_list_p</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">fname_list_p</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s1">&#39;Processing file </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">()</span>
            <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="n">append_extra</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">interleave</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_exists_check</span><span class="p">(</span>
                    <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">write_geotiff</span><span class="o">=</span><span class="n">write_geotiff</span><span class="p">,</span>
                    <span class="n">write_spec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># self.print_progress(idx+1, pb_len, prefix=pb_prefix)</span>
                <span class="k">continue</span>

            <span class="c1"># print(&#39;Calculating mean spectra: {0}&#39;.format(fname))</span>
            <span class="n">spec_mean</span><span class="p">,</span> <span class="n">spec_std</span><span class="p">,</span> <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">mean_datacube</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="p">)</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># because this is specialized, we should make our own history str</span>
            <span class="n">n_pix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="o">.</span><span class="n">nrows</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="o">.</span><span class="n">ncols</span>
            <span class="n">hist_str</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39; -&gt; hs_process.batch.cube_to_spectra[&lt;pixel number: &#39;</span>
                        <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&gt;]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_pix</span><span class="p">))</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">hist_str</span>
            <span class="n">name_label_spec</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name_label</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                               <span class="s1">&#39;.spec&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">write_geotiff</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_geotiff</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span>
                                    <span class="n">metadata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="p">)</span>
            <span class="c1"># Now write spec (will change map info on metadata)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_spec</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label_spec</span><span class="p">,</span> <span class="n">spec_mean</span><span class="p">,</span> <span class="n">spec_std</span><span class="p">,</span>
                             <span class="n">metadata</span><span class="p">)</span></div>
            <span class="c1"># self._print_progress(idx+1, pb_len, prefix=pb_prefix)</span>

<div class="viewcode-block" id="batch.segment_composite_band"><a class="viewcode-back" href="../../hs_process.html#hs_process.batch.segment_composite_band">[docs]</a>    <span class="k">def</span> <span class="nf">segment_composite_band</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;bip&#39;</span><span class="p">,</span> <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">folder_name</span><span class="o">=</span><span class="s1">&#39;composite_band&#39;</span><span class="p">,</span>
                               <span class="n">name_append</span><span class="o">=</span><span class="s1">&#39;composite-band&#39;</span><span class="p">,</span>
                               <span class="n">write_geotiff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wl1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">list_range</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_out</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">out_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_force</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">out_interleave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_byteorder</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Batch processing tool to create a composite band on multiple datacubes</span>
<span class="sd">        in the same way. ``batch.segment_composite_band`` is typically used</span>
<span class="sd">        prior to  ``batch.segment_create_mask`` to generate the</span>
<span class="sd">        images/directory required for the masking process.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            wl1 (``int``, ``float``, or ``list``): the wavelength (or set of</span>
<span class="sd">                wavelengths) to be used as the first parameter of the</span>
<span class="sd">                band math index; if ``list``, then consolidates all</span>
<span class="sd">                bands between two wavelength values by calculating the mean</span>
<span class="sd">                pixel value across all bands in that range (default: ``None``).</span>
<span class="sd">            b1 (``int``, ``float``, or ``list``): the band (or set of bands)</span>
<span class="sd">                to be used as the first parameter of the band math index; if</span>
<span class="sd">                ``list``, then consolidates all bands between two band values</span>
<span class="sd">                by calculating the mean pixel value across all bands in that</span>
<span class="sd">                range (default: ``None``).</span>
<span class="sd">            list_range (``bool``): Whether bands/wavelengths passed as a list</span>
<span class="sd">                is interpreted as a range of bands (``True``) or for each</span>
<span class="sd">                individual band in the list (``False``). If ``list_range`` is</span>
<span class="sd">                ``True``, ``b1``/``wl1`` and ``b2``/``wl2`` should be lists</span>
<span class="sd">                with two items, and all bands/wavelegths between the two values</span>
<span class="sd">                will be used (default: ``True``).</span>
<span class="sd">            plot_out (``bool``): whether to save a histogram of the band math</span>
<span class="sd">                result (default: ``True``).</span>
<span class="sd">            write_geotiff (``bool``): whether to save the masked RGB image as a</span>
<span class="sd">                geotiff alongside the masked datacube.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">set_io_defaults</span><span class="p">(</span><span class="n">out_dtype</span><span class="p">,</span> <span class="n">out_force</span><span class="p">,</span> <span class="n">out_ext</span><span class="p">,</span> <span class="n">out_interleave</span><span class="p">,</span>
                                <span class="n">out_byteorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the ``batch`` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set ``fname_list`` or ``base_dir`` to indicate which &#39;</span>
                   <span class="s1">&#39;datacubes should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>

        <span class="c1"># checks filenames</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">force</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># otherwise just overwrites if it exists</span>
            <span class="n">append_extra</span> <span class="o">=</span> <span class="s1">&#39;-comp-</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)))</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_processed</span><span class="p">(</span>
                <span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">,</span> <span class="n">append_extra</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_composite_band</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                                     <span class="n">name_append</span><span class="p">,</span> <span class="n">write_geotiff</span><span class="p">,</span> <span class="n">wl1</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span>
                                     <span class="n">list_range</span><span class="p">,</span> <span class="n">plot_out</span><span class="p">)</span></div>

<div class="viewcode-block" id="batch.segment_band_math"><a class="viewcode-back" href="../../hs_process.html#hs_process.batch.segment_band_math">[docs]</a>    <span class="k">def</span> <span class="nf">segment_band_math</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;bip&#39;</span><span class="p">,</span> <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">folder_name</span><span class="o">=</span><span class="s1">&#39;band_math&#39;</span><span class="p">,</span> <span class="n">name_append</span><span class="o">=</span><span class="s1">&#39;band-math&#39;</span><span class="p">,</span>
                          <span class="n">write_geotiff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ndi&#39;</span><span class="p">,</span> <span class="n">wl1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wl2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">wl3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">list_range</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_out</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">out_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_force</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">out_interleave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_byteorder</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Batch processing tool to perform band math on multiple datacubes in the</span>
<span class="sd">        same way. ``batch.segment_band_math`` is typically used prior to</span>
<span class="sd">        ``batch.segment_create_mask`` to generate the images/directory required</span>
<span class="sd">        for the masking process.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            method (``str``): Must be one of &quot;ndi&quot; (normalized difference</span>
<span class="sd">                index), &quot;ratio&quot; (simple ratio index), &quot;derivative&quot;</span>
<span class="sd">                (deriviative-type index), or &quot;mcari2&quot; (modified chlorophyll</span>
<span class="sd">                absorption index2). Indicates what kind of band math should be</span>
<span class="sd">                performed on the input datacube. The &quot;ndi&quot; method leverages</span>
<span class="sd">                ``segment.band_math_ndi()``, the &quot;ratio&quot; method leverages</span>
<span class="sd">                ``segment.band_math_ratio()``, and the &quot;derivative&quot; method</span>
<span class="sd">                leverages ``segment.band_math_derivative()``. Please see the</span>
<span class="sd">                ``segment`` documentation for more information (default:</span>
<span class="sd">                &quot;ndi&quot;).</span>
<span class="sd">            wl1 (``int``, ``float``, or ``list``): the wavelength (or set of</span>
<span class="sd">                wavelengths) to be used as the first parameter of the</span>
<span class="sd">                band math index; if ``list``, then consolidates all</span>
<span class="sd">                bands between two wavelength values by calculating the mean</span>
<span class="sd">                pixel value across all bands in that range (default: ``None``).</span>
<span class="sd">            wl2 (``int``, ``float``, or ``list``): the wavelength (or set of</span>
<span class="sd">                wavelengths) to be used as the second parameter of the</span>
<span class="sd">                band math index; if ``list``, then consolidates all</span>
<span class="sd">                bands between two wavelength values by calculating the mean</span>
<span class="sd">                pixel value across all bands in that range (default: ``None``).</span>
<span class="sd">            b1 (``int``, ``float``, or ``list``): the band (or set of bands) to be</span>
<span class="sd">                used as the first parameter of the band math index;</span>
<span class="sd">                if ``list``, then consolidates all bands between two band values</span>
<span class="sd">                by calculating the mean pixel value across all bands in that</span>
<span class="sd">                range (default: ``None``).</span>
<span class="sd">            b2 (``int``, ``float``, or ``list``): the band (or set of bands) to be</span>
<span class="sd">                used as the second parameter of the band math</span>
<span class="sd">                index; if ``list``, then consolidates all bands between two band</span>
<span class="sd">                values by calculating the mean pixel value across all bands in</span>
<span class="sd">                that range (default: ``None``).</span>
<span class="sd">            list_range (``bool``): Whether bands/wavelengths passed as a list is</span>
<span class="sd">                interpreted as a range of bands (``True``) or for each individual</span>
<span class="sd">                band in the list (``False``). If ``list_range`` is ``True``,</span>
<span class="sd">                ``b1``/``wl1`` and ``b2``/``wl2`` should be lists with two items, and</span>
<span class="sd">                all bands/wavelegths between the two values will be used</span>
<span class="sd">                (default: ``True``).</span>
<span class="sd">            plot_out (``bool``): whether to save a histogram of the band math</span>
<span class="sd">                result (default: ``True``).</span>
<span class="sd">            write_geotiff (``bool``): whether to save the masked RGB image as a</span>
<span class="sd">                geotiff alongside the masked datacube.</span>

<span class="sd">        Note:</span>
<span class="sd">            The following ``batch`` example builds on the API example results</span>
<span class="sd">            of the `spatial_mod.crop_many_gdf`_ function. Please complete the</span>
<span class="sd">            `spatial_mod.crop_many_gdf`_ example to be sure your directory</span>
<span class="sd">            (i.e., ``base_dir``) is populated with multiple hyperspectral</span>
<span class="sd">            datacubes. The following example will be using datacubes located in</span>
<span class="sd">            the following directory:</span>
<span class="sd">            ``F:\\nigo0024\Documents\hs_process_demo\spatial_mod\crop_many_gdf``</span>

<span class="sd">        Example:</span>
<span class="sd">            Load and initialize the ``batch`` module, checking to be sure the</span>
<span class="sd">            directory exists.</span>

<span class="sd">            &gt;&gt;&gt; import os</span>
<span class="sd">            &gt;&gt;&gt; from hs_process import batch</span>
<span class="sd">            &gt;&gt;&gt; base_dir = r&#39;F:\\nigo0024\Documents\hs_process_demo\spatial_mod\crop_many_gdf&#39;</span>
<span class="sd">            &gt;&gt;&gt; print(os.path.isdir(base_dir))</span>
<span class="sd">            True</span>
<span class="sd">            &gt;&gt;&gt; hsbatch = batch(base_dir, search_ext=&#39;.bip&#39;)  # searches for all files in ``base_dir`` with a &quot;.bip&quot; file extension</span>

<span class="sd">            Use ``batch.segment_band_math`` to compute the MCARI2 (Modified</span>
<span class="sd">            Chlorophyll Absorption Ratio Index Improved; Haboudane et al.,</span>
<span class="sd">            2004) spectral index for each of the datacubes in ``base_dir``. See</span>
<span class="sd">            `Harris Geospatial`_ for more information about the MCARI2 spectral</span>
<span class="sd">            index and references to other spectral indices.</span>

<span class="sd">            &gt;&gt;&gt; folder_name = &#39;band_math_mcari2-800-670-550&#39;  # folder name can be modified to be more descriptive in what type of band math is being performed</span>
<span class="sd">            &gt;&gt;&gt; method = &#39;mcari2&#39;  # must be one of &quot;ndi&quot;, &quot;ratio&quot;, &quot;derivative&quot;, or &quot;mcari2&quot;</span>
<span class="sd">            &gt;&gt;&gt; wl1 = 800</span>
<span class="sd">            &gt;&gt;&gt; wl2 = 670</span>
<span class="sd">            &gt;&gt;&gt; wl3 = 550</span>
<span class="sd">            &gt;&gt;&gt; hsbatch.segment_band_math(base_dir=base_dir, folder_name=folder_name,</span>
<span class="sd">                                          name_append=&#39;band-math&#39;, write_geotiff=True,</span>
<span class="sd">                                          method=method, wl1=wl1, wl2=wl2, wl3=wl3,</span>
<span class="sd">                                          plot_out=True, out_force=True)</span>
<span class="sd">            Bands used (``b1``): [198]</span>
<span class="sd">            Bands used (``b2``): [135]</span>
<span class="sd">            Bands used (``b3``): [77]</span>
<span class="sd">            Wavelengths used (``b1``): [799.0016]</span>
<span class="sd">            Wavelengths used (``b2``): [669.6752]</span>
<span class="sd">            Wavelengths used (``b3``): [550.6128]</span>
<span class="sd">            Saving F:\\nigo0024\Documents\hs_process_demo\spatial_mod\crop_many_gdf\band_math_mcari2-800-670-550\Wells_rep2_20180628_16h56m_pika_gige_7_plot_1011-band-math-mcari2-800-670-550.bip</span>
<span class="sd">            ...</span>

<span class="sd">            ``batch.segment_band_math`` creates a new folder in ``base_dir``</span>
<span class="sd">            (in this case the new directory is</span>
<span class="sd">            ``F:\\nigo0024\Documents\hs_process_demo\spatial_mod\crop_many_gdf\band_math_mcari2-800-670-550``)</span>
<span class="sd">            which contains several data products. The **first** is</span>
<span class="sd">            ``band-math-stats.csv``: a spreadsheet containing summary</span>
<span class="sd">            statistics for each of the image cubes that were processed via</span>
<span class="sd">            ``batch.segment_band_math``; stats include *pixel count*,</span>
<span class="sd">            *mean*, *standard deviation*, *median*, and *percentiles* across</span>
<span class="sd">            all image pixels.</span>

<span class="sd">            **Second** is a ``geotiff`` file for each of the image cubes after the</span>
<span class="sd">            band math processing. This can be opened in *QGIS* to visualize in</span>
<span class="sd">            a spatial reference system, or can be opened using any software</span>
<span class="sd">            that supports floating point *.tif* files.</span>

<span class="sd">            .. image:: ../img/batch/segment_band_math_plot_611-band-math-mcari2-800-670-550_tif.png</span>

<span class="sd">            **Third** is the band math raster saved in the *.hdr* file format.</span>
<span class="sd">            Note that the data conained here should be the same as in the</span>
<span class="sd">            *.tif* file, so it&#39;s a matter of preference as to what may be more</span>
<span class="sd">            useful. This single band *.hdr* can also be opend in *QGIS*.</span>

<span class="sd">            **Fourth** is a histogram of the band math data contained in the</span>
<span class="sd">            image. The histogram illustrates the 90th percentile value, which</span>
<span class="sd">            may be useful in the segmentation step (e.g., see</span>
<span class="sd">            `batch.segment_create_mask`_).</span>

<span class="sd">            .. image:: ../img/batch/segment_band_math_plot_611-band-math-mcari2-800-670-550.png</span>

<span class="sd">        .. _Harris Geospatial: https://www.harrisgeospatial.com/docs/NarrowbandGreenness.html#Modified3</span>
<span class="sd">        .. _batch.segment_create_mask: hs_process.batch.html#hs_process.batch.segment_create_mask</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">set_io_defaults</span><span class="p">(</span><span class="n">out_dtype</span><span class="p">,</span> <span class="n">out_force</span><span class="p">,</span> <span class="n">out_ext</span><span class="p">,</span> <span class="n">out_interleave</span><span class="p">,</span>
                                <span class="n">out_byteorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the ``batch`` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set ``fname_list`` or ``base_dir`` to indicate which &#39;</span>
                   <span class="s1">&#39;datacubes should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="c1"># else fname_list must be passed directly</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ndi&#39;</span><span class="p">:</span>
            <span class="n">append_extra</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;-</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                      <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">))))</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ratio&#39;</span><span class="p">:</span>
            <span class="n">append_extra</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;-</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                      <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">))))</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;derivative&#39;</span><span class="p">:</span>
            <span class="n">append_extra</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;-</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">-</span><span class="si">{3}</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                      <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">)),</span>
                                      <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl3</span><span class="p">))))</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mcari2&#39;</span><span class="p">:</span>
            <span class="n">append_extra</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;-</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">-</span><span class="si">{3}</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                      <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">)),</span>
                                      <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl3</span><span class="p">))))</span>

        <span class="c1"># checks filenames</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">force</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># otherwise just overwrites if it exists</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_processed</span><span class="p">(</span>
                <span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">,</span> <span class="n">append_extra</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_band_math</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                                <span class="n">name_append</span><span class="p">,</span> <span class="n">write_geotiff</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">wl1</span><span class="p">,</span> <span class="n">wl2</span><span class="p">,</span>
                                <span class="n">wl3</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">list_range</span><span class="p">,</span> <span class="n">plot_out</span><span class="p">)</span></div>

<div class="viewcode-block" id="batch.segment_create_mask"><a class="viewcode-back" href="../../hs_process.html#hs_process.batch.segment_create_mask">[docs]</a>    <span class="k">def</span> <span class="nf">segment_create_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;bip&#39;</span><span class="p">,</span> <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">base_dir_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">folder_name</span><span class="o">=</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="n">name_append</span><span class="o">=</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span>
                            <span class="n">write_datacube</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">write_spec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">write_geotiff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mask_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">mask_percentile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask_side</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                            <span class="n">out_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_force</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">out_interleave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_byteorder</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Batch processing tool to create a masked array on many datacubes.</span>
<span class="sd">        ``batch.segment_create_mask`` is typically used after</span>
<span class="sd">        ``batch.segment_band_math`` to mask all the datacubes in a directory</span>
<span class="sd">        based on the result of the band math process.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            mask_thresh (``float`` or ``int``): The value for which to mask the</span>
<span class="sd">                array; should be used with ``side`` parameter (default: ``None``).</span>
<span class="sd">            mask_percentile (``float`` or ``int``): The percentile of pixels to</span>
<span class="sd">                mask; if ``percentile``=95 and ``side``=&#39;lower&#39;, the lowest 95% of</span>
<span class="sd">                pixels will be masked following the band math operation</span>
<span class="sd">                (default: ``None``; range: 0-100).</span>
<span class="sd">            mask_side (``str``): The side of the threshold for which to apply the</span>
<span class="sd">                mask. Must be either &#39;lower&#39;, &#39;upper&#39;, &#39;outside&#39;, or ``None``;</span>
<span class="sd">                if &#39;lower&#39;, everything below the threshold will be masked; if</span>
<span class="sd">                &#39;outside&#39;, the ``thresh`` / ``percentile`` parameter must be</span>
<span class="sd">                list-like with two values indicating the lower and upper bounds</span>
<span class="sd">                - anything outside of these values will be masked out; if</span>
<span class="sd">                ``None``, only the values that exactly match the threshold will</span>
<span class="sd">                be masked (default: &#39;lower&#39;).</span>
<span class="sd">            geotiff (``bool``): whether to save the masked RGB image as a geotiff</span>
<span class="sd">                alongside the masked datacube.</span>

<span class="sd">        Note:</span>
<span class="sd">            The following ``batch`` example builds on the API example results</span>
<span class="sd">            of `spatial_mod.crop_many_gdf`_ and `batch.segment_band_math`_.</span>
<span class="sd">            Please complete each of those API examples to be sure your</span>
<span class="sd">            directories (i.e., ``base_dir``, and ``mask_dir``) are populated</span>
<span class="sd">            with image files. The following example will be masking datacubes</span>
<span class="sd">            located in:</span>
<span class="sd">            ``F:\\nigo0024\Documents\hs_process_demo\spatial_mod\crop_many_gdf``</span>
<span class="sd">            based on MCARI2 images located in:</span>
<span class="sd">            ``F:\\nigo0024\Documents\hs_process_demo\spatial_mod\crop_many_gdf\\band_math_mcari2-800-670-550``</span>

<span class="sd">        Example:</span>
<span class="sd">            Load and initialize the ``batch`` module, ensuring ``base_dir`` is</span>
<span class="sd">            a valid directory</span>

<span class="sd">            &gt;&gt;&gt; import os</span>
<span class="sd">            &gt;&gt;&gt; from hs_process import batch</span>
<span class="sd">            &gt;&gt;&gt; base_dir = r&#39;F:\\nigo0024\Documents\hs_process_demo\spatial_mod\crop_many_gdf&#39;</span>
<span class="sd">            &gt;&gt;&gt; print(os.path.isdir(base_dir))</span>
<span class="sd">            True</span>
<span class="sd">            &gt;&gt;&gt; hsbatch = batch(base_dir, search_ext=&#39;.bip&#39;)  # searches for all files in ``base_dir`` with a &quot;.bip&quot; file extension</span>

<span class="sd">            There must be a single-band image that will be used to determine</span>
<span class="sd">            which datacube pixels are to be masked (determined via the</span>
<span class="sd">            ``mask_dir`` parameter). Point to the directory that contains the</span>
<span class="sd">            MCARI2 images.</span>

<span class="sd">            &gt;&gt;&gt; mask_dir = os.path.join(base_dir, &#39;band_math_mcari2-800-670-550&#39;)</span>
<span class="sd">            &gt;&gt;&gt; print(os.path.isdir(mask_dir))</span>
<span class="sd">            True</span>

<span class="sd">            Indicate how the MCARI2 images should be used to determine which</span>
<span class="sd">            hyperspectal pixels are to be masked. The available parameters for</span>
<span class="sd">            controlling this are ``mask_thresh``, ``mask_percentile``, and</span>
<span class="sd">            ``mask_side``. We will mask out all pixels that fall below the</span>
<span class="sd">            MCARI2 90th percentile.</span>

<span class="sd">            &gt;&gt;&gt; mask_percentile = 90</span>
<span class="sd">            &gt;&gt;&gt; mask_side = &#39;lower&#39;</span>

<span class="sd">            Finally, indicate the folder to save the masked datacubes and</span>
<span class="sd">            perform the batch masking via ``batch.segment_create_mask``</span>

<span class="sd">            &gt;&gt;&gt; folder_name = &#39;mask_mcari2_90th&#39;</span>
<span class="sd">            &gt;&gt;&gt; hsbatch.segment_create_mask(base_dir=base_dir, mask_dir=mask_dir,</span>
<span class="sd">                                            folder_name=folder_name,</span>
<span class="sd">                                            name_append=&#39;mask-mcari2-90th&#39;, write_geotiff=True,</span>
<span class="sd">                                            mask_percentile=mask_percentile,</span>
<span class="sd">                                            mask_side=mask_side)</span>
<span class="sd">            Saving F:\\nigo0024\Documents\hs_process_demo\spatial_mod\crop_many_gdf\mask_mcari2_90th\Wells_rep2_20180628_16h56m_pika_gige_7_plot_1011-mask-mcari2-90th.bip</span>
<span class="sd">            Saving F:\\nigo0024\Documents\hs_process_demo\spatial_mod\crop_many_gdf\mask_mcari2_90th\Wells_rep2_20180628_16h56m_pika_gige_7_plot_1011-mask-mcari2-90th-spec-mean.spec</span>
<span class="sd">            ...</span>

<span class="sd">            .. image:: ../img/batch/segment_create_mask_inline.png</span>

<span class="sd">            ``batch.segment_create_mask`` creates a new folder in ``base_dir``</span>
<span class="sd">            named according to the ``folder_name`` parameter</span>
<span class="sd">            (in this case the new directory is</span>
<span class="sd">            ``F:\\nigo0024\Documents\hs_process_demo\spatial_mod\crop_many_gdf\mask_mcari2_90th``)</span>
<span class="sd">            which contains several data products. The **first** is</span>
<span class="sd">            ``mask-stats.csv``: a spreadsheet containing the band math</span>
<span class="sd">            threshold value for each image file. In this example, the MCARI2</span>
<span class="sd">            value corresponding to the 90th percentile is listed.</span>

<span class="sd">            +------------+------------+-------------+</span>
<span class="sd">            | fname      | plot_id    |lower-pctl-90|</span>
<span class="sd">            +============+============+=============+</span>
<span class="sd">            | ...        | 1011       | 0.83222     |</span>
<span class="sd">            +------------+------------+-------------+</span>
<span class="sd">            | ...        | 1012       | 0.81112     |</span>
<span class="sd">            +------------+------------+-------------+</span>
<span class="sd">            | ...        | 1013       | 0.74394     |</span>
<span class="sd">            +------------+------------+-------------+</span>

<span class="sd">            ...etc.</span>

<span class="sd">            **Second** is a ``geotiff`` file for each of the image cubes after the</span>
<span class="sd">            masking procedure. This can be opened in *QGIS* to visualize in</span>
<span class="sd">            a spatial reference system, or can be opened using any software</span>
<span class="sd">            that supports floating point *.tif* files. The masked pixels are</span>
<span class="sd">            saved as ``null`` values and should render transparently.</span>

<span class="sd">            .. image:: ../img/batch/segment_create_mask_geotiff.png</span>

<span class="sd">            **Third** is the full hyperspectral datacube, also with the masked</span>
<span class="sd">            pixels saved as ``null`` values. Note that the only pixels</span>
<span class="sd">            remaining are the 10% with the highest MCARI2 values.</span>

<span class="sd">            .. image:: ../img/batch/segment_create_mask_datacube.png</span>

<span class="sd">            **Fourth** is the mean spectra across the unmasked datacube pixels.</span>
<span class="sd">            This is illustrated above by the green line plot (the light green</span>
<span class="sd">            shadow represents the standard deviation for each band).</span>

<span class="sd">        .. _Harris Geospatial: https://www.harrisgeospatial.com/docs/NarrowbandGreenness.html#Modified3</span>
<span class="sd">        .. _batch.segment_band_math: hs_process.batch.html#hs_process.batch.segment_band_math</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">set_io_defaults</span><span class="p">(</span><span class="n">out_dtype</span><span class="p">,</span> <span class="n">out_force</span><span class="p">,</span> <span class="n">out_ext</span><span class="p">,</span> <span class="n">out_interleave</span><span class="p">,</span>
                                <span class="n">out_byteorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the ``batch`` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set ``fname_list`` or ``base_dir`` to indicate which &#39;</span>
                   <span class="s1">&#39;datacubes should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">force</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># otherwise just overwrites if it exists</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_processed</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span>
                                               <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_mask</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">mask_dir</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                           <span class="n">name_append</span><span class="p">,</span> <span class="n">write_datacube</span><span class="p">,</span> <span class="n">write_spec</span><span class="p">,</span>
                           <span class="n">write_geotiff</span><span class="p">,</span> <span class="n">mask_thresh</span><span class="p">,</span> <span class="n">mask_percentile</span><span class="p">,</span>
                           <span class="n">mask_side</span><span class="p">)</span></div>

<div class="viewcode-block" id="batch.spatial_crop"><a class="viewcode-back" href="../../hs_process.html#hs_process.batch.spatial_crop">[docs]</a>    <span class="k">def</span> <span class="nf">spatial_crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_sheet</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;bip&#39;</span><span class="p">,</span>
                     <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">folder_name</span><span class="o">=</span><span class="s1">&#39;spatial_crop&#39;</span><span class="p">,</span> <span class="n">name_append</span><span class="o">=</span><span class="s1">&#39;spatial-crop&#39;</span><span class="p">,</span>
                     <span class="n">write_geotiff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="n">gdf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">out_force</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_interleave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">out_byteorder</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Iterates through a spreadsheet that provides necessary information</span>
<span class="sd">        about how each image should be cropped and how it should be saved.</span>

<span class="sd">        If ``gdf`` is passed (a geopandas.GoeDataFrame polygon file), the</span>
<span class="sd">        cropped images will be shifted to the center of appropriate &#39;plot_id&#39;</span>
<span class="sd">        polygon.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fname_sheet (``fname``, ``pandas.DataFrame``, or ``None``, optional):</span>
<span class="sd">                The filename of the spreadsheed that provides the</span>
<span class="sd">                necessary information for fine-tuning the batch process</span>
<span class="sd">                cropping. See below for more information about the required and</span>
<span class="sd">                optional contents of ``fname_sheet`` and how to properly format</span>
<span class="sd">                it. Optionally, ``fname_sheet`` can be a ``Pandas.DataFrame``.</span>
<span class="sd">                If left to ``None``, ``base_dir`` and ``gdf`` must be passed.</span>
<span class="sd">            base_dir (``str``, optional): directory path to search for files to</span>
<span class="sd">                spatially crop; if ``fname_sheet`` is not ``None``,</span>
<span class="sd">                ``base_dir`` will be ignored (default: ``None``).</span>
<span class="sd">            base_dir_out (``str``, optional): output directory of the cropped</span>
<span class="sd">                image (default: ``None``).</span>
<span class="sd">            folder_name (``str``, optional): folder to add to ``base_dir_out``</span>
<span class="sd">                to save all the processed datacubes (default: &#39;spatial_crop&#39;).</span>
<span class="sd">            name_append (``str``, optional): name to append to the filename</span>
<span class="sd">                (default: &#39;spatial-crop&#39;).</span>
<span class="sd">            write_geotiff (``bool``, optional): whether to save an RGB image as</span>
<span class="sd">                a geotiff alongside the cropped datacube.</span>
<span class="sd">            method (``str``, optional): Must be one of &quot;single&quot; or</span>
<span class="sd">                &quot;many_gdf&quot;. Indicates whether a single plot should be cropped</span>
<span class="sd">                from the input datacube or if many/multiple plots should be</span>
<span class="sd">                cropped from the input datacube. The &quot;single&quot; method leverages</span>
<span class="sd">                `spatial_mod.crop_single()`_ and the &quot;many_gdf&quot; method</span>
<span class="sd">                leverages `spatial_mod.crop_many_gdf()`_. Please</span>
<span class="sd">                see the ``spatial_mod`` documentation for more information</span>
<span class="sd">                (default: &quot;single&quot;).</span>
<span class="sd">            gdf (``geopandas.GeoDataFrame``, optional): the plot names and</span>
<span class="sd">                polygon geometery of each of the plots; &#39;plot_id&#39; must be used as</span>
<span class="sd">                a column name to identify each of the plots, and should be an</span>
<span class="sd">                integer.</span>
<span class="sd">            out_XXX: Settings for saving the output files can be adjusted here</span>
<span class="sd">                if desired. They are stored in ``batch.io.defaults``, and are</span>
<span class="sd">                therefore accessible at a high level. See</span>
<span class="sd">                `hsio.set_io_defaults()`_ for more information on each of the</span>
<span class="sd">                settings.</span>

<span class="sd">        **Tips and Tricks for** ``fname_sheet`` **when** ``gdf`` **is not passed**</span>

<span class="sd">        If ``gdf`` is not passed, ``fname_sheet`` may have the following</span>
<span class="sd">        required column headings that correspond to the relevant parameters in</span>
<span class="sd">        `spatial_mod.crop_single()`_ and `spatial_mod.crop_many_gdf()`_:</span>

<span class="sd">        #. &quot;directory&quot;</span>
<span class="sd">        #. &quot;name_short&quot;</span>
<span class="sd">        #. &quot;name_long&quot;</span>
<span class="sd">        #. &quot;ext&quot;</span>
<span class="sd">        #. &quot;pix_e_ul&quot;</span>
<span class="sd">        #. &quot;pix_n_ul&quot;.</span>

<span class="sd">        With this minimum input, ``batch.spatial_crop`` will read in each</span>
<span class="sd">        image, crop from the upper left pixel (determined as</span>
<span class="sd">        ``pix_e_ul``/``pix_n_ul``) to the lower right pixel calculated</span>
<span class="sd">        based on ``crop_e_pix``/``crop_n_pix`` (which is the width of the</span>
<span class="sd">        cropped area in units of pixels).</span>

<span class="sd">        Note:</span>
<span class="sd">            ``crop_e_pix`` and ``crop_n_pix`` have default values (see</span>
<span class="sd">            `defaults.crop_defaults()`_), but they can also be passed</span>
<span class="sd">            specifically for each datacube by including appropriate columns in</span>
<span class="sd">            ``fname_sheet`` (which takes precedence over</span>
<span class="sd">            ``defaults.crop_defaults``).</span>

<span class="sd">        ``fname_sheet`` may also have the following optional column headings:</span>

<span class="sd">        #. &quot;crop_e_pix&quot;</span>
<span class="sd">        #. &quot;crop_n_pix&quot;</span>
<span class="sd">        #. &quot;crop_e_m&quot;</span>
<span class="sd">        #. &quot;crop_n_m&quot;</span>
<span class="sd">        #. &quot;buf_e_pix&quot;</span>
<span class="sd">        #. &quot;buf_n_pix&quot;</span>
<span class="sd">        #. &quot;buf_e_m&quot;</span>
<span class="sd">        #. &quot;buf_n_m&quot;</span>
<span class="sd">        #. &quot;gdf_shft_e_m&quot;</span>
<span class="sd">        #. &quot;gdf_shft_n_m&quot;</span>
<span class="sd">        #. &quot;plot_id_ref&quot;</span>
<span class="sd">        #. &quot;study&quot;</span>
<span class="sd">        #. &quot;date&quot;</span>

<span class="sd">        **More** ``fname_sheet`` **Tips and Tricks**</span>

<span class="sd">        #. These optional inputs passed via ``fname_sheet`` allow more control</span>
<span class="sd">           over exactly how the images are to be cropped. For a more detailed</span>
<span class="sd">           explanation of the information that many of these columns are</span>
<span class="sd">           intended to contain, see the documentation for</span>
<span class="sd">           `spatial_mod.crop_single()`_ and `spatial_mod.crop_many_gdf()`_.</span>
<span class="sd">           Those parameters not referenced should be apparent in the API</span>
<span class="sd">           examples and tutorials.</span>

<span class="sd">        #. If the column names are different in ``fname_sheet`` than described</span>
<span class="sd">           here, `defaults.spat_crop_cols()`_ can be modified to indicate which</span>
<span class="sd">           columns correspond to the relevant information.</span>

<span class="sd">        #. The *date* and *study* columns do not impact how the datacubes are</span>
<span class="sd">           to be cropped, but if this information exists,</span>
<span class="sd">           ``batch.spatial_crop`` adds it to the filename of the cropped</span>
<span class="sd">           datacube. This can be used to avoid overwriting datacubes with</span>
<span class="sd">           similar names, and is especially useful when processing imagery from</span>
<span class="sd">           many dates and/or studies/locations and saving them in the same</span>
<span class="sd">           directory. If &quot;study&quot;, &quot;date&quot;, and &quot;plot_id&quot; are all passed, this</span>
<span class="sd">           information is used to formulate the output file name; e.g.,</span>
<span class="sd">           *study_wells_date_20180628_plot_527-spatial-crop.bip*. If either</span>
<span class="sd">           &quot;study&quot; or &quot;date&quot; is missing, the populated variables wil be</span>
<span class="sd">           appended to the end of the ``hsio.name_short`` string; e.g.,</span>
<span class="sd">           *plot_9_3_pika_gige_1_plot_527-spatial-crop.bip*.</span>

<span class="sd">        #. Any other columns can be added to ``fname_sheet``, but</span>
<span class="sd">           ``batch.spatial_crop()`` does not use them in any way.</span>

<span class="sd">        Note:</span>
<span class="sd">            The following ``batch`` example only actually processes *a single*</span>
<span class="sd">            hyperspectral image. If more datacubes were present in</span>
<span class="sd">            ``base_dir``, however, ``batch.spatial_crop`` would process all</span>
<span class="sd">            datacubes that were available.</span>

<span class="sd">        Note:</span>
<span class="sd">            This example uses ``spatial_mod.crop_many_gdf`` to crop many</span>
<span class="sd">            plots from a datacube using a polygon geometry file describing the</span>
<span class="sd">            spatial extent of each plot.</span>

<span class="sd">        Example:</span>

<span class="sd">            Load and initialize the ``batch`` module, checking to be sure the</span>
<span class="sd">            directory exists.</span>

<span class="sd">            &gt;&gt;&gt; import os</span>
<span class="sd">            &gt;&gt;&gt; import geopandas as gpd</span>
<span class="sd">            &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">            &gt;&gt;&gt; from hs_process import batch</span>
<span class="sd">            &gt;&gt;&gt; base_dir = r&#39;F:\\nigo0024\Documents\hs_process_demo&#39;</span>
<span class="sd">            &gt;&gt;&gt; print(os.path.isdir(base_dir))</span>
<span class="sd">            &gt;&gt;&gt; hsbatch = batch(base_dir, search_ext=&#39;.bip&#39;, dir_level=0,</span>
<span class="sd">                                progress_bar=True)  # searches for all files in ``base_dir`` with a &quot;.bip&quot; file extension</span>
<span class="sd">            True</span>

<span class="sd">            Load the plot geometry as a ``geopandas.GeoDataFrame``</span>

<span class="sd">            &gt;&gt;&gt; fname_gdf = r&#39;F:\\nigo0024\Documents\hs_process_demo\plot_bounds.geojson&#39;</span>
<span class="sd">            &gt;&gt;&gt; gdf = gpd.read_file(fname_gdf)</span>

<span class="sd">            Perform the spatial cropping using the *&quot;many_gdf&quot;* `method`. Note</span>
<span class="sd">            that nothing is being passed to `fname_sheet` here, so</span>
<span class="sd">            ``batch.spatial_crop`` is simply going to attempt to crop all plots</span>
<span class="sd">            contained within `gdf` that overlap with any datacubes in</span>
<span class="sd">            ``base_dir``.</span>

<span class="sd">            Passing ``fname_sheet`` directly is definitely more flexible for</span>
<span class="sd">            customization. However, some customization is possible while not</span>
<span class="sd">            passing ``fname_sheet``. In the example below, we set an easting</span>
<span class="sd">            and northing buffer, as well as limit the number of plots to crop</span>
<span class="sd">            to 40. These defaults trickle through to</span>
<span class="sd">            ``spatial_mod.crop_many_gdf()``, so by setting them on the</span>
<span class="sd">            ``batch`` object, they will be recognized when calculating crop</span>
<span class="sd">            boundaries from ``gdf``.</span>

<span class="sd">            &gt;&gt;&gt; hsbatch.io.defaults.crop_defaults.buf_e_m = 2  # Sets buffer in the easting direction (units of meters)</span>
<span class="sd">            &gt;&gt;&gt; hsbatch.io.defaults.crop_defaults.buf_n_m = 0.5</span>
<span class="sd">            &gt;&gt;&gt; hsbatch.io.defaults.crop_defaults.n_plots = 40  # We can limit the number of plots to process from gdf</span>
<span class="sd">            &gt;&gt;&gt; hsbatch.spatial_crop(base_dir=base_dir, method=&#39;many_gdf&#39;,</span>
<span class="sd">                                     gdf=gdf, out_force=True)</span>

<span class="sd">            Because ``fname_list`` was passed instead of ``fname_sheet``, there is not a way to infer the study name and date. Therefore, &quot;study&quot; and &quot;date&quot; will be omitted from the output file name. If you would like output file names to include &quot;study&quot; and &quot;date&quot;, please pass ``fname_sheet`` with &quot;study&quot; and &quot;date&quot; columns.</span>

<span class="sd">            Processing file 39/40: 100%|| 40/40 [00:02&lt;00:00, 17.47it/s]</span>

<span class="sd">            .. image:: ../img/batch/spatial_crop_inline.png</span>

<span class="sd">            A new folder was created in ``base_dir``</span>
<span class="sd">            - ``F:\\nigo0024\Documents\hs_process_demo\spatial_crop`` - that</span>
<span class="sd">            contains the cropped datacubes and the cropped ``geotiff`` images.</span>
<span class="sd">            The Plot ID from the ``gdf`` is used to name each datacube</span>
<span class="sd">            according to its plot ID. The ``geotiff`` images can be opened in</span>
<span class="sd">            *QGIS* to visualize the images after cropping them.</span>

<span class="sd">            .. image:: ../img/batch/spatial_crop_tifs.png</span>

<span class="sd">            The cropped images were brightened in *QGIS* to emphasize the</span>
<span class="sd">            cropped boundaries. The plot boundaries are overlaid for reference</span>
<span class="sd">            (notice the 2.0 m buffer on the East/West ends and the 0.5 m buffer</span>
<span class="sd">            on the North/South sides).</span>

<span class="sd">        .. _defaults.crop_defaults(): hs_process.defaults.html#hs_process.defaults.crop_defaults</span>
<span class="sd">        .. _defaults.spat_crop_cols(): hs_process.defaults.html#hs_process.defaults.spat_crop_cols</span>
<span class="sd">        .. _hsio.set_io_defaults(): hs_process.hsio.html#hs_process.hsio.set_io_defaults</span>
<span class="sd">        .. _spatial_mod.crop_single(): hs_process.spatial_mod.html#hs_process.spatial_mod.crop_single</span>
<span class="sd">        .. _spatial_mod.crop_many_gdf(): hs_process.spatial_mod.html#hs_process.spatial_mod.crop_many_gdf</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;many_gdf&#39;</span><span class="p">:</span>
            <span class="n">msg1</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please pass a valid ``geopandas.GeoDataFrame`` if using &#39;</span>
                    <span class="s1">&#39;the &quot;many_gdf&quot; method.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">msg2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please be sure the passed ``geopandas.GeoDataFrame`` has &#39;</span>
                    <span class="s1">&#39;a column by the name of &quot;plot_id&quot;, indicating the plot &#39;</span>
                    <span class="s1">&#39;ID for each polygon geometry if using the &quot;many_gdf&quot; &#39;</span>
                    <span class="s1">&#39;method.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">),</span> <span class="n">msg1</span>
            <span class="k">assert</span> <span class="s1">&#39;plot_id&#39;</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">msg2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">set_io_defaults</span><span class="p">(</span><span class="n">out_dtype</span><span class="p">,</span> <span class="n">out_force</span><span class="p">,</span> <span class="n">out_ext</span><span class="p">,</span> <span class="n">out_interleave</span><span class="p">,</span>
                                <span class="n">out_byteorder</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fname_sheet</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_sheet</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the ``batch`` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set ``fname_list`` or ``base_dir`` to indicate which &#39;</span>
                   <span class="s1">&#39;datacubes should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># fname_list comes from fname_sheet</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Either fname_sheet or fname_list should be None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_crop</span><span class="p">(</span><span class="n">fname_sheet</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span>
                           <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">,</span> <span class="n">write_geotiff</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">gdf</span><span class="p">)</span></div>

<div class="viewcode-block" id="batch.spectra_combine"><a class="viewcode-back" href="../../hs_process.html#hs_process.batch.spectra_combine">[docs]</a>    <span class="k">def</span> <span class="nf">spectra_combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;bip&#39;</span><span class="p">,</span> <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">out_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_force</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">out_interleave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_byteorder</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Batch processing tool to gather all pixels from every image in a</span>
<span class="sd">        directory, compute the mean and standard deviation, and save as a</span>
<span class="sd">        single spectra (i.e., a spectra file is equivalent to a single spectral</span>
<span class="sd">        pixel with no spatial information).</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fname_list (``list``, optional): list of filenames to process; if</span>
<span class="sd">                left to ``None``, will look at ``base_dir``, ``search_ext``,</span>
<span class="sd">                and ``dir_level`` parameters for files to process (default:</span>
<span class="sd">                ``None``).</span>
<span class="sd">            base_dir (``str``, optional): directory path to search for files to</span>
<span class="sd">                spectrally clip; if ``fname_list`` is not ``None``,</span>
<span class="sd">                ``base_dir`` will be ignored (default: ``None``).</span>
<span class="sd">            search_ext (``str``): file format/extension to search for in all</span>
<span class="sd">                directories and subdirectories to determine which files to</span>
<span class="sd">                process; if ``fname_list`` is not ``None``, ``search_ext`` will</span>
<span class="sd">                be ignored (default: &#39;bip&#39;).</span>
<span class="sd">            dir_level (``int``): The number of directory levels to search; if</span>
<span class="sd">                ``None``, searches all directory levels (default: 0).</span>
<span class="sd">            base_dir_out (``str``): directory path to save all processed</span>
<span class="sd">                datacubes; if set to ``None``, a folder named according to the</span>
<span class="sd">                ``folder_name`` parameter is added to ``base_dir`` (default:</span>
<span class="sd">                ``None``).</span>
<span class="sd">            out_XXX: Settings for saving the output files can be adjusted here</span>
<span class="sd">                if desired. They are stored in ``batch.io.defaults, and are</span>
<span class="sd">                therefore accessible at a high level. See</span>
<span class="sd">                ``hsio.set_io_defaults()`` for more information on each of the</span>
<span class="sd">                settings.</span>

<span class="sd">        Note:</span>
<span class="sd">            The following example will load in several small hyperspectral</span>
<span class="sd">            radiance datacubes *(not reflectance)* that were previously cropped</span>
<span class="sd">            manually (via Spectronon software). These datacubes represent the</span>
<span class="sd">            radiance values of grey reference panels that were placed in the</span>
<span class="sd">            field to provide data necessary for converting radiance imagery</span>
<span class="sd">            to reflectance. These particular datacubes were extracted</span>
<span class="sd">            from several different images captured within ~10 minutes of each</span>
<span class="sd">            other.</span>

<span class="sd">        Example:</span>
<span class="sd">            Load and initialize the ``batch`` module, checking to be sure the</span>
<span class="sd">            directory exists.</span>

<span class="sd">            &gt;&gt;&gt; import os</span>
<span class="sd">            &gt;&gt;&gt; from hs_process import batch</span>
<span class="sd">            &gt;&gt;&gt; base_dir = r&#39;F:\\nigo0024\Documents\hs_process_demo\cube_ref_panels&#39;</span>
<span class="sd">            &gt;&gt;&gt; print(os.path.isdir(base_dir))</span>
<span class="sd">            True</span>
<span class="sd">            &gt;&gt;&gt; hsbatch = batch(base_dir)</span>

<span class="sd">            Combine all the *radiance* datacubes in the directory via</span>
<span class="sd">            ``batch.spectra_combine``.</span>

<span class="sd">            &gt;&gt;&gt; hsbatch.spectra_combine(base_dir=base_dir, search_ext=&#39;bip&#39;,</span>
<span class="sd">                                        dir_level=0)</span>
<span class="sd">            Combining datacubes/spectra into a single mean spectra.</span>
<span class="sd">            Number of input datacubes/spectra: 7</span>
<span class="sd">            Total number of pixels: 1516</span>
<span class="sd">            Saving F:\\nigo0024\Documents\hs_process_demo\cube_ref_panels\spec_mean_spy.spec</span>

<span class="sd">            Visualize the combined spectra by opening in *Spectronon*. The</span>
<span class="sd">            solid line represents the mean radiance spectra across all pixels</span>
<span class="sd">            and images in ``base_dir``, and the lighter, slightly transparent</span>
<span class="sd">            line represents the standard deviation of the radiance across all</span>
<span class="sd">            pixels and images in ``base_dir``.</span>

<span class="sd">            .. image:: ../img/batch/spectra_combine.png</span>

<span class="sd">            Notice the lower signal at the oxygen absorption region (near 770</span>
<span class="sd">            nm). After converting datacubes to reflectance, it may be</span>
<span class="sd">            desireable to spectrally clip this region (see</span>
<span class="sd">            `spec_mod.spectral_clip()`_)</span>

<span class="sd">        .. _spec_mod.spectral_clip(): hs_process.spec_mod.html#hs_process.spec_mod.spectral_clip</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">set_io_defaults</span><span class="p">(</span><span class="n">out_dtype</span><span class="p">,</span> <span class="n">out_force</span><span class="p">,</span> <span class="n">out_ext</span><span class="p">,</span> <span class="n">out_interleave</span><span class="p">,</span>
                                <span class="n">out_byteorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg1</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;``base_dir`` is not a valid directory.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">),</span> <span class="n">msg1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">base_dir</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the ``batch`` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set ``fname_list`` or ``base_dir`` to indicate &#39;</span>
                    <span class="s1">&#39;which datacubes should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg2</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_spec_combine</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">)</span></div>

<div class="viewcode-block" id="batch.spectra_derivative"><a class="viewcode-back" href="../../hs_process.html#hs_process.batch.spectra_derivative">[docs]</a>    <span class="k">def</span> <span class="nf">spectra_derivative</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;spec&#39;</span><span class="p">,</span>
            <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">folder_name</span><span class="o">=</span><span class="s1">&#39;spec_derivative&#39;</span><span class="p">,</span>
            <span class="n">name_append</span><span class="o">=</span><span class="s1">&#39;spec-derivative&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">out_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_force</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">out_interleave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_byteorder</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Batch processing tool to calculate the numeric spectral derivative for</span>
<span class="sd">        multiple spectra.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fname_list (``list``, optional): list of filenames to process; if</span>
<span class="sd">                left to ``None``, will look at ``base_dir``, ``search_ext``,</span>
<span class="sd">                and ``dir_level`` parameters for files to process (default:</span>
<span class="sd">                ``None``).</span>
<span class="sd">            base_dir (``str``, optional): directory path to search for files to</span>
<span class="sd">                process; if ``fname_list`` is not ``None``, ``base_dir`` will</span>
<span class="sd">                be ignored (default: ``None``).</span>
<span class="sd">            search_ext (``str``): file format/extension to search for in all</span>
<span class="sd">                directories and subdirectories to determine which files to</span>
<span class="sd">                process; if ``fname_list`` is not ``None``, ``search_ext`` will</span>
<span class="sd">                be ignored (default: &#39;bip&#39;).</span>
<span class="sd">            dir_level (``int``): The number of directory levels to search; if</span>
<span class="sd">                ``None``, searches all directory levels (default: 0).</span>
<span class="sd">            base_dir_out (``str``): directory path to save all processed</span>
<span class="sd">                spectra; if set to ``None``, a folder named according to the</span>
<span class="sd">                ``folder_name`` parameter is added to ``base_dir``</span>
<span class="sd">            folder_name (``str``): folder to add to ``base_dir_out`` to save</span>
<span class="sd">                all the processed datacubes (default: &#39;spec_derivative&#39;).</span>
<span class="sd">            name_append (``str``): name to append to the filename (default:</span>
<span class="sd">                &#39;spec-derivative&#39;).</span>
<span class="sd">            order (``int``): The order of the derivative (default: 1).</span>
<span class="sd">            out_XXX: Settings for saving the output files can be adjusted here</span>
<span class="sd">                if desired. They are stored in ``batch.io.defaults, and are</span>
<span class="sd">                therefore accessible at a high level. See</span>
<span class="sd">                ``hsio.set_io_defaults()`` for more information on each of the</span>
<span class="sd">                settings.</span>


<span class="sd">        Note:</span>
<span class="sd">            The following `batch` example builds on the API example results</span>
<span class="sd">            of the `batch.cube_to_spectra`_ function. Please complete</span>
<span class="sd">            both the `spatial_mod.crop_many_gdf`_ and</span>
<span class="sd">            `batch.cube_to_spectra`_ examples to be sure your directory</span>
<span class="sd">            (i.e., `base_dir`) is populated with multiple hyperspectral</span>
<span class="sd">            spectra. The following example will be using spectra located in the</span>
<span class="sd">            following directory:</span>
<span class="sd">            ``F:\\nigo0024\Documents\hs_process_demo\spatial_mod\crop_many_gdf\cube_to_spec`</span>

<span class="sd">        Example:</span>
<span class="sd">            Load and initialize the ``batch`` module, checking to be sure the</span>
<span class="sd">            directory exists.</span>

<span class="sd">            &gt;&gt;&gt; import os</span>
<span class="sd">            &gt;&gt;&gt; from hs_process import batch</span>
<span class="sd">            &gt;&gt;&gt; data_dir = r&#39;F:\\nigo0024\Documents\hs_process_demo&#39;</span>
<span class="sd">            &gt;&gt;&gt; base_dir = os.path.join(data_dir, &#39;spatial_mod&#39;, &#39;crop_many_gdf&#39;, &#39;cube_to_spec&#39;)</span>
<span class="sd">            &gt;&gt;&gt; print(os.path.isdir(base_dir))</span>
<span class="sd">            &gt;&gt;&gt; hsbatch = batch(base_dir, search_ext=&#39;.spec&#39;, progress_bar=True)</span>

<span class="sd">            Use ``batch.spectra_derivative`` to calculate the central finite</span>
<span class="sd">            difference (i.e., the numeric spectral derivative) for each of the</span>
<span class="sd">            .spec files in ``base_dir``.</span>

<span class="sd">            &gt;&gt;&gt; order = 1</span>
<span class="sd">            &gt;&gt;&gt; hsbatch.spectra_derivative(base_dir=base_dir, order=order, out_force=True)</span>

<span class="sd">            Use seaborn to visualize the derivative spectra of plots 1011,</span>
<span class="sd">            1012, and 1013.</span>

<span class="sd">            &gt;&gt;&gt; import seaborn as sns</span>
<span class="sd">            &gt;&gt;&gt; import re</span>
<span class="sd">            &gt;&gt;&gt; fname_list = [os.path.join(base_dir, &#39;spec_derivative&#39;, &#39;Wells_rep2_20180628_16h56m_pika_gige_7_plot_1011-spec-derivative-order-{0}.spec&#39;.format(order)),</span>
<span class="sd">                              os.path.join(base_dir, &#39;spec_derivative&#39;, &#39;Wells_rep2_20180628_16h56m_pika_gige_7_plot_1012-spec-derivative-order-{0}.spec&#39;.format(order)),</span>
<span class="sd">                              os.path.join(base_dir, &#39;spec_derivative&#39;, &#39;Wells_rep2_20180628_16h56m_pika_gige_7_plot_1013-spec-derivative-order-{0}.spec&#39;.format(order))]</span>
<span class="sd">            &gt;&gt;&gt; ax = None</span>
<span class="sd">            &gt;&gt;&gt; for fname in fname_list:</span>
<span class="sd">            &gt;&gt;&gt;     hsbatch.io.read_spec(fname)</span>
<span class="sd">            &gt;&gt;&gt;     meta_bands = list(hsbatch.io.tools.meta_bands.values())</span>
<span class="sd">            &gt;&gt;&gt;     data = hsbatch.io.spyfile_spec.open_memmap().flatten() * 100</span>
<span class="sd">            &gt;&gt;&gt;     hist = hsbatch.io.spyfile_spec.metadata[&#39;history&#39;]</span>
<span class="sd">            &gt;&gt;&gt;     pix_n = re.search(&#39;&lt;pixel number: (?s)(.*)&gt;] -&gt;&#39;, hist).group(1)</span>
<span class="sd">            &gt;&gt;&gt;     if ax is None:</span>
<span class="sd">            &gt;&gt;&gt;         ax = sns.lineplot(meta_bands, 0, color=&#39;gray&#39;)</span>
<span class="sd">            &gt;&gt;&gt;         ax = sns.lineplot(x=meta_bands, y=data, label=&#39;Plot &#39;+hsbatch.io.name_plot+&#39; (n=&#39;+pix_n+&#39;)&#39;)</span>
<span class="sd">            &gt;&gt;&gt;     else:</span>
<span class="sd">            &gt;&gt;&gt;         ax = sns.lineplot(x=meta_bands, y=data, label=&#39;Plot &#39;+hsbatch.io.name_plot+&#39; (n=&#39;+pix_n+&#39;)&#39;, ax=ax)</span>
<span class="sd">            &gt;&gt;&gt; ax.set(ylim=(-1, 1))</span>
<span class="sd">            &gt;&gt;&gt; ax.set_xlabel(&#39;Wavelength (nm)&#39;, weight=&#39;bold&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ax.set_ylabel(&#39;Derivative reflectance (%)&#39;, weight=&#39;bold&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ax.set_title(r&#39;API Example: `batch.spectra_derivative`&#39;, weight=&#39;bold&#39;)</span>

<span class="sd">            .. image:: ../img/batch/spectra_derivative.png</span>

<span class="sd">        .. _spatial_mod.crop_many_gdf: hs_process.spatial_mod.html#hs_process.spatial_mod.crop_many_gdf</span>
<span class="sd">        .. _batch.cube_to_spectra: hs_process.batch.html#hs_process.batch.cube_to_spectra</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">set_io_defaults</span><span class="p">(</span><span class="n">out_dtype</span><span class="p">,</span> <span class="n">out_force</span><span class="p">,</span> <span class="n">out_ext</span><span class="p">,</span> <span class="n">out_interleave</span><span class="p">,</span>
                                <span class="n">out_byteorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the ``batch`` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set ``fname_list`` or ``base_dir`` to indicate &#39;</span>
                   <span class="s1">&#39;which spectra should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name_append</span><span class="p">:</span>
             <span class="n">name_append</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-order-</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_append</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">force</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># otherwise just overwrites if it exists</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_processed</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span>
                                               <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">,</span>
                                               <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.spec&#39;</span><span class="p">)</span>

        <span class="n">fname_list_p</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">fname_list</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fname_list_p</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">fname_list_p</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s1">&#39;Processing file </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_spec</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">()</span>
            <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;.spec&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_exists_check</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span>
                                       <span class="n">write_spec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span> <span class="o">=</span> <span class="n">spec_mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile_spec</span><span class="p">)</span>
            <span class="n">spec_dydx</span><span class="p">,</span> <span class="n">metadata_dydx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span><span class="o">.</span><span class="n">spec_derivative</span><span class="p">(</span>
                <span class="n">spyfile_spec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span><span class="o">.</span><span class="n">spyfile</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
            <span class="c1"># name_label_spec = (os.path.splitext(name_label)[0] +</span>
            <span class="c1">#                    &#39;-derivative-{0}.spec&#39;.format(order))</span>
            <span class="c1"># self.spec_dydx = spec_dydx</span>
            <span class="c1"># self.metadata_dydx = metadata_dydx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_spec</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">spec_dydx</span><span class="p">,</span>
                             <span class="n">spec_std</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata_dydx</span><span class="p">)</span></div>

<div class="viewcode-block" id="batch.spectra_to_csv"><a class="viewcode-back" href="../../hs_process.html#hs_process.batch.spectra_to_csv">[docs]</a>    <span class="k">def</span> <span class="nf">spectra_to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;spec&#39;</span><span class="p">,</span>
                       <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;stats-spectra&#39;</span><span class="p">,</span>
                       <span class="n">multithread</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reads all the ``.spec`` files in a direcory and saves their reflectance</span>
<span class="sd">        information to a ``.csv``. ``batch.spectra_to_csv`` is identical to</span>
<span class="sd">        ``batch.spectra_to_df`` except a ``.csv`` file is saved rather than</span>
<span class="sd">        returning a ``pandas.DataFrame``.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fname_list (``list``, optional): list of filenames to process; if</span>
<span class="sd">                left to ``None``, will look at ``base_dir``, ``search_ext``, and</span>
<span class="sd">                ``dir_level`` parameters for files to process (default: ``None``).</span>
<span class="sd">            base_dir (``str``, optional): directory path to search for files to</span>
<span class="sd">                spectrally clip; if ``fname_list`` is not ``None``, ``base_dir`` will</span>
<span class="sd">                be ignored (default: ``None``).</span>
<span class="sd">            search_ext (``str``): file format/extension to search for in all</span>
<span class="sd">                directories and subdirectories to determine which files to</span>
<span class="sd">                process; if ``fname_list`` is not ``None``, ``search_ext`` will</span>
<span class="sd">                be ignored (default: &#39;bip&#39;).</span>
<span class="sd">            dir_level (``int``): The number of directory levels to search; if</span>
<span class="sd">                ``None``, searches all directory levels (default: 0).</span>
<span class="sd">            base_dir_out (``str``): directory path to save all processed</span>
<span class="sd">                datacubes; if set to ``None``, file is saved to ``base_dir``</span>
<span class="sd">            name (``str``): The output filename (default: &quot;stats-spectra&quot;).</span>
<span class="sd">            multithread (``bool``): Whether to leverage multi-thread processing</span>
<span class="sd">                when reading the .spec files. Setting to ``True`` should speed</span>
<span class="sd">                up the time it takes to read all .spec files.</span>

<span class="sd">        Note:</span>
<span class="sd">            The following example builds on the API example results of</span>
<span class="sd">            `batch.segment_band_math()`_ and `batch.segment_create_mask()_.</span>
<span class="sd">            Please complete each of those API examples to be sure your</span>
<span class="sd">            directory (i.e.,</span>
<span class="sd">            ``F:\\nigo0024\Documents\hs_process_demo\spatial_mod\crop_many_gdf\mask_mcari2_90th``)</span>
<span class="sd">            is populated with image files.</span>

<span class="sd">        Example:</span>
<span class="sd">            Load and initialize the ``batch`` module, checking to be sure the</span>
<span class="sd">            directory exists.</span>

<span class="sd">            &gt;&gt;&gt; import os</span>
<span class="sd">            &gt;&gt;&gt; from hs_process import batch</span>
<span class="sd">            &gt;&gt;&gt; base_dir = r&#39;F:\\nigo0024\Documents\hs_process_demo\spatial_mod\crop_many_gdf\mask_mcari2_90th&#39;</span>
<span class="sd">            &gt;&gt;&gt; print(os.path.isdir(base_dir))</span>
<span class="sd">            True</span>
<span class="sd">            &gt;&gt;&gt; hsbatch = batch(base_dir)</span>

<span class="sd">            Read all the ``.spec`` files in ``base_dir`` and save them to a</span>
<span class="sd">            ``.csv`` file.</span>

<span class="sd">            &gt;&gt;&gt; hsbatch.spectra_to_csv(base_dir=base_dir, search_ext=&#39;spec&#39;,</span>
<span class="sd">                                       dir_level=0)</span>
<span class="sd">            Writing mean spectra to a .csv file.</span>
<span class="sd">            Number of input datacubes/spectra: 40</span>
<span class="sd">            Output file location: F:\\nigo0024\Documents\hs_process_demo\spatial_mod\crop_many_gdf\mask_mcari2_90th\stats-spectra.csv</span>

<span class="sd">            When ``stats-spectra.csv`` is opened in Microsoft Excel, we can see</span>
<span class="sd">            that each row is a ``.spec`` file from a different plot, and each</span>
<span class="sd">            column is a particular spectral band/wavelength.</span>

<span class="sd">            .. image:: ../img/batch/spectra_to_csv.png</span>

<span class="sd">        .. _batch.segment_band_math(): hs_process.batch.html#hs_process.batch.segment_band_math</span>
<span class="sd">        .. _batch.segment_create_mask(): hs_process.batch.html#hs_process.batch.segment_create_mask</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the ``batch`` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set ``fname_list`` or ``base_dir`` to indicate which &#39;</span>
                   <span class="s1">&#39;datacubes should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fname_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir_out</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing mean spectra to a .csv file.</span><span class="se">\n</span><span class="s1">&#39;</span>
              <span class="s1">&#39;Number of input datacubes/spectra: </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">Output file location: &#39;</span>
              <span class="s1">&#39;</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fname_list</span><span class="p">),</span> <span class="n">fname_csv</span><span class="p">))</span>
        <span class="c1"># df_spec = None</span>
        <span class="c1"># for fname in fname_list:</span>
        <span class="c1">#     self.io.read_spec(fname + &#39;.hdr&#39;)</span>
        <span class="c1">#     meta_bands = self.io.tools.meta_bands</span>
        <span class="c1">#     array = self.io.spyfile_spec.load()</span>
        <span class="c1">#     data = list(np.reshape(array, (array.shape[2])) * 100)</span>
        <span class="c1">#     data.insert(0, self.io.name_plot)</span>
        <span class="c1">#     data.insert(0, os.path.basename(fname))</span>
        <span class="c1">#     if df_spec is None:</span>
        <span class="c1">#         columns = list(meta_bands.values())</span>
        <span class="c1">#         columns.insert(0, &#39;wavelength&#39;)</span>
        <span class="c1">#         columns.insert(0, np.nan)</span>
        <span class="c1">#         bands = list(meta_bands.keys())</span>
        <span class="c1">#         bands.insert(0, &#39;plot_id&#39;)</span>
        <span class="c1">#         bands.insert(0, &#39;fname&#39;)</span>
        <span class="c1">#         df_spec = pd.DataFrame(data=[bands], columns=columns)</span>
        <span class="c1">#     df_spec_temp = pd.DataFrame(data=[data], columns=columns)</span>
        <span class="c1">#     df_spec = df_spec.append(df_spec_temp)</span>

        <span class="c1"># load the data from the Spectral Python (SpyFile) object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_spec</span><span class="p">(</span><span class="n">fname_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span><span class="p">)</span>  <span class="c1"># read first file to build df_spec column headings</span>
        <span class="n">meta_bands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">meta_bands</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">meta_bands</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">columns</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;wavelength&#39;</span><span class="p">)</span>
        <span class="n">columns</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">bands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">meta_bands</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">bands</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;plot_id&#39;</span><span class="p">)</span>
        <span class="n">bands</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;fname&#39;</span><span class="p">)</span>
        <span class="n">df_spec</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">bands</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>

        <span class="c1"># if multithread is True:</span>
        <span class="c1">#     with ThreadPoolExecutor() as executor:  # defaults to min(32, os.cpu_count() + 4)</span>
        <span class="c1">#         future_df_spec = {</span>
        <span class="c1">#             executor.submit(self._read_spectra_from_file,</span>
        <span class="c1">#                             fname,</span>
        <span class="c1">#                             df_spec.columns): fname for fname in fname_list}</span>
        <span class="c1">#         for future in as_completed(future_df_spec):</span>
        <span class="c1">#             data = future_df_spec[future]</span>
        <span class="c1">#             try:</span>
        <span class="c1">#                 df_spec_file = future.result()</span>
        <span class="c1">#                 df_spec = df_spec.append(df_spec_file)</span>
        <span class="c1">#             except Exception as exc:</span>
        <span class="c1">#                 print(&#39;%r generated an exception: %s&#39; % (data, exc))</span>
        <span class="c1"># else:</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
            <span class="n">df_spec_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_spectra_from_file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">df_spec</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">df_spec</span> <span class="o">=</span> <span class="n">df_spec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_spec_file</span><span class="p">)</span>
        <span class="n">df_spec</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="batch.spectra_to_df"><a class="viewcode-back" href="../../hs_process.html#hs_process.batch.spectra_to_df">[docs]</a>    <span class="k">def</span> <span class="nf">spectra_to_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;spec&#39;</span><span class="p">,</span>
                      <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">multithread</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reads all the .spec files in a direcory and returns their data as a</span>
<span class="sd">        ``pandas.DataFrame`` object. ``batch.spectra_to_df`` is identical to</span>
<span class="sd">        ``batch.spectra_to_csv`` except a ``pandas.DataFrame`` is returned</span>
<span class="sd">        rather than saving a ``.csv`` file.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fname_list (``list``, optional): list of filenames to process; if</span>
<span class="sd">                left to ``None``, will look at ``base_dir``, ``search_ext``, and</span>
<span class="sd">                ``dir_level`` parameters for files to process (default: ``None``).</span>
<span class="sd">            base_dir (``str``, optional): directory path to search for files to</span>
<span class="sd">                spectrally clip; if ``fname_list`` is not ``None``, ``base_dir`` will</span>
<span class="sd">                be ignored (default: ``None``).</span>
<span class="sd">            search_ext (``str``): file format/extension to search for in all</span>
<span class="sd">                directories and subdirectories to determine which files to</span>
<span class="sd">                process; if ``fname_list`` is not ``None``, ``search_ext`` will</span>
<span class="sd">                be ignored (default: &#39;bip&#39;).</span>
<span class="sd">            dir_level (``int``): The number of directory levels to search; if</span>
<span class="sd">                ``None``, searches all directory levels (default: 0).</span>
<span class="sd">            multithread (``bool``): Whether to leverage multi-thread processing</span>
<span class="sd">                when reading the .spec files. Setting to ``True`` should speed</span>
<span class="sd">                up the time it takes to read all .spec files.</span>

<span class="sd">        Note:</span>
<span class="sd">            The following example builds on the API example results of</span>
<span class="sd">            `batch.segment_band_math()`_ and `batch.segment_create_mask()_.</span>
<span class="sd">            Please complete each of those API examples to be sure your</span>
<span class="sd">            directory (i.e.,</span>
<span class="sd">            ``F:\\nigo0024\Documents\hs_process_demo\spatial_mod\crop_many_gdf\mask_mcari2_90th``)</span>
<span class="sd">            is populated with image files.</span>

<span class="sd">        Example:</span>
<span class="sd">            Load and initialize the ``batch`` module, checking to be sure the</span>
<span class="sd">            directory exists.</span>

<span class="sd">            &gt;&gt;&gt; import os</span>
<span class="sd">            &gt;&gt;&gt; from hs_process import batch</span>
<span class="sd">            &gt;&gt;&gt; base_dir = r&#39;F:\\nigo0024\Documents\hs_process_demo\spatial_mod\crop_many_gdf\mask_mcari2_90th&#39;</span>
<span class="sd">            &gt;&gt;&gt; print(os.path.isdir(base_dir))</span>
<span class="sd">            True</span>
<span class="sd">            &gt;&gt;&gt; hsbatch = batch(base_dir)</span>

<span class="sd">            Read all the ``.spec`` files in ``base_dir`` and load them to</span>
<span class="sd">            ``df_spec``, a ``pandas.DataFrame``.</span>

<span class="sd">            &gt;&gt;&gt; df_spec = hsbatch.spectra_to_df(base_dir=base_dir, search_ext=&#39;spec&#39;,</span>
<span class="sd">                                                dir_level=0)</span>
<span class="sd">            Writing mean spectra to a ``pandas.DataFrame``.</span>
<span class="sd">            Number of input datacubes/spectra: 40</span>

<span class="sd">            When visualizing ``df_spe`` in `Spyder`_, we can see that each row</span>
<span class="sd">            is a ``.spec`` file from a different plot, and each column is a</span>
<span class="sd">            particular spectral band.</span>

<span class="sd">            .. image:: ../img/batch/spectra_to_df.png</span>

<span class="sd">            It is somewhat confusing to conceptualize spectral data by band</span>
<span class="sd">            number (as opposed to the wavelenth it represents).</span>
<span class="sd">            ``hs_process.hs_tools.get_band`` can be used to retrieve</span>
<span class="sd">            spectral data for all plots via indexing by wavelength. Say we need</span>
<span class="sd">            to access reflectance at 710 nm for each plot.</span>

<span class="sd">            &gt;&gt;&gt; df_710nm = df_spec[[&#39;fname&#39;, &#39;plot_id&#39;, hsbatch.io.tools.get_band(710)]]</span>

<span class="sd">            .. image:: ../img/batch/spectra_to_df_710nm.png</span>

<span class="sd">        .. _batch.segment_band_math(): hs_process.batch.html#hs_process.batch.segment_band_math</span>
<span class="sd">        .. _batch.segment_create_mask(): hs_process.batch.html#hs_process.batch.segment_create_mask</span>
<span class="sd">        .. _Spyder: https://www.spyder-ide.org/</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the ``batch`` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set ``fname_list`` or ``base_dir`` to indicate which &#39;</span>
                   <span class="s1">&#39;datacubes should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing mean spectra to a ``pandas.DataFrame``.</span><span class="se">\n</span><span class="s1">&#39;</span>
              <span class="s1">&#39;Number of input datacubes/spectra: </span><span class="si">{0}</span><span class="s1">&#39;</span>
              <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fname_list</span><span class="p">)))</span>

        <span class="c1"># load the data from the Spectral Python (SpyFile) object</span>
        <span class="c1"># df_spec = None</span>
        <span class="c1"># for fname in fname_list:</span>
        <span class="c1">#     self.io.read_spec(fname + &#39;.hdr&#39;)</span>
        <span class="c1">#     meta_bands = self.io.tools.meta_bands</span>
        <span class="c1">#     array = self.io.spyfile_spec.load()</span>
        <span class="c1">#     data = list(np.reshape(array, (array.shape[2])))</span>
        <span class="c1">#     data.insert(0, self.io.name_plot)</span>
        <span class="c1">#     data.insert(0, os.path.basename(fname))</span>
        <span class="c1">#     if df_spec is None:</span>
        <span class="c1">#         bands = list(meta_bands.keys())</span>
        <span class="c1">#         bands.insert(0, &#39;plot_id&#39;)</span>
        <span class="c1">#         bands.insert(0, &#39;fname&#39;)</span>
        <span class="c1">#         df_spec = pd.DataFrame(columns=bands)</span>
        <span class="c1">#     df_spec_temp = pd.DataFrame(data=[data], columns=bands)</span>
        <span class="c1">#     df_spec = df_spec.append(df_spec_temp)</span>


        <span class="c1"># read first file to build df_spec column headings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_spec</span><span class="p">(</span><span class="n">fname_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span><span class="p">)</span>
        <span class="n">meta_bands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">meta_bands</span>
        <span class="n">bands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">meta_bands</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">bands</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;plot_id&#39;</span><span class="p">)</span>
        <span class="n">bands</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;fname&#39;</span><span class="p">)</span>
        <span class="n">df_spec</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">bands</span><span class="p">)</span>
        <span class="c1"># if multithread is True:</span>
        <span class="c1">#     with ThreadPoolExecutor() as executor:  # defaults to min(32, os.cpu_count() + 4)</span>
        <span class="c1">#         future_df_spec = {</span>
        <span class="c1">#             executor.submit(self._read_spectra_from_file,</span>
        <span class="c1">#                             fname,</span>
        <span class="c1">#                             df_spec.columns): fname for fname in fname_list}</span>
        <span class="c1">#         for future in as_completed(future_df_spec):</span>
        <span class="c1">#             data = future_df_spec[future]</span>
        <span class="c1">#             try:</span>
        <span class="c1">#                 df_spec_file = future.result()</span>
        <span class="c1">#                 df_spec = df_spec.append(df_spec_file)</span>
        <span class="c1">#             except Exception as exc:</span>
        <span class="c1">#                 print(&#39;%r generated an exception: %s&#39; % (data, exc))</span>
        <span class="c1"># else:</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
            <span class="n">df_spec_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_spectra_from_file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">df_spec</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">df_spec</span> <span class="o">=</span> <span class="n">df_spec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_spec_file</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">df_spec</span><span class="p">[</span><span class="s1">&#39;plot_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df_spec</span><span class="p">[</span><span class="s1">&#39;plot_id&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unable to convert &quot;plot_id&quot; column to numeric type.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_spec</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="batch.spectral_clip"><a class="viewcode-back" href="../../hs_process.html#hs_process.batch.spectral_clip">[docs]</a>    <span class="k">def</span> <span class="nf">spectral_clip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;bip&#39;</span><span class="p">,</span>
                      <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">folder_name</span><span class="o">=</span><span class="s1">&#39;spec_clip&#39;</span><span class="p">,</span>
                      <span class="n">name_append</span><span class="o">=</span><span class="s1">&#39;spec-clip&#39;</span><span class="p">,</span>
                      <span class="n">wl_bands</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">420</span><span class="p">],</span> <span class="p">[</span><span class="mi">760</span><span class="p">,</span> <span class="mi">776</span><span class="p">],</span> <span class="p">[</span><span class="mi">813</span><span class="p">,</span> <span class="mi">827</span><span class="p">],</span> <span class="p">[</span><span class="mi">880</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]],</span>
                      <span class="n">out_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_force</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">out_interleave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_byteorder</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Batch processing tool to spectrally clip multiple datacubes in the same</span>
<span class="sd">        way.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fname_list (``list``, optional): list of filenames to process; if</span>
<span class="sd">                left to ``None``, will look at ``base_dir``, ``search_ext``, and</span>
<span class="sd">                ``dir_level`` parameters for files to process (default: ``None``).</span>
<span class="sd">            base_dir (``str``, optional): directory path to search for files to</span>
<span class="sd">                spectrally clip; if ``fname_list`` is not ``None``, ``base_dir`` will</span>
<span class="sd">                be ignored (default: ``None``).</span>
<span class="sd">            search_ext (``str``): file format/extension to search for in all</span>
<span class="sd">                directories and subdirectories to determine which files to</span>
<span class="sd">                process; if ``fname_list`` is not ``None``, ``search_ext`` will</span>
<span class="sd">                be ignored (default: &#39;bip&#39;).</span>
<span class="sd">            dir_level (``int``): The number of directory levels to search; if</span>
<span class="sd">                ``None``, searches all directory levels (default: 0).</span>
<span class="sd">            base_dir_out (``str``): directory path to save all processed</span>
<span class="sd">                datacubes; if set to ``None``, a folder named according to the</span>
<span class="sd">                ``folder_name`` parameter is added to ``base_dir``</span>
<span class="sd">            folder_name (``str``): folder to add to ``base_dir_out`` to save all</span>
<span class="sd">                the processed datacubes (default: &#39;spec-clip&#39;).</span>
<span class="sd">            name_append (``str``): name to append to the filename (default:</span>
<span class="sd">                &#39;spec-clip&#39;).</span>
<span class="sd">            wl_bands (``list`` or ``list of lists``): minimum and maximum</span>
<span class="sd">                wavelenths to clip from image; if multiple groups of</span>
<span class="sd">                wavelengths should be cut, this should be a list of lists. For</span>
<span class="sd">                example, wl_bands=[760, 776] will clip all bands greater than</span>
<span class="sd">                760.0 nm and less than 776.0 nm;</span>
<span class="sd">                wl_bands = [[0, 420], [760, 776], [813, 827], [880, 1000]]</span>
<span class="sd">                will clip all band less than 420.0 nm, bands greater than 760.0</span>
<span class="sd">                nm and less than 776.0 nm, bands greater than 813.0 nm and less</span>
<span class="sd">                than 827.0 nm, and bands greater than 880 nm (default).</span>
<span class="sd">            out_XXX: Settings for saving the output files can be adjusted here</span>
<span class="sd">                if desired. They are stored in ``batch.io.defaults, and are</span>
<span class="sd">                therefore accessible at a high level. See</span>
<span class="sd">                ``hsio.set_io_defaults()`` for more information on each of the</span>
<span class="sd">                settings.</span>

<span class="sd">        Note:</span>
<span class="sd">            The following ``batch`` example builds on the API example results</span>
<span class="sd">            of the `batch.spatial_crop`_ function. Please complete the</span>
<span class="sd">            `batch.spatial_crop`_ example to be sure your directory</span>
<span class="sd">            (i.e., ``base_dir``) is populated with multiple hyperspectral</span>
<span class="sd">            datacubes. The following example will be using datacubes located in</span>
<span class="sd">            the following directory:</span>
<span class="sd">            ``F:\\nigo0024\Documents\hs_process_demo\spatial_crop``</span>

<span class="sd">        Example:</span>
<span class="sd">            Load and initialize the ``batch`` module, checking to be sure the</span>
<span class="sd">            directory exists.</span>

<span class="sd">            &gt;&gt;&gt; import os</span>
<span class="sd">            &gt;&gt;&gt; from hs_process import batch</span>
<span class="sd">            &gt;&gt;&gt; base_dir = r&#39;F:\\nigo0024\Documents\hs_process_demo\spatial_crop&#39;</span>
<span class="sd">            &gt;&gt;&gt; print(os.path.isdir(base_dir))</span>
<span class="sd">            True</span>
<span class="sd">            &gt;&gt;&gt; hsbatch = batch(base_dir, search_ext=&#39;.bip&#39;, progress_bar=True)  # searches for all files in ``base_dir`` with a &quot;.bip&quot; file extension</span>

<span class="sd">            Use ``batch.spectral_clip`` to clip all spectral bands below</span>
<span class="sd">            *420 nm* and above *880 nm*, as well as the bands near the oxygen</span>
<span class="sd">            absorption (i.e., *760-776 nm*) and water absorption</span>
<span class="sd">            (i.e., *813-827 nm*) regions.</span>

<span class="sd">            &gt;&gt;&gt; hsbatch.spectral_clip(base_dir=base_dir, folder_name=&#39;spec_clip&#39;,</span>
<span class="sd">                                      wl_bands=[[0, 420], [760, 776], [813, 827], [880, 1000]],</span>
<span class="sd">                                      out_force=True)</span>
<span class="sd">            Processing 40 files. If this is not what is expected, please check if files have already undergone processing. If existing files should be overwritten, be sure to set the ``out_force`` parameter.</span>
<span class="sd">            Processing file 39/40: 100%|| 40/40 [00:01&lt;00:00, 26.68it/s]</span>

<span class="sd">            Use ``seaborn`` to visualize the spectra of a single pixel in one</span>
<span class="sd">            of the processed images.</span>

<span class="sd">            &gt;&gt;&gt; import seaborn as sns</span>
<span class="sd">            &gt;&gt;&gt; fname = os.path.join(base_dir, &#39;Wells_rep2_20180628_16h56m_pika_gige_7_1011-spatial-crop.bip&#39;)</span>
<span class="sd">            &gt;&gt;&gt; hsbatch.io.read_cube(fname)</span>
<span class="sd">            &gt;&gt;&gt; spy_mem = hsbatch.io.spyfile.open_memmap()  # datacube before clipping</span>
<span class="sd">            &gt;&gt;&gt; meta_bands = list(hsbatch.io.tools.meta_bands.values())</span>
<span class="sd">            &gt;&gt;&gt; fname = os.path.join(base_dir, &#39;spec_clip&#39;, &#39;Wells_rep2_20180628_16h56m_pika_gige_7_1011-spec-clip.bip&#39;)</span>
<span class="sd">            &gt;&gt;&gt; hsbatch.io.read_cube(fname)</span>
<span class="sd">            &gt;&gt;&gt; spy_mem_clip = hsbatch.io.spyfile.open_memmap()  # datacube after clipping</span>
<span class="sd">            &gt;&gt;&gt; meta_bands_clip = list(hsbatch.io.tools.meta_bands.values())</span>
<span class="sd">            &gt;&gt;&gt; ax = sns.lineplot(x=meta_bands, y=spy_mem[26][29], label=&#39;Before spectral clipping&#39;, linewidth=3)</span>
<span class="sd">            &gt;&gt;&gt; ax = sns.lineplot(x=meta_bands_clip, y=spy_mem_clip[26][29], label=&#39;After spectral clipping&#39;, ax=ax)</span>
<span class="sd">            &gt;&gt;&gt; ax.set_xlabel(&#39;Wavelength (nm)&#39;, weight=&#39;bold&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ax.set_ylabel(&#39;Reflectance (%)&#39;, weight=&#39;bold&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ax.set_title(r&#39;API Example: `batch.spectral_clip`&#39;, weight=&#39;bold&#39;)</span>

<span class="sd">            .. image:: ../img/batch/spectral_clip_plot.png</span>

<span class="sd">            Notice the spectral areas that were clipped, namely the oxygen and</span>
<span class="sd">            water absorption regions (~770 and ~820 nm, respectively). There</span>
<span class="sd">            is perhaps a lower *signal:noise* ratio in these regions, which was</span>
<span class="sd">            the merit for clipping those bands out.</span>

<span class="sd">        .. _batch.spatial_crop: hs_process.batch.html#hs_process.batch.spatial_crop</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">set_io_defaults</span><span class="p">(</span><span class="n">out_dtype</span><span class="p">,</span> <span class="n">out_force</span><span class="p">,</span> <span class="n">out_ext</span><span class="p">,</span> <span class="n">out_interleave</span><span class="p">,</span>
                                <span class="n">out_byteorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the ``batch`` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set ``fname_list`` or ``base_dir`` to indicate which &#39;</span>
                   <span class="s1">&#39;datacubes should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">force</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># otherwise just overwrites if it exists</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_processed</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span>
                                               <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_spec_clip</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                                <span class="n">name_append</span><span class="p">,</span> <span class="n">wl_bands</span><span class="p">)</span></div>

        <span class="c1"># with ThreadPoolExecutor(max_workers=None) as executor:  # defaults to min(32, os.cpu_count() + 4)</span>
        <span class="c1">#     future_to_clip = {</span>
        <span class="c1">#         executor.submit(self._execute_spec_clip_pp,</span>
        <span class="c1">#                         fname,</span>
        <span class="c1">#                         base_dir_out, folder_name, name_append, wl_bands): fname for fname in fname_list}</span>


<div class="viewcode-block" id="batch.spectral_mimic"><a class="viewcode-back" href="../../hs_process.html#hs_process.batch.spectral_mimic">[docs]</a>    <span class="k">def</span> <span class="nf">spectral_mimic</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;bip&#39;</span><span class="p">,</span>
            <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">folder_name</span><span class="o">=</span><span class="s1">&#39;spec_mimic&#39;</span><span class="p">,</span>
            <span class="n">name_append</span><span class="o">=</span><span class="s1">&#39;spec-mimic&#39;</span><span class="p">,</span> <span class="n">sensor</span><span class="o">=</span><span class="s1">&#39;sentinel-2a&#39;</span><span class="p">,</span>
            <span class="n">df_band_response</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">col_wl</span><span class="o">=</span><span class="s1">&#39;wl_nm&#39;</span><span class="p">,</span> <span class="n">center_wl</span><span class="o">=</span><span class="s1">&#39;peak&#39;</span><span class="p">,</span>
            <span class="n">out_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_force</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">out_interleave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_byteorder</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Batch processing tool to spectrally mimic a multispectral sensor for</span>
<span class="sd">        multiple datacubes in the same way.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fname_list (``list``, optional): list of filenames to process; if</span>
<span class="sd">                left to ``None``, will look at ``base_dir``, ``search_ext``,</span>
<span class="sd">                and ``dir_level`` parameters for files to process (default:</span>
<span class="sd">                ``None``).</span>
<span class="sd">            base_dir (``str``, optional): directory path to search for files to</span>
<span class="sd">                spectrally resample; if ``fname_list`` is not ``None``,</span>
<span class="sd">                ``base_dir`` will be ignored (default: ``None``).</span>
<span class="sd">            search_ext (``str``): file format/extension to search for in all</span>
<span class="sd">                directories and subdirectories to determine which files to</span>
<span class="sd">                process; if ``fname_list`` is not ``None``, ``search_ext`` will</span>
<span class="sd">                be ignored (default: &#39;bip&#39;).</span>
<span class="sd">            dir_level (``int``): The number of directory levels to search; if</span>
<span class="sd">                ``None``, searches all directory levels (default: 0).</span>
<span class="sd">            base_dir_out (``str``): directory path to save all processed</span>
<span class="sd">                datacubes; if set to ``None``, a folder named according to the</span>
<span class="sd">                ``folder_name`` parameter is added to ``base_dir``</span>
<span class="sd">            folder_name (``str``): folder to add to ``base_dir_out`` to save</span>
<span class="sd">                all the processed datacubes (default: &#39;spec_bin&#39;).</span>
<span class="sd">            name_append (``str``): name to append to the filename (default:</span>
<span class="sd">                &#39;spec-bin&#39;).</span>
<span class="sd">            sensor (``str``): Should be one of</span>
<span class="sd">                [&quot;sentera_6x&quot;, &quot;micasense_rededge_3&quot;, &quot;sentinel-2a&quot;,</span>
<span class="sd">                &quot;sentinel-2b&quot;, &quot;custom&quot;]; if &quot;custom&quot;, ``df_band_response``</span>
<span class="sd">                and ``col_wl`` must be passed.</span>
<span class="sd">            df_band_response (``pd.DataFrame``): A DataFrame that contains the</span>
<span class="sd">                transmissivity (%) for each sensor band (as columns) mapped to</span>
<span class="sd">                the continuous wavelength values (as rows). Required if</span>
<span class="sd">                ``sensor`` is  &quot;custom&quot;, ignored otherwise.</span>
<span class="sd">            col_wl (``str``): The column of ``df_band_response`` denoting the</span>
<span class="sd">                wavlengths (default: &#39;wl_nm&#39;).</span>
<span class="sd">            center_wl (``str``): Indicates how the center wavelength of each</span>
<span class="sd">                band is determined. If ``center_wl`` is &quot;peak&quot;, the point at</span>
<span class="sd">                which transmissivity is at its maximum is used as the center</span>
<span class="sd">                wavelength. If ``center_wl`` is &quot;weighted&quot;, the weighted</span>
<span class="sd">                average is used to compute the center wavelength. Must be one</span>
<span class="sd">                of [&quot;peak&quot;, &quot;weighted&quot;] (``default: &quot;peak&quot;``).</span>
<span class="sd">            out_XXX: Settings for saving the output files can be adjusted here</span>
<span class="sd">                if desired. They are stored in ``batch.io.defaults, and are</span>
<span class="sd">                therefore accessible at a high level. See</span>
<span class="sd">                ``hsio.set_io_defaults()`` for more information on each of the</span>
<span class="sd">                settings.</span>

<span class="sd">        Note:</span>
<span class="sd">            The following ``batch`` example builds on the API example results</span>
<span class="sd">            of the `batch.spatial_crop`_ function. Please complete the</span>
<span class="sd">            `batch.spatial_crop`_ example to be sure your directory</span>
<span class="sd">            (i.e., ``base_dir``) is populated with multiple hyperspectral</span>
<span class="sd">            datacubes. The following example will be using datacubes located in</span>
<span class="sd">            the following directory:</span>
<span class="sd">            ``F:\\nigo0024\Documents\hs_process_demo\spatial_crop``</span>

<span class="sd">        Example:</span>
<span class="sd">            Load and initialize the ``batch`` module, checking to be sure the</span>
<span class="sd">            directory exists.</span>

<span class="sd">            &gt;&gt;&gt; import os</span>
<span class="sd">            &gt;&gt;&gt; from hs_process import batch</span>
<span class="sd">            &gt;&gt;&gt; base_dir = r&#39;F:\\nigo0024\Documents\hs_process_demo\spatial_crop&#39;</span>
<span class="sd">            &gt;&gt;&gt; print(os.path.isdir(base_dir))</span>
<span class="sd">            True</span>
<span class="sd">            &gt;&gt;&gt; hsbatch = batch(base_dir, search_ext=&#39;.bip&#39;, progress_bar=True)  # searches for all files in ``base_dir`` with a &quot;.bip&quot; file extension</span>

<span class="sd">            Use ``batch.spectral_mimic`` to spectrally mimic the Sentinel-2A</span>
<span class="sd">            multispectral satellite sensor.</span>

<span class="sd">            &gt;&gt;&gt; hsbatch.spectral_mimic(</span>
<span class="sd">                base_dir=base_dir, folder_name=&#39;spec_mimic&#39;,</span>
<span class="sd">                name_append=&#39;sentinel-2a&#39;,</span>
<span class="sd">                sensor=&#39;sentinel-2a&#39;, center_wl=&#39;weighted&#39;)</span>
<span class="sd">            Processing 40 files. If existing files should be overwritten, be sure to set the ``out_force`` parameter.</span>
<span class="sd">            Processing file 39/40: 100%|| 40/40 [00:04&lt;00:00,  8.85it/s]</span>

<span class="sd">            Use ``seaborn`` to visualize the spectra of a single pixel in one</span>
<span class="sd">            of the processed images.</span>

<span class="sd">            &gt;&gt;&gt; import seaborn as sns</span>
<span class="sd">            &gt;&gt;&gt; fname = os.path.join(base_dir, &#39;Wells_rep2_20180628_16h56m_pika_gige_7_1011-spatial-crop.bip&#39;)</span>
<span class="sd">            &gt;&gt;&gt; hsbatch.io.read_cube(fname)</span>
<span class="sd">            &gt;&gt;&gt; spy_mem = hsbatch.io.spyfile.open_memmap()  # datacube before mimicking</span>
<span class="sd">            &gt;&gt;&gt; meta_bands = list(hsbatch.io.tools.meta_bands.values())</span>
<span class="sd">            &gt;&gt;&gt; fname = os.path.join(base_dir, &#39;spec_mimic&#39;, &#39;Wells_rep2_20180628_16h56m_pika_gige_7_1011-sentinel-2a.bip&#39;)</span>
<span class="sd">            &gt;&gt;&gt; hsbatch.io.read_cube(fname)</span>
<span class="sd">            &gt;&gt;&gt; spy_mem_sen2a = hsbatch.io.spyfile.open_memmap()  # datacube after mimicking</span>
<span class="sd">            &gt;&gt;&gt; meta_bands_sen2a = list(hsbatch.io.tools.meta_bands.values())</span>
<span class="sd">            &gt;&gt;&gt; ax = sns.lineplot(x=meta_bands, y=spy_mem[26][29], label=&#39;Hyperspectral (Pika II)&#39;, linewidth=3)</span>
<span class="sd">            &gt;&gt;&gt; ax = sns.lineplot(x=meta_bands_sen2a, y=spy_mem_sen2a[26][29], label=&#39;Sentinel-2A &quot;mimic&quot;&#39;, marker=&#39;o&#39;, ms=6, ax=ax)</span>
<span class="sd">            &gt;&gt;&gt; ax.set_xlabel(&#39;Wavelength (nm)&#39;, weight=&#39;bold&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ax.set_ylabel(&#39;Reflectance (%)&#39;, weight=&#39;bold&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ax.set_title(r&#39;API Example: `batch.spectral_mimic`&#39;, weight=&#39;bold&#39;)</span>

<span class="sd">            .. image:: ../img/batch/spectral_mimic_sentinel-2a_plot.png</span>

<span class="sd">        .. _batch.spatial_crop: hs_process.batch.html#hs_process.batch.spatial_crop</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">set_io_defaults</span><span class="p">(</span><span class="n">out_dtype</span><span class="p">,</span> <span class="n">out_force</span><span class="p">,</span> <span class="n">out_ext</span><span class="p">,</span> <span class="n">out_interleave</span><span class="p">,</span>
                                <span class="n">out_byteorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the ``batch`` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set ``fname_list`` or ``base_dir`` to indicate &#39;</span>
                   <span class="s1">&#39;which datacubes should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">force</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># otherwise just overwrites if it exists</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_processed</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span>
                                               <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_spec_mimic</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                                 <span class="n">name_append</span><span class="p">,</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">df_band_response</span><span class="p">,</span>
                                 <span class="n">col_wl</span><span class="p">,</span> <span class="n">center_wl</span><span class="p">)</span></div>

<div class="viewcode-block" id="batch.spectral_resample"><a class="viewcode-back" href="../../hs_process.html#hs_process.batch.spectral_resample">[docs]</a>    <span class="k">def</span> <span class="nf">spectral_resample</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;bip&#39;</span><span class="p">,</span>
            <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">folder_name</span><span class="o">=</span><span class="s1">&#39;spec_bin&#39;</span><span class="p">,</span>
            <span class="n">name_append</span><span class="o">=</span><span class="s1">&#39;spec-bin&#39;</span><span class="p">,</span> <span class="n">bandwidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bins_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">out_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_force</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">out_interleave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_byteorder</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Batch processing tool to spectrally resample (a.k.a. &quot;bin&quot;) multiple</span>
<span class="sd">        datacubes in the same way.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fname_list (``list``, optional): list of filenames to process; if</span>
<span class="sd">                left to ``None``, will look at ``base_dir``, ``search_ext``,</span>
<span class="sd">                and ``dir_level`` parameters for files to process (default:</span>
<span class="sd">                ``None``).</span>
<span class="sd">            base_dir (``str``, optional): directory path to search for files to</span>
<span class="sd">                spectrally resample; if ``fname_list`` is not ``None``,</span>
<span class="sd">                ``base_dir`` will be ignored (default: ``None``).</span>
<span class="sd">            search_ext (``str``): file format/extension to search for in all</span>
<span class="sd">                directories and subdirectories to determine which files to</span>
<span class="sd">                process; if ``fname_list`` is not ``None``, ``search_ext`` will</span>
<span class="sd">                be ignored (default: &#39;bip&#39;).</span>
<span class="sd">            dir_level (``int``): The number of directory levels to search; if</span>
<span class="sd">                ``None``, searches all directory levels (default: 0).</span>
<span class="sd">            base_dir_out (``str``): directory path to save all processed</span>
<span class="sd">                datacubes; if set to ``None``, a folder named according to the</span>
<span class="sd">                ``folder_name`` parameter is added to ``base_dir``</span>
<span class="sd">            folder_name (``str``): folder to add to ``base_dir_out`` to save</span>
<span class="sd">                all the processed datacubes (default: &#39;spec_bin&#39;).</span>
<span class="sd">            name_append (``str``): name to append to the filename (default:</span>
<span class="sd">                &#39;spec-bin&#39;).</span>
<span class="sd">            bandwidth (``float`` or ``int``): The bandwidth of the bands</span>
<span class="sd">                after spectral resampling is complete (units should be</span>
<span class="sd">                consistent with that of the .hdr file). Setting ``bandwidth``</span>
<span class="sd">                to 10 will consolidate bands that fall within every 10 nm</span>
<span class="sd">                interval.</span>
<span class="sd">            bins_n (``int``): The number of bins (i.e., &quot;bands&quot;) to achieve</span>
<span class="sd">                after spectral resampling is complete. Ignored if ``bandwidth``</span>
<span class="sd">                is not ``None``.</span>
<span class="sd">            out_XXX: Settings for saving the output files can be adjusted here</span>
<span class="sd">                if desired. They are stored in ``batch.io.defaults, and are</span>
<span class="sd">                therefore accessible at a high level. See</span>
<span class="sd">                ``hsio.set_io_defaults()`` for more information on each of the</span>
<span class="sd">                settings.</span>

<span class="sd">        Note:</span>
<span class="sd">            The following ``batch`` example builds on the API example results</span>
<span class="sd">            of the `batch.spatial_crop`_ function. Please complete the</span>
<span class="sd">            `batch.spatial_crop`_ example to be sure your directory</span>
<span class="sd">            (i.e., ``base_dir``) is populated with multiple hyperspectral</span>
<span class="sd">            datacubes. The following example will be using datacubes located in</span>
<span class="sd">            the following directory:</span>
<span class="sd">            ``F:\\nigo0024\Documents\hs_process_demo\spatial_crop``</span>

<span class="sd">        Example:</span>
<span class="sd">            Load and initialize the ``batch`` module, checking to be sure the</span>
<span class="sd">            directory exists.</span>

<span class="sd">            &gt;&gt;&gt; import os</span>
<span class="sd">            &gt;&gt;&gt; from hs_process import batch</span>
<span class="sd">            &gt;&gt;&gt; base_dir = r&#39;F:\\nigo0024\Documents\hs_process_demo\spatial_crop&#39;</span>
<span class="sd">            &gt;&gt;&gt; print(os.path.isdir(base_dir))</span>
<span class="sd">            True</span>
<span class="sd">            &gt;&gt;&gt; hsbatch = batch(base_dir, search_ext=&#39;.bip&#39;, progress_bar=True)  # searches for all files in ``base_dir`` with a &quot;.bip&quot; file extension</span>

<span class="sd">            Use ``batch.spectral_resample`` to bin (&quot;group&quot;) all spectral bands</span>
<span class="sd">            into 20 nm bandwidth bands (from ~2.3 nm bandwidth originally) on</span>
<span class="sd">            a per-pixel basis.</span>

<span class="sd">            &gt;&gt;&gt; hsbatch.spectral_resample(</span>
<span class="sd">                base_dir=base_dir, folder_name=&#39;spec_bin&#39;,</span>
<span class="sd">                name_append=&#39;spec-bin-20&#39;, bandwidth=20)</span>
<span class="sd">            Processing 40 files. If existing files should be overwritten, be sure to set the ``out_force`` parameter.</span>
<span class="sd">            Processing file 39/40: 100%|| 40/40 [00:00&lt;00:00, 48.31it/s]</span>
<span class="sd">            ...</span>

<span class="sd">            Use ``seaborn`` to visualize the spectra of a single pixel in one</span>
<span class="sd">            of the processed images.</span>

<span class="sd">            &gt;&gt;&gt; import seaborn as sns</span>
<span class="sd">            &gt;&gt;&gt; fname = os.path.join(base_dir, &#39;Wells_rep2_20180628_16h56m_pika_gige_7_1011-spatial-crop.bip&#39;)</span>
<span class="sd">            &gt;&gt;&gt; hsbatch.io.read_cube(fname)</span>
<span class="sd">            &gt;&gt;&gt; spy_mem = hsbatch.io.spyfile.open_memmap()  # datacube before resampling</span>
<span class="sd">            &gt;&gt;&gt; meta_bands = list(hsbatch.io.tools.meta_bands.values())</span>
<span class="sd">            &gt;&gt;&gt; fname = os.path.join(base_dir, &#39;spec_bin&#39;, &#39;Wells_rep2_20180628_16h56m_pika_gige_7_1011-spec-bin-20.bip&#39;)</span>
<span class="sd">            &gt;&gt;&gt; hsbatch.io.read_cube(fname)</span>
<span class="sd">            &gt;&gt;&gt; spy_mem_bin = hsbatch.io.spyfile.open_memmap()  # datacube after resampling</span>
<span class="sd">            &gt;&gt;&gt; meta_bands_bin = list(hsbatch.io.tools.meta_bands.values())</span>
<span class="sd">            &gt;&gt;&gt; ax = sns.lineplot(x=meta_bands, y=spy_mem[26][29], label=&#39;Hyperspectral (Pika II)&#39;, linewidth=3)</span>
<span class="sd">            &gt;&gt;&gt; ax = sns.lineplot(x=meta_bands_bin, y=spy_mem_bin[26][29], label=&#39;Spectral resample (20 nm)&#39;, marker=&#39;o&#39;, ms=6, ax=ax)</span>
<span class="sd">            &gt;&gt;&gt; ax.set_xlabel(&#39;Wavelength (nm)&#39;, weight=&#39;bold&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ax.set_ylabel(&#39;Reflectance (%)&#39;, weight=&#39;bold&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ax.set_title(r&#39;API Example: `batch.spectral_resample`&#39;, weight=&#39;bold&#39;)</span>

<span class="sd">            .. image:: ../img/batch/spectral_resample-20nm_plot.png</span>

<span class="sd">        .. _batch.spatial_crop: hs_process.batch.html#hs_process.batch.spatial_crop</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">set_io_defaults</span><span class="p">(</span><span class="n">out_dtype</span><span class="p">,</span> <span class="n">out_force</span><span class="p">,</span> <span class="n">out_ext</span><span class="p">,</span> <span class="n">out_interleave</span><span class="p">,</span>
                                <span class="n">out_byteorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the ``batch`` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set ``fname_list`` or ``base_dir`` to indicate &#39;</span>
                   <span class="s1">&#39;which datacubes should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">force</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># otherwise just overwrites if it exists</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_processed</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span>
                                               <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_spec_resample</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                                    <span class="n">name_append</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">,</span> <span class="n">bins_n</span><span class="p">)</span></div>

<div class="viewcode-block" id="batch.spectral_smooth"><a class="viewcode-back" href="../../hs_process.html#hs_process.batch.spectral_smooth">[docs]</a>    <span class="k">def</span> <span class="nf">spectral_smooth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;bip&#39;</span><span class="p">,</span>
                        <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">folder_name</span><span class="o">=</span><span class="s1">&#39;spec_smooth&#39;</span><span class="p">,</span> <span class="n">name_append</span><span class="o">=</span><span class="s1">&#39;spec-smooth&#39;</span><span class="p">,</span>
                        <span class="n">window_size</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">out_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_force</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">out_interleave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_byteorder</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Batch processing tool to spectrally smooth multiple datacubes in the</span>
<span class="sd">        same way.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fname_list (``list``, optional): list of filenames to process; if</span>
<span class="sd">                left to ``None``, will look at ``base_dir``, ``search_ext``, and</span>
<span class="sd">                ``dir_level`` parameters for files to process (default: ``None``).</span>
<span class="sd">            base_dir (``str``, optional): directory path to search for files to</span>
<span class="sd">                spectrally clip; if ``fname_list`` is not ``None``, ``base_dir`` will</span>
<span class="sd">                be ignored (default: ``None``).</span>
<span class="sd">            search_ext (``str``): file format/extension to search for in all</span>
<span class="sd">                directories and subdirectories to determine which files to</span>
<span class="sd">                process; if ``fname_list`` is not ``None``, ``search_ext`` will</span>
<span class="sd">                be ignored (default: &#39;bip&#39;).</span>
<span class="sd">            dir_level (``int``): The number of directory levels to search; if</span>
<span class="sd">                ``None``, searches all directory levels (default: 0).</span>
<span class="sd">            base_dir_out (``str``): directory path to save all processed</span>
<span class="sd">                datacubes; if set to ``None``, a folder named according to the</span>
<span class="sd">                ``folder_name`` parameter is added to ``base_dir``</span>
<span class="sd">            folder_name (``str``): folder to add to ``base_dir_out`` to save all</span>
<span class="sd">                the processed datacubes (default: &#39;spec-smooth&#39;).</span>
<span class="sd">            name_append (``str``): name to append to the filename (default:</span>
<span class="sd">                &#39;spec-smooth&#39;).</span>
<span class="sd">            window_size (``int``): the length of the window; must be an odd</span>
<span class="sd">                integer number (default: 11).</span>
<span class="sd">            order (``int``): the order of the polynomial used in the filtering;</span>
<span class="sd">                must be less than ``window_size`` - 1 (default: 2).</span>
<span class="sd">            stats (``bool``): whether to compute some basic descriptive</span>
<span class="sd">                statistics (mean, st. dev., and coefficient of variation) of</span>
<span class="sd">                the smoothed data array (default: ``False``)</span>
<span class="sd">            out_XXX: Settings for saving the output files can be adjusted here</span>
<span class="sd">                if desired. They are stored in ``batch.io.defaults, and are</span>
<span class="sd">                therefore accessible at a high level. See</span>
<span class="sd">                ``hsio.set_io_defaults()`` for more information on each of the</span>
<span class="sd">                settings.</span>

<span class="sd">        Note:</span>
<span class="sd">            The following ``batch`` example builds on the API example results</span>
<span class="sd">            of the `batch.spatial_crop`_ function. Please complete the</span>
<span class="sd">            `batch.spatial_crop`_ example to be sure your directory</span>
<span class="sd">            (i.e., ``base_dir``) is populated with multiple hyperspectral</span>
<span class="sd">            datacubes. The following example will be using datacubes located in</span>
<span class="sd">            the following directory:</span>
<span class="sd">            ``F:\\nigo0024\Documents\hs_process_demo\spatial_crop``</span>

<span class="sd">        Example:</span>
<span class="sd">            Load and initialize the ``batch`` module, checking to be sure the</span>
<span class="sd">            directory exists.</span>

<span class="sd">            &gt;&gt;&gt; import os</span>
<span class="sd">            &gt;&gt;&gt; from hs_process import batch</span>
<span class="sd">            &gt;&gt;&gt; base_dir = r&#39;F:\\nigo0024\Documents\hs_process_demo\spatial_crop&#39;</span>
<span class="sd">            &gt;&gt;&gt; print(os.path.isdir(base_dir))</span>
<span class="sd">            True</span>
<span class="sd">            &gt;&gt;&gt; hsbatch = batch(base_dir, search_ext=&#39;.bip&#39;)  # searches for all files in ``base_dir`` with a &quot;.bip&quot; file extension</span>

<span class="sd">            Use ``batch.spectral_smooth`` to perform a *Savitzky-Golay*</span>
<span class="sd">            smoothing operation on each image/pixel in ``base_dir``. The</span>
<span class="sd">            ``window_size`` and ``order`` can be adjusted to achieve desired</span>
<span class="sd">            smoothing results.</span>

<span class="sd">            &gt;&gt;&gt; hsbatch.spectral_smooth(base_dir=base_dir, folder_name=&#39;spec_smooth&#39;,</span>
<span class="sd">                                        window_size=11, order=2)</span>
<span class="sd">            Processing 40 files. If this is not what is expected, please check if files have already undergone processing. If existing files should be overwritten, be sure to set the ``out_force`` parameter.</span>
<span class="sd">            Spectrally smoothing: F:\\nigo0024\Documents\hs_process_demo\spatial_crop\Wells_rep2_20180628_16h56m_pika_gige_7_1011-spatial-crop.bip</span>
<span class="sd">            Saving F:\\nigo0024\Documents\hs_process_demo\spatial_crop\spec_smooth\Wells_rep2_20180628_16h56m_pika_gige_7_1011-spec-smooth.bip</span>
<span class="sd">            Spectrally smoothing: F:\\nigo0024\Documents\hs_process_demo\spatial_crop\Wells_rep2_20180628_16h56m_pika_gige_7_1012-spatial-crop.bip</span>
<span class="sd">            Saving F:\\nigo0024\Documents\hs_process_demo\spatial_crop\spec_smooth\Wells_rep2_20180628_16h56m_pika_gige_7_1012-spec-smooth.bip</span>
<span class="sd">            ...</span>

<span class="sd">            Use ``seaborn`` to visualize the spectra of a single pixel in one</span>
<span class="sd">            of the processed images.</span>

<span class="sd">            &gt;&gt;&gt; import seaborn as sns</span>
<span class="sd">            &gt;&gt;&gt; fname = os.path.join(base_dir, &#39;Wells_rep2_20180628_16h56m_pika_gige_7_1011-spatial-crop.bip&#39;)</span>
<span class="sd">            &gt;&gt;&gt; hsbatch.io.read_cube(fname)</span>
<span class="sd">            &gt;&gt;&gt; spy_mem = hsbatch.io.spyfile.open_memmap()  # datacube before smoothing</span>
<span class="sd">            &gt;&gt;&gt; meta_bands = list(hsbatch.io.tools.meta_bands.values())</span>
<span class="sd">            &gt;&gt;&gt; fname = os.path.join(base_dir, &#39;spec_smooth&#39;, &#39;Wells_rep2_20180628_16h56m_pika_gige_7_1011-spec-smooth.bip&#39;)</span>
<span class="sd">            &gt;&gt;&gt; hsbatch.io.read_cube(fname)</span>
<span class="sd">            &gt;&gt;&gt; spy_mem_clip = hsbatch.io.spyfile.open_memmap()  # datacube after smoothing</span>
<span class="sd">            &gt;&gt;&gt; meta_bands_clip = list(hsbatch.io.tools.meta_bands.values())</span>
<span class="sd">            &gt;&gt;&gt; ax = sns.lineplot(x=meta_bands, y=spy_mem[26][29], label=&#39;Before spectral smoothing&#39;, linewidth=3)</span>
<span class="sd">            &gt;&gt;&gt; ax = sns.lineplot(x=meta_bands_clip, y=spy_mem_clip[26][29], label=&#39;After spectral smoothing&#39;, ax=ax)</span>
<span class="sd">            &gt;&gt;&gt; ax.set_xlabel(&#39;Wavelength (nm)&#39;, weight=&#39;bold&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ax.set_ylabel(&#39;Reflectance (%)&#39;, weight=&#39;bold&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ax.set_title(r&#39;API Example: `batch.spectral_smooth`&#39;, weight=&#39;bold&#39;)</span>

<span class="sd">            .. image:: ../img/batch/spectral_smooth_plot.png</span>

<span class="sd">            Notice how the *&quot;choppiness&quot;* of the spectral curve is lessened</span>
<span class="sd">            after the smoothing operation. There are spectral regions that</span>
<span class="sd">            perhaps had a lower *signal:noise* ratio and did not do particularlly</span>
<span class="sd">            well at smoothing (i.e., &lt; 410 nm, ~770 nm, and ~820 nm). It may be</span>
<span class="sd">            wise to perform ``batch.spectral_smooth`` *after*</span>
<span class="sd">            `batch.spectral_clip`_.</span>

<span class="sd">        .. _batch.spatial_crop: hs_process.batch.html#hs_process.batch.spatial_crop</span>
<span class="sd">        .. _batch.spectral_clip: hs_process.batch.html#hs_process.batch.spectral_clip</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">set_io_defaults</span><span class="p">(</span><span class="n">out_dtype</span><span class="p">,</span> <span class="n">out_force</span><span class="p">,</span> <span class="n">out_ext</span><span class="p">,</span> <span class="n">out_interleave</span><span class="p">,</span>
                                <span class="n">out_byteorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the ``batch`` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set ``fname_list`` or ``base_dir`` to indicate which &#39;</span>
                   <span class="s1">&#39;datacubes should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">envi_write</span><span class="o">.</span><span class="n">force</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># otherwise just overwrites if it exists</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_processed</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span>
                                               <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_spec_smooth</span><span class="p">(</span>
                <span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">,</span>
                <span class="n">window_size</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span></div></div>
        <span class="c1"># if df_stats is not None:</span>
        <span class="c1">#     return df_stats</span>


        <span class="c1"># # Parallel threading</span>
        <span class="c1"># with ThreadPoolExecutor(max_workers=None) as executor:  # defaults to min(32, os.cpu_count() + 4)</span>
        <span class="c1">#     future_to_clip = {</span>
        <span class="c1">#         executor.submit(self._execute_spec_smooth_pp,</span>
        <span class="c1">#                         fname,</span>
        <span class="c1">#                         base_dir_out, folder_name, name_append,</span>
        <span class="c1">#                         window_size, order, stats): fname for fname in fname_list}</span>

        <span class="c1">#     df_stats = None</span>
        <span class="c1">#     if stats == True:</span>
        <span class="c1">#         for future in as_completed(future_to_clip):</span>
        <span class="c1">#             smooth = future_to_clip[future]</span>
        <span class="c1">#             try:</span>
        <span class="c1">#                 df_smooth_temp = future.result()</span>
        <span class="c1">#                 if df_stats is None:</span>
        <span class="c1">#                     df_stats = df_smooth_temp.copy()</span>
        <span class="c1">#                 else:</span>
        <span class="c1">#                     df_stats = df_stats.append(df_smooth_temp, ignore_index=True)</span>
        <span class="c1">#             except Exception as exc:</span>
        <span class="c1">#                 print(&#39;%r generated an exception: %s&#39; % (smooth, exc))</span>
        <span class="c1">#             else:</span>
        <span class="c1">#                 print(&#39;%r page is %d bytes&#39; % (smooth, len(data)))</span>

        <span class="c1">#         base_dir = os.path.dirname(fname_list[0])</span>
        <span class="c1">#         if base_dir_out is None:</span>
        <span class="c1">#             dir_out, name_append = self._save_file_setup(</span>
        <span class="c1">#                     base_dir, folder_name, name_append)</span>
        <span class="c1">#         else:</span>
        <span class="c1">#             dir_out, name_append = self._save_file_setup(</span>
        <span class="c1">#                     base_dir_out, folder_name, name_append)</span>

        <span class="c1">#         fname_stats = os.path.join(dir_out, name_append[1:] + &#39;-stats.csv&#39;)</span>
        <span class="c1">#         if os.path.isfile(fname_stats) and self.io.defaults.envi_write.force is False:</span>
        <span class="c1">#             df_stats_in = pd.read_csv(fname_stats)</span>
        <span class="c1">#             df_smooth_stats = df_stats_in.append(df_stats)</span>
        <span class="c1">#         df_smooth_stats.to_csv(fname_stats)</span>
        <span class="c1">#         return df_smooth_stats</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019-2021, Tyler J. Nigon.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.5.4.<br/>
    </p>
  </div>
</footer>
  </body>
</html>