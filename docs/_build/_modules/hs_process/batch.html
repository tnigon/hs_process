<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="python">
  <head>
    <meta charset="utf-8" />
    <title>hs_process.batch &#8212; hs_process 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          hs_process</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="https://github.com/tnigon/hs_process">Github</a></li>
                <li><a href="http://www.spectralpython.net/">Spectral Python</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Contents <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../eonr_installation.html">1. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../my_hs_process_api.html">2. API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/hs_process.batch.batch.html">2.1.1. batch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/hs_process.segment.segment.html">2.2.1. segment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/hs_process.spatial_mod.spatial_mod.html">2.3.1. spatial_mod</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/hs_process.spec_mod.spec_mod.html">2.4.1. spec_mod</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/hs_process.utilities.defaults.html">2.5.1. defaults</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/hs_process.utilities.hsio.html">2.5.2. hsio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/hs_process.utilities.hstools.html">2.5.3. hstools</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">3. License</a></li>
</ul>
</ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">
<form action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <h1>Source code for hs_process.batch</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">from</span> <span class="nn">hs_process.utilities</span> <span class="k">import</span> <span class="n">defaults</span>
<span class="kn">from</span> <span class="nn">hs_process.utilities</span> <span class="k">import</span> <span class="n">hsio</span>
<span class="kn">from</span> <span class="nn">hs_process.segment</span> <span class="k">import</span> <span class="n">segment</span>
<span class="kn">from</span> <span class="nn">hs_process.spec_mod</span> <span class="k">import</span> <span class="n">spec_mod</span>
<span class="kn">from</span> <span class="nn">hs_process.spatial_mod</span> <span class="k">import</span> <span class="n">spatial_mod</span>


<div class="viewcode-block" id="batch"><a class="viewcode-back" href="../../api/hs_process.batch.batch.html#hs_process.batch.batch">[docs]</a><span class="k">class</span> <span class="nc">batch</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Parent class for batch processing hyperspectral image data</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;.bip&#39;</span><span class="p">,</span> <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Parameters:</span>
<span class="sd">            base_dir (`str`, optional): directory path to search for files to</span>
<span class="sd">                spectrally clip; if `fname_list` is not `None`, `base_dir` will</span>
<span class="sd">                be ignored (default: `None`).</span>
<span class="sd">            search_ext (`str`): file format/extension to search for in all</span>
<span class="sd">                directories and subdirectories to determine which files to</span>
<span class="sd">                process; if `fname_list` is not `None`, `search_ext` will</span>
<span class="sd">                be ignored (default: &#39;bip&#39;).</span>
<span class="sd">            dir_level (`int`): The number of directory levels to search; if</span>
<span class="sd">                `None`, searches all directory levels (default: 0).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">base_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search_ext</span> <span class="o">=</span> <span class="n">search_ext</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir_level</span> <span class="o">=</span> <span class="n">dir_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">io</span> <span class="o">=</span> <span class="n">hsio</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">spat_crop_cols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_try_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">df_row</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">df_row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_check_processed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                         <span class="n">name_append</span><span class="p">,</span> <span class="n">append_extra</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks if any files in fname_list have already (presumably) undergone</span>
<span class="sd">        processing. This is determined by checking if a file exists with a</span>
<span class="sd">        particular name based on the filename in fname_list and naming</span>
<span class="sd">        parameters (i.e,. `folder_name` and `name_append`).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">append_extra</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">append_extra</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">fname_list_final</span> <span class="o">=</span> <span class="n">fname_list</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

            <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="n">append_extra</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">interleave</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">)):</span>
                <span class="n">fname_list_final</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;There are no files to process. Please check if files have &#39;</span>
               <span class="s1">&#39;already undergone processing. If existing files should be &#39;</span>
               <span class="s1">&#39;overwritten, be sure to set the `out_force` parameter.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fname_list_final</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">msg</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing </span><span class="si">{0}</span><span class="s1"> files. If this is not what is expected, please &#39;</span>
              <span class="s1">&#39;check if files have already undergone processing. If existing &#39;</span>
              <span class="s1">&#39;files should be overwritten, be sure to set the `out_force` &#39;</span>
              <span class="s1">&#39;parameter.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fname_list_final</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">fname_list_final</span>

    <span class="k">def</span> <span class="nf">_crop_read_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reads the necessary information from the spreadsheet and saves it</span>
<span class="sd">        to a dictionary</span>

<span class="sd">        If this function causes an error, try checking `batch.defaults` - these</span>
<span class="sd">        should be adjusted according to the default column names of the input</span>
<span class="sd">        (i.e., `fname_sheet`).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">crop_specs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;directory&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;directory&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;fname&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;fname&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;name_short&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;name_short&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;name_long&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;name_long&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;ext&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;ext&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;pix_e_ul&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;pix_e_ul&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;pix_n_ul&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;pix_n_ul&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;plot_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;plot_id&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;alley_size_e_m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;alley_size_e_m&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;alley_size_n_m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;alley_size_n_m&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;alley_size_e_pix&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;alley_size_e_pix&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;alley_size_n_pix&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;alley_size_n_pix&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;buf_e_m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;buf_e_m&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;buf_n_m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;buf_n_m&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;buf_e_pix&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;buf_e_pix&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;buf_n_pix&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;buf_n_pix&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;crop_e_m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;crop_e_m&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;crop_n_m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;crop_n_m&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;crop_e_pix&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;crop_e_pix&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;crop_n_pix&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;crop_n_pix&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;n_plots_x&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;n_plots_x&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;n_plots_y&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;n_plots_y&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">),</span>
                <span class="s1">&#39;n_plots&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_dict</span><span class="p">(</span><span class="s1">&#39;n_plots&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">)}</span>
        <span class="k">if</span> <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;name_short&#39;</span><span class="p">]</span> <span class="o">+</span>
                                       <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;name_long&#39;</span><span class="p">]</span> <span class="o">+</span>
                                       <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;ext&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;name_short&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;name_short&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_name</span><span class="p">[</span>
                        <span class="p">:</span><span class="n">base_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))]</span>
            <span class="k">if</span> <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;name_long&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;name_long&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_name</span><span class="p">[</span>
                        <span class="n">base_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)):]</span>
            <span class="k">if</span> <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;ext&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;ext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">crop_specs</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;name_long&#39;</span><span class="p">]):</span>
            <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;name_long&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;plot_id&#39;</span><span class="p">]):</span>
            <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;plot_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;name_short&#39;</span><span class="p">]):</span>
            <span class="n">crop_specs</span><span class="p">[</span><span class="s1">&#39;name_short&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">crop_specs</span> <span class="o">=</span> <span class="n">crop_specs</span>
        <span class="k">return</span> <span class="n">crop_specs</span>

    <span class="k">def</span> <span class="nf">_pix_to_mapunit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crop_specs</span><span class="p">,</span> <span class="n">spyfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Looks over specifications of `crop_specs`, and converts betweeen pixel</span>
<span class="sd">        units and map units if one is populated and the other is `None`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">crop_specs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">spyfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spyfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span>
        <span class="n">spy_ps_e</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spyfile</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;map info&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">spy_ps_n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spyfile</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;map info&#39;</span><span class="p">][</span><span class="mi">6</span><span class="p">])</span>
        <span class="c1"># Crop size</span>
<span class="c1">#        if cs[&#39;crop_e_pix&#39;] is None and cs[&#39;crop_e_m&#39;] is not None:</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_pix&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_m&#39;</span><span class="p">]):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_m&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">spy_ps_e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_pix&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_m&#39;</span><span class="p">]):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_pix&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">spy_ps_e</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_pix&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_m&#39;</span><span class="p">]):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_m&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">spy_ps_n</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_pix&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_m&#39;</span><span class="p">]):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_pix&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">spy_ps_n</span>
        <span class="c1"># Buffer</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_pix&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_m&#39;</span><span class="p">]):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_m&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">spy_ps_e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_pix&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_m&#39;</span><span class="p">]):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_pix&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">spy_ps_e</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_pix&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_m&#39;</span><span class="p">]):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_m&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">spy_ps_e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_pix&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_m&#39;</span><span class="p">]):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_pix&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">spy_ps_e</span>
        <span class="c1"># Alley size</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_e_pix&#39;</span><span class="p">])</span> <span class="ow">and</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_e_m&#39;</span><span class="p">])):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_e_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_e_m&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">spy_ps_e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_e_pix&#39;</span><span class="p">])</span> <span class="ow">and</span>
                  <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_e_m&#39;</span><span class="p">])):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_e_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_e_pix&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">spy_ps_e</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_n_pix&#39;</span><span class="p">])</span> <span class="ow">and</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_n_m&#39;</span><span class="p">])):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_n_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_n_m&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">spy_ps_n</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_n_pix&#39;</span><span class="p">])</span> <span class="ow">and</span>
                  <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_n_m&#39;</span><span class="p">])):</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_n_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_n_pix&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">spy_ps_n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crop_specs</span> <span class="o">=</span> <span class="n">cs</span>
        <span class="k">return</span> <span class="n">cs</span>

    <span class="k">def</span> <span class="nf">_many_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Wrapper to get consice access to `spatial_mod.crop_many_grid()&#39;&#39;&#39;</span>
        <span class="n">df_plots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span><span class="o">.</span><span class="n">crop_many_grid</span><span class="p">(</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;plot_id&#39;</span><span class="p">],</span> <span class="n">pix_e_ul</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;pix_e_ul&#39;</span><span class="p">],</span> <span class="n">pix_n_ul</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;pix_n_ul&#39;</span><span class="p">],</span>
            <span class="n">crop_e_m</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_m&#39;</span><span class="p">],</span> <span class="n">crop_n_m</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_m&#39;</span><span class="p">],</span>
            <span class="n">alley_size_n_m</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;alley_size_n_m&#39;</span><span class="p">],</span> <span class="n">buf_e_m</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_m&#39;</span><span class="p">],</span>
            <span class="n">buf_n_m</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_m&#39;</span><span class="p">],</span> <span class="n">n_plots_x</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;n_plots_x&#39;</span><span class="p">],</span>
            <span class="n">n_plots_y</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;n_plots_y&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df_plots</span>

    <span class="k">def</span> <span class="nf">_many_gdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Wrapper to get consice access to `spatial_mod.crop_many_gdf();</span>
<span class="sd">        `my_spatial_mod` already has access to `spyfile` and `gdf`, so no need</span>
<span class="sd">        to pass them here.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">df_plots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span><span class="o">.</span><span class="n">crop_many_gdf</span><span class="p">(</span>
            <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;plot_id&#39;</span><span class="p">],</span> <span class="n">pix_e_ul</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;pix_e_ul&#39;</span><span class="p">],</span> <span class="n">pix_n_ul</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;pix_n_ul&#39;</span><span class="p">],</span>
            <span class="n">crop_e_m</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_m&#39;</span><span class="p">],</span> <span class="n">crop_n_m</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_m&#39;</span><span class="p">],</span>
            <span class="n">buf_e_m</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_m&#39;</span><span class="p">],</span> <span class="n">buf_n_m</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_m&#39;</span><span class="p">],</span>
            <span class="n">n_plots</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;n_plots&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df_plots</span>

    <span class="k">def</span> <span class="nf">_band_math_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">name_append</span><span class="p">,</span>
                         <span class="n">method</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;`method` must be one of either &quot;ndi&quot;, &quot;ratio&quot;, &quot;derivative&quot;, &#39;</span>
               <span class="s1">&#39;or &quot;mcari2&quot;.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ndi&#39;</span><span class="p">,</span> <span class="s1">&#39;ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;derivative&#39;</span><span class="p">,</span> <span class="s1">&#39;mcari2&#39;</span><span class="p">],</span> <span class="n">msg</span>

        <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                    <span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                    <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
        <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ndi&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Calculating normalized difference index for: </span><span class="si">{0}</span><span class="s1">&#39;</span>
                  <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_print</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ratio&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Calculating simple ratio index for: </span><span class="si">{0}</span><span class="s1">&#39;</span>
                  <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_print</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_print</span><span class="p">,</span> <span class="n">name_append</span>

    <span class="k">def</span> <span class="nf">_execute_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">,</span> <span class="n">mask_dir</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                      <span class="n">name_append</span><span class="p">,</span> <span class="n">geotiff</span><span class="p">,</span> <span class="n">mask_thresh</span><span class="p">,</span> <span class="n">mask_percentile</span><span class="p">,</span>
                      <span class="n">mask_side</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Actually creates the mask to keep the main function a bit cleaner</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">mask_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mask_percentile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">type_mask</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-thresh-</span><span class="si">{1}</span><span class="s1">-pctl-</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">mask_side</span><span class="p">,</span> <span class="n">mask_thresh</span><span class="p">,</span> <span class="n">mask_percentile</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">mask_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mask_percentile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">type_mask</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-thresh-</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">mask_side</span><span class="p">,</span> <span class="n">mask_thresh</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">mask_thresh</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mask_percentile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">type_mask</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-pctl-</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">mask_side</span><span class="p">,</span> <span class="n">mask_percentile</span><span class="p">))</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">,</span> <span class="s1">&#39;plot_id&#39;</span><span class="p">,</span> <span class="n">type_mask</span><span class="p">]</span>
        <span class="n">df_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">metadata_geotiff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">()</span>
            <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">mask_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mask_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;band_math&#39;</span><span class="p">)</span>
            <span class="n">array_bandmath</span><span class="p">,</span> <span class="n">metadata_bandmath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_array_similar</span><span class="p">(</span>
                    <span class="n">mask_dir</span><span class="p">)</span>
<span class="c1">#            array_bandmath = np.ma.masked_array(</span>
<span class="c1">#                    array_bandmath, mask=array_kmeans.mask)</span>
            <span class="n">array_mask</span><span class="p">,</span> <span class="n">metadata_bandmath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">mask_array</span><span class="p">(</span>
                    <span class="n">array_bandmath</span><span class="p">,</span> <span class="n">metadata_bandmath</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="n">mask_thresh</span><span class="p">,</span>
                    <span class="n">percentile</span><span class="o">=</span><span class="n">mask_percentile</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="n">mask_side</span><span class="p">)</span>

            <span class="n">stat_mask_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">array_mask</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">name_plot</span><span class="p">,</span> <span class="n">stat_mask_mean</span><span class="p">]</span>
            <span class="n">df_stats_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">df_stats</span> <span class="o">=</span> <span class="n">df_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_stats_temp</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">spec_mean</span><span class="p">,</span> <span class="n">spec_std</span><span class="p">,</span> <span class="n">datacube_masked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">mean_datacube</span><span class="p">(</span>
                    <span class="n">array</span><span class="p">,</span> <span class="n">array_mask</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
<span class="c1">#            metadata = self.io.spyfile.metadata.copy()</span>
            <span class="c1"># because this is specialized, we should make our own history str</span>
            <span class="n">hist_str</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot; -&gt; hs_process.batch.segment_create_mask[&lt;&quot;</span>
                        <span class="s2">&quot;label: &#39;mask_thresh?&#39; value:</span><span class="si">{0}</span><span class="s2">; &quot;</span>
                        <span class="s2">&quot;label: &#39;mask_percentile?&#39; value:</span><span class="si">{1}</span><span class="s2">; &quot;</span>
                        <span class="s2">&quot;label: &#39;mask_side?&#39; value:</span><span class="si">{2}</span><span class="s2">&gt;]&quot;</span>
                        <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mask_thresh</span><span class="p">,</span> <span class="n">mask_percentile</span><span class="p">,</span> <span class="n">mask_side</span><span class="p">))</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">hist_str</span>
            <span class="n">metadata_geotiff</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">hist_str</span>

            <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">interleave</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_datacube</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">datacube_masked</span><span class="p">,</span>
                                 <span class="n">metadata</span><span class="p">)</span>
            <span class="n">name_label_spec</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name_label</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                               <span class="s1">&#39;-spec-mean.spec&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_spec</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label_spec</span><span class="p">,</span> <span class="n">spec_mean</span><span class="p">,</span> <span class="n">spec_std</span><span class="p">,</span>
                             <span class="n">metadata</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">array_mask</span> <span class="o">=</span> <span class="n">array_mask</span>
            <span class="k">if</span> <span class="n">geotiff</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_geotiff</span><span class="p">(</span><span class="n">array_mask</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span>
                                    <span class="n">metadata_geotiff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="p">)</span>
<span class="c1">#        n = 1  # because multiple mask events may take place in same folder..</span>
<span class="c1">#        fname_csv = &#39;mask-stats.csv&#39;.format(str(n).zfill(3))</span>
<span class="c1">#        fname_csv_full = os.path.join(dir_out, fname_csv)</span>
<span class="c1">#</span>
<span class="c1">#        while os.path.isfile(fname_csv_full):</span>
<span class="c1">#            n += 1</span>
<span class="c1">#            fname_csv = &#39;mask-stats-{0}.csv&#39;.format(str(n).zfill(3))</span>
<span class="c1">#            dir_name, base_name = os.path.split(fname_csv_full)</span>
<span class="c1">##            base_name, ext = os.path.split(base_name)</span>
<span class="c1">#            fname_csv_full = os.path.join(dir_name, fname_csv)</span>
        <span class="n">fname_csv</span> <span class="o">=</span> <span class="s1">&#39;mask-stats.csv&#39;</span>
        <span class="n">fname_csv_full</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">fname_csv</span><span class="p">)</span>
        <span class="n">df_stats</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname_csv_full</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1">#</span>
<span class="c1">#############################################</span>
<span class="c1">#</span>
<span class="c1">#            name_label_bm = (name_print + name_append + &#39;-{0}-{1}-{2}.&#39;</span>
<span class="c1">#                             &#39;&#39;.format(method, int(np.mean(wl1)),</span>
<span class="c1">#                                       int(np.mean(wl2))) +</span>
<span class="c1">#                             self.io.defaults.interleave)</span>
<span class="c1">#            meta_bm[&#39;label&#39;] = name_label_bm</span>
<span class="c1">#</span>
<span class="c1">#            if mask_thresh is not None or mask_percentile is not None:</span>
<span class="c1">#                array_bm, meta_bm = self.my_segment.tools.mask_array(</span>
<span class="c1">#                        array_bm, metadata, thresh=mask_thresh,</span>
<span class="c1">#                        percentile=mask_percentile, side=mask_side)</span>
<span class="c1">#                name_lab_dc = (name_print + &#39;-{0}-mask-{1}-{2}.&#39;</span>
<span class="c1">#                               &#39;&#39;.format(method, int(np.mean(wl1)),</span>
<span class="c1">#                                         int(np.mean(wl2))) +</span>
<span class="c1">#                               self.io.defaults.interleave)</span>
<span class="c1">#            # should we make an option to save a mean spectra as well?</span>
<span class="c1">#            # Yes - we aren&#39;t required to save intermediate results and do</span>
<span class="c1">#            # another batch process..? we get everything done in one shot -</span>
<span class="c1">#            # after all, why do we want to do band math if we aren&#39;t also</span>
<span class="c1">#            # calculating the average of the area (unless cropping hasn&#39;t</span>
<span class="c1">#            # been perfomed yet)?</span>
<span class="c1">#            # No - Keep it simpler and keep batch functions more specific in</span>
<span class="c1">#            # their capabilities (e.g., batch.band_math, batch.mask_array,</span>
<span class="c1">#            # batch.veg_spectra)</span>
<span class="c1">#</span>
<span class="c1">#            if np.ma.is_masked(array_bm):</span>
<span class="c1">#                # don&#39;t pass thresh, etc. because array is already masked</span>
<span class="c1">#                # pass the spyfile for the metadata (tainted from threshold)</span>
<span class="c1">#                self.io.read_cube(fname)  # read again to get fresh metadata</span>
<span class="c1">#                self.io.spyfile.metadata[&#39;history&#39;] = meta_bm[&#39;history&#39;]</span>
<span class="c1">#                spec_mean, spec_std, datacube_masked, datacube_md =\</span>
<span class="c1">#                    self.my_segment.veg_spectra(</span>
<span class="c1">#                            array_bm, spyfile=self.io.spyfile)</span>
<span class="c1">#                if save_datacube is True:</span>
<span class="c1">#                    hdr_file = os.path.join(dir_out, name_lab_dc + &#39;.hdr&#39;)</span>
<span class="c1">#                    self.io.write_cube(hdr_file, datacube_masked,</span>
<span class="c1">#                                       dtype=self.io.defaults.dtype,</span>
<span class="c1">#                                       force=self.io.defaults.force,</span>
<span class="c1">#                                       ext=self.io.defaults.ext,</span>
<span class="c1">#                                       interleave=self.io.defaults.interleave,</span>
<span class="c1">#                                       byteorder=self.io.defaults.byteorder,</span>
<span class="c1">#                                       metadata=datacube_md)</span>
<span class="c1">#                if save_spec is True:</span>
<span class="c1">#                    spec_md = datacube_md.copy()</span>
<span class="c1">#                    name_label_spec = (os.path.splitext(name_lab_dc)[0] +</span>
<span class="c1">#                                       &#39;-spec-mean.spec&#39;)</span>
<span class="c1">#                    spec_md[&#39;label&#39;] = name_label_spec</span>
<span class="c1">#                    hdr_file = os.path.join(dir_out, name_label_spec + &#39;.hdr&#39;)</span>
<span class="c1">#                    self.io.write_spec(hdr_file, spec_mean, spec_std,</span>
<span class="c1">#                                       dtype=self.io.defaults.dtype,</span>
<span class="c1">#                                       force=self.io.defaults.force,</span>
<span class="c1">#                                       ext=self.io.defaults.ext,</span>
<span class="c1">#                                       interleave=self.io.defaults.interleave,</span>
<span class="c1">#                                       byteorder=self.io.defaults.byteorder,</span>
<span class="c1">#                                       metadata=spec_md)</span>
<span class="c1">#            self._write_datacube(dir_out, name_label_bm, array_bm, metadata)</span>
<span class="c1">#            if geotiff is True:</span>
<span class="c1">#                self._write_geotiff(array_bm, fname, dir_out, name_label_bm,</span>
<span class="c1">#                                    meta_bm, self.my_segment.tools)</span>

    <span class="k">def</span> <span class="nf">_execute_band_math</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                           <span class="n">name_append</span><span class="p">,</span> <span class="n">geotiff</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">wl1</span><span class="p">,</span> <span class="n">wl2</span><span class="p">,</span> <span class="n">wl3</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span>
                           <span class="n">b3</span><span class="p">,</span> <span class="n">list_range</span><span class="p">,</span> <span class="n">plot_out</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Actually executes the band math to keep the main function a bit</span>
<span class="sd">        cleaner</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ndi&#39;</span> <span class="ow">or</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ratio&#39;</span><span class="p">:</span>
            <span class="n">type_bm</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">))))</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;derivative&#39;</span><span class="p">:</span>
            <span class="n">type_bm</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">-</span><span class="si">{3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                                <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">)),</span>
                                                <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">))))</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mcari2&#39;</span><span class="p">:</span>
            <span class="n">type_bm</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">-</span><span class="si">{3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                                <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">)),</span>
                                                <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">))))</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">,</span> <span class="s1">&#39;plot_id&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std_dev&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;pctl_10th&#39;</span><span class="p">,</span> <span class="s1">&#39;pctl_25th&#39;</span><span class="p">,</span> <span class="s1">&#39;pctl_50th&#39;</span><span class="p">,</span> <span class="s1">&#39;pctl_75th&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;pctl_90th&#39;</span><span class="p">,</span> <span class="s1">&#39;pctl_95th&#39;</span><span class="p">]</span>
        <span class="n">df_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_print</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_math_setup</span><span class="p">(</span>
                    <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">name_append</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span> <span class="o">=</span> <span class="n">segment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ndi&#39;</span><span class="p">:</span>
                <span class="n">array_bm</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span><span class="o">.</span><span class="n">band_math_ndi</span><span class="p">(</span>
                        <span class="n">wl1</span><span class="o">=</span><span class="n">wl1</span><span class="p">,</span> <span class="n">wl2</span><span class="o">=</span><span class="n">wl2</span><span class="p">,</span> <span class="n">b1</span><span class="o">=</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="o">=</span><span class="n">b2</span><span class="p">,</span> <span class="n">list_range</span><span class="o">=</span><span class="n">list_range</span><span class="p">,</span>
                        <span class="n">print_out</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;-</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">.</span><span class="si">{3}</span><span class="s1">&#39;</span>
                              <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">)),</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">interleave</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ratio&#39;</span><span class="p">:</span>
                <span class="n">array_bm</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span><span class="o">.</span><span class="n">band_math_ratio</span><span class="p">(</span>
                        <span class="n">wl1</span><span class="o">=</span><span class="n">wl1</span><span class="p">,</span> <span class="n">wl2</span><span class="o">=</span><span class="n">wl2</span><span class="p">,</span> <span class="n">b1</span><span class="o">=</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="o">=</span><span class="n">b2</span><span class="p">,</span> <span class="n">list_range</span><span class="o">=</span><span class="n">list_range</span><span class="p">,</span>
                        <span class="n">print_out</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;-</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">.</span><span class="si">{3}</span><span class="s1">&#39;</span>
                              <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">)),</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">interleave</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;derivative&#39;</span><span class="p">:</span>
                <span class="n">array_bm</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span><span class="o">.</span><span class="n">band_math_derivative</span><span class="p">(</span>
                        <span class="n">wl1</span><span class="o">=</span><span class="n">wl1</span><span class="p">,</span> <span class="n">wl2</span><span class="o">=</span><span class="n">wl2</span><span class="p">,</span> <span class="n">wl3</span><span class="o">=</span><span class="n">wl3</span><span class="p">,</span> <span class="n">b1</span><span class="o">=</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="o">=</span><span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="o">=</span><span class="n">b3</span><span class="p">,</span>
                        <span class="n">list_range</span><span class="o">=</span><span class="n">list_range</span><span class="p">,</span> <span class="n">print_out</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;-</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">-</span><span class="si">{3}</span><span class="s1">.</span><span class="si">{4}</span><span class="s1">&#39;</span>
                              <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">)),</span>
                                        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl3</span><span class="p">)),</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">interleave</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mcari2&#39;</span><span class="p">:</span>
                <span class="n">array_bm</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span><span class="o">.</span><span class="n">band_math_mcari2</span><span class="p">(</span>
                        <span class="n">wl1</span><span class="o">=</span><span class="n">wl1</span><span class="p">,</span> <span class="n">wl2</span><span class="o">=</span><span class="n">wl2</span><span class="p">,</span> <span class="n">wl3</span><span class="o">=</span><span class="n">wl3</span><span class="p">,</span> <span class="n">b1</span><span class="o">=</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="o">=</span><span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="o">=</span><span class="n">b3</span><span class="p">,</span>
                        <span class="n">list_range</span><span class="o">=</span><span class="n">list_range</span><span class="p">,</span> <span class="n">print_out</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;-</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">-</span><span class="si">{3}</span><span class="s1">.</span><span class="si">{4}</span><span class="s1">&#39;</span>
                              <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">)),</span>
                                        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl3</span><span class="p">)),</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">interleave</span><span class="p">))</span>

            <span class="n">stat_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">array_bm</span><span class="p">))</span>
            <span class="n">stat_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">array_bm</span><span class="p">)</span>
            <span class="n">stat_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">array_bm</span><span class="p">)</span>
            <span class="n">stat_med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">array_bm</span><span class="p">)</span>
            <span class="n">stat_pctls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">array_bm</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">95</span><span class="p">])</span>

            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">name_plot</span><span class="p">,</span> <span class="n">stat_count</span><span class="p">,</span> <span class="n">stat_mean</span><span class="p">,</span> <span class="n">stat_std</span><span class="p">,</span>
                    <span class="n">stat_med</span><span class="p">,</span> <span class="n">stat_pctls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stat_pctls</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stat_pctls</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">stat_pctls</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">stat_pctls</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">stat_pctls</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
            <span class="n">df_stats_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">df_stats</span> <span class="o">=</span> <span class="n">df_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_stats_temp</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">plot_out</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">fname_fig</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span>
                                         <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name_label</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                                         <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_plot_histogram</span><span class="p">(</span><span class="n">array_bm</span><span class="p">,</span> <span class="n">fname_fig</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">name_print</span><span class="p">,</span>
                                     <span class="n">xlabel</span><span class="o">=</span><span class="n">type_bm</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">percentile</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                                     <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
                                     <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#444444&#39;</span><span class="p">)</span>

            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_label</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_write_datacube</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">array_bm</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">geotiff</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_geotiff</span><span class="p">(</span><span class="n">array_bm</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span>
                                    <span class="n">metadata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span><span class="o">.</span><span class="n">tools</span><span class="p">)</span>

        <span class="n">fname_stats</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="s1">&#39;-stats.csv&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname_stats</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">force</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">df_stats_in</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_stats</span><span class="p">)</span>
            <span class="n">df_stats</span> <span class="o">=</span> <span class="n">df_stats_in</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_stats</span><span class="p">)</span>
        <span class="n">df_stats</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname_stats</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_get_ndvi_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_class_spec</span><span class="p">,</span> <span class="n">n_classes</span><span class="p">,</span> <span class="n">plot_out</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Find kmeans class with lowest NDVI, which represents the soil class</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">nir_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">get_band</span><span class="p">(</span><span class="mi">760</span><span class="p">)</span>
            <span class="n">re_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">get_band</span><span class="p">(</span><span class="mi">715</span><span class="p">)</span>
            <span class="n">red_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">get_band</span><span class="p">(</span><span class="mi">681</span><span class="p">)</span>
            <span class="n">green_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">get_band</span><span class="p">(</span><span class="mi">555</span><span class="p">)</span>

            <span class="n">nir</span> <span class="o">=</span> <span class="n">df_class_spec</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">nir_b</span><span class="p">]</span>
            <span class="n">re</span> <span class="o">=</span> <span class="n">df_class_spec</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">re_b</span><span class="p">]</span>
            <span class="n">red</span> <span class="o">=</span> <span class="n">df_class_spec</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">red_b</span><span class="p">]</span>
            <span class="n">green</span> <span class="o">=</span> <span class="n">df_class_spec</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">green_b</span><span class="p">]</span>

            <span class="n">df_ndvi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nir</span><span class="o">-</span><span class="n">red</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nir</span><span class="o">+</span><span class="n">red</span><span class="p">)</span>
            <span class="n">class_soil</span> <span class="o">=</span> <span class="n">df_ndvi</span><span class="p">[</span><span class="n">df_ndvi</span> <span class="o">==</span> <span class="n">df_ndvi</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">class_veg</span> <span class="o">=</span> <span class="n">df_ndvi</span><span class="p">[</span><span class="n">df_ndvi</span> <span class="o">==</span> <span class="n">df_ndvi</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">plot_out</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">df_class_spec</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">meta_bands</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_class_spec</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
                <span class="n">legend</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                <span class="n">legend</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;K-means classes&#39;</span><span class="p">)</span>
                <span class="n">legend</span><span class="o">.</span><span class="n">texts</span><span class="p">[</span><span class="n">class_soil</span><span class="p">]</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;Soil&#39;</span><span class="p">)</span>
                <span class="n">legend</span><span class="o">.</span><span class="n">texts</span><span class="p">[</span><span class="n">class_veg</span><span class="p">]</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;Vegetation&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">class_soil</span><span class="p">,</span> <span class="n">class_veg</span>

    <span class="k">def</span> <span class="nf">_execute_kmeans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                        <span class="n">name_append</span><span class="p">,</span> <span class="n">geotiff</span><span class="p">,</span> <span class="n">n_classes</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">,</span>
                        <span class="n">plot_out</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Actually executes the kmeans clustering to keep the main function a bit</span>
<span class="sd">        cleaner</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_classes</span><span class="p">):</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;class_</span><span class="si">{0}</span><span class="s1">_count&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_classes</span><span class="p">):</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;class_</span><span class="si">{0}</span><span class="s1">_ndvi&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_classes</span><span class="p">):</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;class_</span><span class="si">{0}</span><span class="s1">_gndvi&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_classes</span><span class="p">):</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;class_</span><span class="si">{0}</span><span class="s1">_ndre&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_classes</span><span class="p">):</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;class_</span><span class="si">{0}</span><span class="s1">_mcari2&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">df_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="o">.</span><span class="n">metadata</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span> <span class="o">=</span> <span class="n">segment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="p">)</span>

            <span class="n">array_class</span><span class="p">,</span> <span class="n">df_class_spec</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span><span class="o">.</span><span class="n">kmeans</span><span class="p">(</span>
                    <span class="n">n_classes</span><span class="o">=</span><span class="n">n_classes</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span>
                    <span class="n">spyfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="p">)</span>

            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">fname</span><span class="p">]</span>
            <span class="n">nir_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">get_band</span><span class="p">(</span><span class="mi">800</span><span class="p">)</span>
            <span class="n">re_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">get_band</span><span class="p">(</span><span class="mi">720</span><span class="p">)</span>
            <span class="n">red_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">get_band</span><span class="p">(</span><span class="mi">670</span><span class="p">)</span>
            <span class="n">green_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">get_band</span><span class="p">(</span><span class="mi">550</span><span class="p">)</span>
            <span class="n">nir</span> <span class="o">=</span> <span class="n">df_class_spec</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">nir_b</span><span class="p">]</span>
            <span class="n">re</span> <span class="o">=</span> <span class="n">df_class_spec</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">re_b</span><span class="p">]</span>
            <span class="n">red</span> <span class="o">=</span> <span class="n">df_class_spec</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">red_b</span><span class="p">]</span>
            <span class="n">green</span> <span class="o">=</span> <span class="n">df_class_spec</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">green_b</span><span class="p">]</span>
            <span class="n">df_ndvi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nir</span> <span class="o">-</span> <span class="n">red</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nir</span> <span class="o">+</span> <span class="n">red</span><span class="p">)</span>
            <span class="n">df_gndvi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nir</span> <span class="o">-</span> <span class="n">green</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nir</span> <span class="o">+</span> <span class="n">green</span><span class="p">)</span>
            <span class="n">df_ndre</span> <span class="o">=</span> <span class="p">(</span><span class="n">nir</span> <span class="o">-</span> <span class="n">re</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nir</span> <span class="o">+</span> <span class="n">re</span><span class="p">)</span>
            <span class="n">df_mcari2</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">nir</span> <span class="o">-</span> <span class="n">red</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.3</span> <span class="o">*</span> <span class="p">(</span><span class="n">nir</span> <span class="o">-</span> <span class="n">green</span><span class="p">)))</span> <span class="o">/</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nir</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">nir</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">red</span><span class="p">))</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_classes</span><span class="p">):</span>
                <span class="n">class_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_class</span><span class="p">[</span><span class="n">array_class</span> <span class="o">==</span> <span class="n">i</span><span class="p">])</span>
                <span class="n">pix_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_class</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">class_n</span> <span class="o">/</span> <span class="n">pix_n</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>  <span class="c1"># if &lt; 5% of pixels in a class</span>
                    <span class="n">df_ndvi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">df_gndvi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">df_ndre</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">df_mcari2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">array_class</span><span class="p">[</span><span class="n">array_class</span> <span class="o">==</span> <span class="n">i</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">ndvi</span> <span class="ow">in</span> <span class="n">df_ndvi</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ndvi</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">gndvi</span> <span class="ow">in</span> <span class="n">df_gndvi</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gndvi</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ndre</span> <span class="ow">in</span> <span class="n">df_ndre</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ndre</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">mcari2</span> <span class="ow">in</span> <span class="n">df_mcari2</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mcari2</span><span class="p">)</span>

            <span class="n">df_stats_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">df_stats</span> <span class="o">=</span> <span class="n">df_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_stats_temp</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">interleave</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">plot_out</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">df_class_spec</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">meta_bands</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="n">df_class_spec</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;wavelength&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_class_spec</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">name_label</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Reflectance (%)&#39;</span><span class="p">)</span>
                <span class="n">legend</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                <span class="n">legend</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;K-means classes&#39;</span><span class="p">)</span>
<span class="c1">#                legend.texts[class_soil].set_text(&#39;Soil&#39;)</span>
<span class="c1">#                legend.texts[class_veg].set_text(&#39;Vegetation&#39;)</span>
                <span class="n">fname_fig</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span>
                                         <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname_fig</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_write_datacube</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">array_class</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

<span class="c1">#            name_label_spec = (os.path.splitext(name_label)[0] +</span>
<span class="c1">#                                       &#39;-spec-mean.spec&#39;)</span>
<span class="c1">#            self._write_spec(dir_out, name_label, spec_mean, spec_std,</span>
<span class="c1">#                            metadata)</span>
            <span class="k">if</span> <span class="n">geotiff</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_geotiff</span><span class="p">(</span><span class="n">array_class</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span>
                                    <span class="n">metadata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_segment</span><span class="o">.</span><span class="n">tools</span><span class="p">)</span>

<span class="c1">#            if mask_soil is True:</span>
<span class="c1">#                class_soil, class_veg = self._get_ndvi_simple(</span>
<span class="c1">#                        df_class_spec, n_classes, plot_out=True)</span>
<span class="c1">#                array_class = np.ma.masked_where(array_class==class_soil,</span>
<span class="c1">#                                                 array_class)</span>
<span class="c1">#                name_label = (name_print + name_append + &#39;-mask-soil&#39; + &#39;.&#39; +</span>
<span class="c1">#                              self.io.defaults.interleave)</span>
<span class="c1">#                self._write_datacube(dir_out, name_label, array_class,</span>
<span class="c1">#                                     metadata)</span>

        <span class="n">fname_stats</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="s1">&#39;-stats.csv&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname_stats</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">force</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">df_stats_in</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_stats</span><span class="p">)</span>
            <span class="n">df_stats</span> <span class="o">=</span> <span class="n">df_stats_in</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_stats</span><span class="p">)</span>
        <span class="n">df_stats</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname_stats</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_spat_crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_sheet</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                           <span class="n">name_append</span><span class="p">,</span> <span class="n">geotiff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;single&#39;</span><span class="p">,</span>
                           <span class="n">gdf</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Actually executes the spatial crop to keep the main function a bit</span>
<span class="sd">        cleaner</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fname_sheet</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">df_plots</span> <span class="o">=</span> <span class="n">fname_sheet</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname_sheet</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.csv&#39;</span><span class="p">:</span>
            <span class="n">df_plots</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_sheet</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_plots</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crop_read_sheet</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;directory&#39;</span><span class="p">],</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Spatially cropping: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
            <span class="n">name_long</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;name_long&#39;</span><span class="p">]</span>  <span class="c1"># `None` if it was never set</span>
            <span class="n">plot_id</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;plot_id&#39;</span><span class="p">]</span>
            <span class="n">name_short</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;name_short&#39;</span><span class="p">]</span>
            <span class="n">fname_hdr</span> <span class="o">=</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname_hdr</span><span class="p">,</span> <span class="n">name_long</span><span class="o">=</span><span class="n">name_long</span><span class="p">,</span>
                              <span class="n">name_plot</span><span class="o">=</span><span class="n">plot_id</span><span class="p">,</span> <span class="n">name_short</span><span class="o">=</span><span class="n">name_short</span><span class="p">)</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pix_to_mapunit</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span> <span class="o">=</span> <span class="n">spatial_mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="p">,</span> <span class="n">gdf</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;directory&#39;</span><span class="p">],</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
                <span class="n">array_crop</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span><span class="o">.</span><span class="n">crop_single</span><span class="p">(</span>
                        <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;pix_e_ul&#39;</span><span class="p">],</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;pix_n_ul&#39;</span><span class="p">],</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_pix&#39;</span><span class="p">],</span>
                        <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_pix&#39;</span><span class="p">],</span> <span class="n">buf_e_pix</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_pix&#39;</span><span class="p">],</span>
                        <span class="n">buf_n_pix</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_pix&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;plot_id&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">name_plot</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;plot_id&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name_plot</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_plot</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">interleave</span><span class="p">)</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;directory&#39;</span><span class="p">],</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_datacube</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">array_crop</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">geotiff</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_geotiff</span><span class="p">(</span><span class="n">array_crop</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span>
                                        <span class="n">metadata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span><span class="o">.</span><span class="n">tools</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;many_grid&#39;</span><span class="p">:</span>
                    <span class="n">df_plots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_many_grid</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;many_gdf&#39;</span><span class="p">:</span>
                    <span class="n">df_plots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_many_gdf</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_plots</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>  <span class="c1"># actually crop the image</span>
                    <span class="c1"># reload spyfile to my_spatial_mod??</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname_hdr</span><span class="p">,</span> <span class="n">name_long</span><span class="o">=</span><span class="n">name_long</span><span class="p">,</span>
                                      <span class="n">name_plot</span><span class="o">=</span><span class="n">plot_id</span><span class="p">,</span> <span class="n">name_short</span><span class="o">=</span><span class="n">name_short</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span><span class="o">.</span><span class="n">load_spyfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="p">)</span>
                    <span class="n">crop_e_pix</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_e_pix&#39;</span><span class="p">]</span>
                    <span class="n">crop_n_pix</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;crop_n_pix&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">crop_e_pix</span><span class="p">):</span>
                        <span class="n">crop_e_pix</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;crop_e_pix&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">crop_n_pix</span><span class="p">):</span>
                        <span class="n">crop_n_pix</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;crop_n_pix&#39;</span><span class="p">]</span>
                    <span class="n">array_crop</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span><span class="o">.</span><span class="n">crop_single</span><span class="p">(</span>
                        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;pix_e_ul&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;pix_n_ul&#39;</span><span class="p">],</span>
                        <span class="n">crop_e_pix</span><span class="o">=</span><span class="n">crop_e_pix</span><span class="p">,</span>
                        <span class="n">crop_n_pix</span><span class="o">=</span><span class="n">crop_n_pix</span><span class="p">,</span>
                        <span class="n">buf_e_pix</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_e_pix&#39;</span><span class="p">],</span>
                        <span class="n">buf_n_pix</span><span class="o">=</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;buf_n_pix&#39;</span><span class="p">],</span>
                        <span class="n">plot_id</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;plot_id&#39;</span><span class="p">],</span> <span class="n">gdf</span><span class="o">=</span><span class="n">gdf</span><span class="p">)</span>
<span class="c1">#                    metadata = row[&#39;metadata&#39;]</span>
<span class="c1">#                    array_crop = row[&#39;array_crop&#39;]</span>
                    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;plot_id&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">name_plot</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;plot_id&#39;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">name_plot</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_plot</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">interleave</span><span class="p">)</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="s1">&#39;directory&#39;</span><span class="p">],</span> <span class="n">cs</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_datacube</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">array_crop</span><span class="p">,</span>
                                         <span class="n">metadata</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">geotiff</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_write_geotiff</span><span class="p">(</span><span class="n">array_crop</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">,</span>
                                            <span class="n">name_label</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">my_spatial_mod</span><span class="o">.</span><span class="n">tools</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_plots</span> <span class="o">=</span> <span class="n">df_plots</span>

    <span class="k">def</span> <span class="nf">_write_datacube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Writes a datacube to file using `hsio.write_cube()`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_label</span>
        <span class="n">hdr_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_cube</span><span class="p">(</span><span class="n">hdr_file</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                           <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                           <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                           <span class="n">ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">ext</span><span class="p">,</span>
                           <span class="n">interleave</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">interleave</span><span class="p">,</span>
                           <span class="n">byteorder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">byteorder</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_geotiff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
                       <span class="n">tools</span><span class="p">):</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_label</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Projection and Geotransform information are required for &#39;</span>
               <span class="s1">&#39;writing the geotiff. This comes from the input filename, &#39;</span>
               <span class="s1">&#39;so please be sure the correct filename is passed to &#39;</span>
               <span class="s1">&#39;`fname`.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">msg</span>
        <span class="n">fname_tif</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span>
                                 <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name_label</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span><span class="p">)</span>
        <span class="n">img_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">_read_envi_gdal</span><span class="p">(</span><span class="n">fname_in</span><span class="o">=</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">projection_out</span> <span class="o">=</span> <span class="n">img_ds</span><span class="o">.</span><span class="n">GetProjection</span><span class="p">()</span>
<span class="c1">#            geotransform_out = img_ds.GetGeotransform()</span>
        <span class="n">img_ds</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># I only want to use GDAL when I have to..</span>

        <span class="n">map_set</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;map info&#39;</span><span class="p">]</span>
        <span class="n">ul_x_utm</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">get_meta_set</span><span class="p">(</span><span class="n">map_set</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">ul_y_utm</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">get_meta_set</span><span class="p">(</span><span class="n">map_set</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">size_x_m</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">get_meta_set</span><span class="p">(</span><span class="n">map_set</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">size_y_m</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">get_meta_set</span><span class="p">(</span><span class="n">map_set</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="c1"># Note the last pixel size must be negative to begin at upper left</span>
        <span class="n">geotransform_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">ul_x_utm</span><span class="p">,</span> <span class="n">size_x_m</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">ul_y_utm</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                            <span class="o">-</span><span class="n">size_y_m</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_tif</span><span class="p">(</span><span class="n">fname_tif</span><span class="p">,</span> <span class="n">spyfile</span><span class="o">=</span><span class="n">array</span><span class="p">,</span>
                          <span class="n">projection_out</span><span class="o">=</span><span class="n">projection_out</span><span class="p">,</span>
                          <span class="n">geotransform_out</span><span class="o">=</span><span class="n">geotransform_out</span><span class="p">,</span>
                          <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#            if method == &#39;spatial&#39;:</span>
<span class="c1">#                ul_x_utm = self.my_spatial_mod.tools.get_meta_set(map_set, 3)</span>
<span class="c1">#                ul_y_utm = self.my_spatial_mod.tools.get_meta_set(map_set, 4)</span>
<span class="c1">#                size_x_m = self.my_spatial_mod.tools.get_meta_set(map_set, 5)</span>
<span class="c1">#                size_y_m = self.my_spatial_mod.tools.get_meta_set(map_set, 6)</span>
<span class="c1">#            if method == &#39;segment&#39;:</span>
<span class="c1">#                ul_x_utm = self.my_segment.tools.get_meta_set(map_set, 3)</span>
<span class="c1">#                ul_y_utm = self.my_segment.tools.get_meta_set(map_set, 4)</span>
<span class="c1">#                size_x_m = self.my_segment.tools.get_meta_set(map_set, 5)</span>
<span class="c1">#                size_y_m = self.my_segment.tools.get_meta_set(map_set, 6)</span>
<span class="c1">#            if method == &#39;spectral&#39;:</span>
<span class="c1">#                ul_x_utm = self.my_spectral_mod.tools.get_meta_set(map_set, 3)</span>
<span class="c1">#                ul_y_utm = self.my_spectral_mod.tools.get_meta_set(map_set, 4)</span>
<span class="c1">#                size_x_m = self.my_spectral_mod.tools.get_meta_set(map_set, 5)</span>
<span class="c1">#                size_y_m = self.my_spectral_mod.tools.get_meta_set(map_set, 6)</span>

    <span class="k">def</span> <span class="nf">_write_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span> <span class="n">spec_mean</span><span class="p">,</span> <span class="n">spec_std</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="p">):</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_label</span>
        <span class="n">hdr_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_spec</span><span class="p">(</span><span class="n">hdr_file</span><span class="p">,</span> <span class="n">spec_mean</span><span class="p">,</span> <span class="n">spec_std</span><span class="p">,</span>
                           <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                           <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                           <span class="n">ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">ext</span><span class="p">,</span>
                           <span class="n">interleave</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">interleave</span><span class="p">,</span>
                           <span class="n">byteorder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span>
                           <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_spec_clip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                           <span class="n">name_append</span><span class="p">,</span> <span class="n">wl_bands</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Actually executes the spectral clip to keep the main function a bit</span>
<span class="sd">        cleaner</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Spectrally clipping: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
            <span class="c1"># options for io.read_cube():</span>
            <span class="c1"># name_long, name_plot, name_short, individual_plot, overwrite</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span> <span class="o">=</span> <span class="n">spec_mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="p">)</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">()</span>
            <span class="n">array_clip</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span><span class="o">.</span><span class="n">spectral_clip</span><span class="p">(</span>
                    <span class="n">wl_bands</span><span class="o">=</span><span class="n">wl_bands</span><span class="p">)</span>

            <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">interleave</span><span class="p">)</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_label</span>

            <span class="n">hdr_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_cube</span><span class="p">(</span><span class="n">hdr_file</span><span class="p">,</span> <span class="n">array_clip</span><span class="p">,</span>
                               <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                               <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                               <span class="n">ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">ext</span><span class="p">,</span>
                               <span class="n">interleave</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">interleave</span><span class="p">,</span>
                               <span class="n">byteorder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span>
                               <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_spec_combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Actually executes the spectra combine to keep the main function a bit</span>
<span class="sd">        cleaner</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">df_specs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_dir_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_spec</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile_spec</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">pixels</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                       <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pixels</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">df_specs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">df_specs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">df_specs</span> <span class="o">=</span> <span class="n">df_specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_temp</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_mean</span> <span class="o">=</span> <span class="n">df_specs</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mean</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_std</span> <span class="o">=</span> <span class="n">df_specs</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_std</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;std&#39;</span><span class="p">)</span>
        <span class="n">df_cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mean</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_std</span>
        <span class="n">df_cv</span> <span class="o">=</span> <span class="n">df_cv</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;cv&#39;</span><span class="p">)</span>

        <span class="n">hdr_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir_out</span><span class="p">,</span> <span class="s1">&#39;spec_mean_spy.spec.hdr&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_spec</span><span class="p">(</span><span class="n">hdr_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_std</span><span class="p">,</span>
                           <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                           <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                           <span class="n">ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">ext</span><span class="p">,</span>
                           <span class="n">interleave</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">interleave</span><span class="p">,</span>
                           <span class="n">byteorder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span>
                           <span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile_spec</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_spec_smooth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                             <span class="n">name_append</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">stats</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Actually executes the spectral smooth to keep the main function a bit</span>
<span class="sd">        cleaner</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">stats</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">df_smooth_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;cv&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Spectrally smoothing: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span> <span class="o">=</span> <span class="n">spec_mod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="p">)</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">()</span>
            <span class="n">array_smooth</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_spectral_mod</span><span class="o">.</span><span class="n">spectral_smooth</span><span class="p">(</span>
                    <span class="n">window_size</span><span class="o">=</span><span class="n">window_size</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

            <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">interleave</span><span class="p">)</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_label</span>

            <span class="n">hdr_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_cube</span><span class="p">(</span><span class="n">hdr_file</span><span class="p">,</span> <span class="n">array_smooth</span><span class="p">,</span>
                               <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                               <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">force</span><span class="p">,</span>
                               <span class="n">ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">ext</span><span class="p">,</span>
                               <span class="n">interleave</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">interleave</span><span class="p">,</span>
                               <span class="n">byteorder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">byteorder</span><span class="p">,</span>
                               <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">stats</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">array_smooth</span><span class="p">)</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">array_smooth</span><span class="p">)</span>
                <span class="n">cv</span> <span class="o">=</span> <span class="n">std</span><span class="o">/</span><span class="n">mean</span>
                <span class="n">df_smooth_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">fname</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">cv</span><span class="p">]],</span>
                                              <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;cv&#39;</span><span class="p">])</span>
                <span class="n">df_smooth_stats</span> <span class="o">=</span> <span class="n">df_smooth_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_smooth_temp</span><span class="p">,</span>
                                                         <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stats</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">fname_stats</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="s1">&#39;-stats.csv&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname_stats</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">force</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">df_stats_in</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname_stats</span><span class="p">)</span>
                <span class="n">df_smooth_stats</span> <span class="o">=</span> <span class="n">df_stats_in</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_smooth_stats</span><span class="p">)</span>
            <span class="n">df_smooth_stats</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname_stats</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df_smooth_stats</span>

    <span class="k">def</span> <span class="nf">_get_fname_similar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_to_match</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;bip&#39;</span><span class="p">,</span>
                           <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gets a similar filename from another directory</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="n">search_ext</span><span class="p">,</span>
                                      <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">)</span>
        <span class="n">fname_similar</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name_to_match</span> <span class="ow">in</span> <span class="n">fname</span><span class="p">:</span>
                <span class="n">fname_similar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">msg1</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;No files found with a similar name to </span><span class="si">{0}</span><span class="s1">. Please be &#39;</span>
                <span class="s1">&#39;sure the images are created before continuing (e.g., did &#39;</span>
                <span class="s1">&#39;you perform band math yet?)</span><span class="se">\n\n</span><span class="s1">base_dir: </span><span class="si">{1}</span><span class="s1">&#39;</span>
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_to_match</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">))</span>
        <span class="n">msg2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Multiple files found with a similar name to </span><span class="si">{0}</span><span class="s1">. Please &#39;</span>
                <span class="s1">&#39;delete files that are not relevant to continue.</span><span class="se">\n\n</span><span class="s1">base_dir: &#39;</span>
                <span class="s1">&#39;</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_to_match</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fname_similar</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg1</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fname_similar</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg2</span>
        <span class="k">return</span> <span class="n">fname_similar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_array_similar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_search</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Retrieves the array from a directory with a similar name to the loaded</span>
<span class="sd">        datacube (i.e., there must be a datacube loaded; self.io.spyfile should</span>
<span class="sd">        not be `None`; compares to `self.io.name_short`).</span>

<span class="sd">        Parameters:</span>
<span class="sd">            dir_search: directory to search</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please load a SpyFile prior to using this function&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
        <span class="n">fname_kmeans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fname_similar</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">name_short</span><span class="p">,</span> <span class="n">dir_search</span><span class="p">,</span>
                <span class="n">search_ext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">interleave</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">fpath_kmeans</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_search</span><span class="p">,</span> <span class="n">fname_kmeans</span><span class="p">)</span>
        <span class="n">io_mask</span> <span class="o">=</span> <span class="n">hsio</span><span class="p">()</span>
        <span class="n">io_mask</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fpath_kmeans</span><span class="p">)</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">io_mask</span><span class="o">.</span><span class="n">spyfile</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">io_mask</span><span class="o">.</span><span class="n">spyfile</span><span class="o">.</span><span class="n">metadata</span>
        <span class="k">return</span> <span class="n">array</span><span class="p">,</span> <span class="n">metadata</span>

    <span class="k">def</span> <span class="nf">_get_class_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">filter_cols</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finds the class with the lowest NDVI in `row` and returns the class ID</span>
<span class="sd">        to be used to dictate which pixels get masked</span>

<span class="sd">        Parameters:</span>
<span class="sd">            n_classes (`int`): number of classes to mask; if 1, then will mask</span>
<span class="sd">            the minimum ndvi; if more than 1, all classes (default: 1)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">row_ndvi</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">filter_cols</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">row_ndvi</span> <span class="o">=</span> <span class="n">row_ndvi</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">row_ndvi</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">n_classes</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_ndvi</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_classes</span><span class="p">:</span>
            <span class="n">n_classes</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">row_ndvi_small</span> <span class="o">=</span> <span class="n">row_ndvi</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_classes</span><span class="p">)</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="n">row_ndvi_small</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">class_mask</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">class_name</span><span class="p">:</span>
            <span class="n">class_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>
            <span class="n">class_mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_int</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">class_mask</span>

    <span class="k">def</span> <span class="nf">_recurs_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Searches all folders and subfolders recursively within &lt;base_dir&gt;</span>
<span class="sd">        for filetypes of &lt;search_exp&gt;.</span>
<span class="sd">        Returns sorted &lt;outFiles&gt;, a list of full path strings of each result.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            base_dir: directory path that should include files to be returned</span>
<span class="sd">            search_ext: file format/extension to search for in all directories</span>
<span class="sd">                and subdirectories</span>
<span class="sd">            level: how many levels to search; if None, searches all levels</span>

<span class="sd">        Returns:</span>
<span class="sd">            out_files: include the full pathname, filename, and ext of all</span>
<span class="sd">                files that have `search_exp` in their name.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">d_str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="n">out_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">d_str</span><span class="p">:</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">search_ext</span><span class="p">):</span>
                <span class="n">out_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">new_dir</span> <span class="o">=</span> <span class="n">full_path</span>  <span class="c1"># If dir, then search in that</span>
                <span class="n">out_files_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">new_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">out_files_temp</span><span class="p">:</span>  <span class="c1"># if list is not empty</span>
                    <span class="n">out_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">out_files_temp</span><span class="p">)</span>  <span class="c1"># add items</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">out_files</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_save_file_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Basic setup items when saving manipulated image files to disk</span>

<span class="sd">        Parameters:</span>
<span class="sd">            base_dir_out (`str`): Parent directory that all processed datacubes</span>
<span class="sd">                will be saved.</span>
<span class="sd">            folder_name (`str`): Folder to add to `base_dir_out` to save all</span>
<span class="sd">                the processed datacubes.</span>
<span class="sd">            name_append (`str`): name to append to the filename.</span>
<span class="sd">        &#39;&#39;&#39;</span>
<span class="c1">#        if base_dir_out is None:</span>
<span class="c1">#            base_dir_out = os.path.join(self.base_dir, folder_name)</span>
        <span class="n">dir_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dir_out</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dir_out</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name_append</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name_append</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name_append</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                <span class="n">name_append</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">name_append</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span>

    <span class="k">def</span> <span class="nf">_get_name_print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_in</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">name_short</span>
        <span class="k">if</span> <span class="n">name_print</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fname_in</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fname_in</span><span class="p">)</span>
            <span class="n">name_print</span> <span class="o">=</span> <span class="n">base_name</span><span class="p">[:</span><span class="n">base_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Could not get a name for input datacube.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">name_print</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
        <span class="k">return</span> <span class="n">name_print</span>

    <span class="k">def</span> <span class="nf">_plot_histogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">fname_fig</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">percentile</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#444444&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Plots a histogram with the percentile value labeled</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">):</span>
            <span class="n">array_m</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">compressed</span><span class="p">()</span>  <span class="c1"># allows for accurate percentile calc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">array_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">array_m</span> <span class="o">=</span> <span class="n">array_m</span><span class="o">.</span><span class="n">compressed</span><span class="p">()</span>

        <span class="n">pctl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">array_m</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">percentile</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">array_m</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
        <span class="n">data_x</span><span class="p">,</span> <span class="n">data_y</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

        <span class="n">y_lim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">pctl</span><span class="p">,</span> <span class="n">data_x</span><span class="p">,</span> <span class="n">data_y</span><span class="p">)</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">yi</span><span class="o">/</span><span class="n">y_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">pctl</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">ymax</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">boxstyle_str</span> <span class="o">=</span> <span class="s1">&#39;round, pad=0.5, rounding_size=0.15&#39;</span>


        <span class="n">legend_str</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Percentile (</span><span class="si">{0}</span><span class="s1">): </span><span class="si">{1:.3f}</span><span class="s1">&#39;</span>
                      <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percentile</span><span class="p">,</span> <span class="n">pctl</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">legend_str</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">pctl</span><span class="p">,</span> <span class="n">yi</span><span class="p">),</span>
            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.97</span><span class="p">,</span> <span class="mf">0.94</span><span class="p">),</span>  <span class="c1"># loc to place text</span>
            <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span>  <span class="c1"># placed relative to axes</span>
            <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>  <span class="c1"># alignment of text</span>
            <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">),</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="n">boxstyle_str</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                      <span class="n">ec</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-|&gt;&#39;</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
        <span class="c1">#                    patchB=el,</span>
                            <span class="n">shrinkA</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="n">shrinkB</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="n">connectionstyle</span><span class="o">=</span><span class="s1">&#39;arc3,rad=-0.3&#39;</span><span class="p">,</span>
                            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                            <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.7</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency (%)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname_fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

<div class="viewcode-block" id="batch.cube_to_spectra"><a class="viewcode-back" href="../../api/hs_process.batch.batch.html#hs_process.batch.batch.cube_to_spectra">[docs]</a>    <span class="k">def</span> <span class="nf">cube_to_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;bip&#39;</span><span class="p">,</span>
                        <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">folder_name</span><span class="o">=</span><span class="s1">&#39;cube_to_spec&#39;</span><span class="p">,</span>
                        <span class="n">name_append</span><span class="o">=</span><span class="s1">&#39;cube-to-spec&#39;</span><span class="p">,</span>
                        <span class="n">geotiff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">out_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_force</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">out_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_interleave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">out_byteorder</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the mean and standard deviation for each cube in</span>
<span class="sd">        `fname_sheet` and writes the result to a .spec file.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fname_list (`list`, optional): list of filenames to process; if</span>
<span class="sd">                left to `None`, will look at `base_dir`, `search_ext`, and</span>
<span class="sd">                `dir_level` parameters for files to process (default: `None`).</span>
<span class="sd">            base_dir (`str`, optional): directory path to search for files to</span>
<span class="sd">                spectrally clip; if `fname_list` is not `None`, `base_dir` will</span>
<span class="sd">                be ignored (default: `None`).</span>
<span class="sd">            search_ext (`str`): file format/extension to search for in all</span>
<span class="sd">                directories and subdirectories to determine which files to</span>
<span class="sd">                process; if `fname_list` is not `None`, `search_ext` will</span>
<span class="sd">                be ignored (default: &#39;bip&#39;).</span>
<span class="sd">            dir_level (`int`): The number of directory levels to search; if</span>
<span class="sd">                `None`, searches all directory levels (default: 0).</span>
<span class="sd">            base_dir_out (`str`): directory path to save all processed</span>
<span class="sd">                datacubes; if set to `None`, a folder named according to the</span>
<span class="sd">                `folder_name` parameter is added to `base_dir`</span>
<span class="sd">            folder_name (`str`): folder to add to `base_dir_out` to save all</span>
<span class="sd">                the processed datacubes (default: &#39;cube_to_spec&#39;).</span>
<span class="sd">            name_append (`str`): name to append to the filename (default:</span>
<span class="sd">                &#39;cube-to-spec&#39;).</span>
<span class="sd">            geotiff (`bool`): whether to save the masked RGB image as a geotiff</span>
<span class="sd">                alongside the masked datacube.</span>
<span class="sd">            out_XXX: Settings for saving the output files can be adjusted here</span>
<span class="sd">                if desired. They are stored in `batch.io.defaults, and are</span>
<span class="sd">                therefore accessible at a high level. See</span>
<span class="sd">                `hsio.set_io_defaults()` for more information on each of the</span>
<span class="sd">                settings.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the `batch` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set `fname_list` or `base_dir` to indicate which &#39;</span>
                   <span class="s1">&#39;datacubes should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">force</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># otherwise just overwrites if it exists</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_processed</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span>
                                               <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Calculating mean spectra: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_cube</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_append</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file_setup</span><span class="p">(</span>
                        <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>

            <span class="n">spec_mean</span><span class="p">,</span> <span class="n">spec_std</span><span class="p">,</span> <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">mean_datacube</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="p">)</span>

            <span class="n">name_print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name_print</span><span class="p">()</span>
            <span class="n">name_label</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_print</span> <span class="o">+</span> <span class="n">name_append</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">interleave</span><span class="p">)</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># because this is specialized, we should make our own history str</span>
            <span class="n">hist_str</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot; -&gt; hs_process.batch.cube_to_spectra[&lt;&gt;]&quot;</span><span class="p">)</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">hist_str</span>
            <span class="n">name_label_spec</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name_label</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                               <span class="s1">&#39;-mean.spec&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">geotiff</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_geotiff</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label</span><span class="p">,</span>
                                    <span class="n">metadata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="p">)</span>
            <span class="c1"># Now write spec (will change map info on metadata)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_spec</span><span class="p">(</span><span class="n">dir_out</span><span class="p">,</span> <span class="n">name_label_spec</span><span class="p">,</span> <span class="n">spec_mean</span><span class="p">,</span> <span class="n">spec_std</span><span class="p">,</span>
                             <span class="n">metadata</span><span class="p">)</span></div>

<div class="viewcode-block" id="batch.segment_band_math"><a class="viewcode-back" href="../../api/hs_process.batch.batch.html#hs_process.batch.batch.segment_band_math">[docs]</a>    <span class="k">def</span> <span class="nf">segment_band_math</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;bip&#39;</span><span class="p">,</span> <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">folder_name</span><span class="o">=</span><span class="s1">&#39;band_math&#39;</span><span class="p">,</span> <span class="n">name_append</span><span class="o">=</span><span class="s1">&#39;band-math&#39;</span><span class="p">,</span>
                          <span class="n">geotiff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ndi&#39;</span><span class="p">,</span> <span class="n">wl1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wl2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">wl3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">list_range</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_out</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">out_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_force</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">out_interleave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_byteorder</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Batch processing tool to perform band math on multiple datacubes in the</span>
<span class="sd">        same way.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            method (`str`): Must be one of &quot;ndi&quot; (normalized difference index),</span>
<span class="sd">                &quot;ratio&quot; (simple ratio index), &quot;derivative&quot; (deriviative-type</span>
<span class="sd">                index), or &quot;mcari2&quot; (modified chlorophyll absorption index2).</span>
<span class="sd">                Indicates what kind of band</span>
<span class="sd">                math should be performed on the input datacube. The &quot;ndi&quot;</span>
<span class="sd">                method leverages `segment.band_math_ndi()`, the &quot;ratio&quot;</span>
<span class="sd">                method leverages `segment.band_math_ratio()`, and the</span>
<span class="sd">                &quot;derivative&quot; method leverages `segment.band_math_derivative()`.</span>
<span class="sd">                Please see the `segment` documentation for more information</span>
<span class="sd">                (default: &quot;ndi&quot;).</span>
<span class="sd">            wl1 (`int`, `float`, or `list`): the wavelength (or set of</span>
<span class="sd">                wavelengths) to be used as the first parameter of the</span>
<span class="sd">                band math index; if `list`, then consolidates all</span>
<span class="sd">                bands between two wavelength values by calculating the mean</span>
<span class="sd">                pixel value across all bands in that range (default: `None`).</span>
<span class="sd">            wl2 (`int`, `float`, or `list`): the wavelength (or set of</span>
<span class="sd">                wavelengths) to be used as the second parameter of the</span>
<span class="sd">                band math index; if `list`, then consolidates all</span>
<span class="sd">                bands between two wavelength values by calculating the mean</span>
<span class="sd">                pixel value across all bands in that range (default: `None`).</span>
<span class="sd">            b1 (`int`, `float`, or `list`): the band (or set of bands) to be</span>
<span class="sd">                used as the first parameter of the band math index;</span>
<span class="sd">                if `list`, then consolidates all bands between two band values</span>
<span class="sd">                by calculating the mean pixel value across all bands in that</span>
<span class="sd">                range (default: `None`).</span>
<span class="sd">            b2 (`int`, `float`, or `list`): the band (or set of bands) to be</span>
<span class="sd">                used as the second parameter of the band math</span>
<span class="sd">                index; if `list`, then consolidates all bands between two band</span>
<span class="sd">                values by calculating the mean pixel value across all bands in</span>
<span class="sd">                that range (default: `None`).</span>
<span class="sd">            list_range (`bool`): Whether bands/wavelengths passed as a list is</span>
<span class="sd">                interpreted as a range of bands (`True`) or for each individual</span>
<span class="sd">                band in the list (`False`). If `list_range` is `True`,</span>
<span class="sd">                `b1`/`wl1` and `b2`/`wl2` should be lists with two items, and</span>
<span class="sd">                all bands/wavelegths between the two values will be used</span>
<span class="sd">                (default: `True`).</span>
<span class="sd">            plot_out (`bool`): whether to save a histogram of the band math</span>
<span class="sd">                result (default: `True`).</span>
<span class="sd">            geotiff (`bool`): whether to save the masked RGB image as a geotiff</span>
<span class="sd">                alongside the masked datacube.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">set_io_defaults</span><span class="p">(</span><span class="n">out_dtype</span><span class="p">,</span> <span class="n">out_force</span><span class="p">,</span> <span class="n">out_ext</span><span class="p">,</span> <span class="n">out_interleave</span><span class="p">,</span>
                                <span class="n">out_byteorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the `batch` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set `fname_list` or `base_dir` to indicate which &#39;</span>
                   <span class="s1">&#39;datacubes should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="c1"># else fname_list must be passed directly</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ndi&#39;</span><span class="p">:</span>
            <span class="n">append_extra</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;-</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                      <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">))))</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ratio&#39;</span><span class="p">:</span>
            <span class="n">append_extra</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;-</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                      <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">))))</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;derivative&#39;</span><span class="p">:</span>
            <span class="n">append_extra</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;-</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">-</span><span class="si">{3}</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                      <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">)),</span>
                                      <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl3</span><span class="p">))))</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mcari2&#39;</span><span class="p">:</span>
            <span class="n">append_extra</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;-</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">-</span><span class="si">{2}</span><span class="s1">-</span><span class="si">{3}</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl1</span><span class="p">)),</span>
                                      <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl2</span><span class="p">)),</span>
                                      <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl3</span><span class="p">))))</span>

        <span class="c1"># checks filenames</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">force</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># otherwise just overwrites if it exists</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_processed</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span>
                                               <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">,</span>
                                               <span class="n">append_extra</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_band_math</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                                <span class="n">name_append</span><span class="p">,</span> <span class="n">geotiff</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">wl1</span><span class="p">,</span> <span class="n">wl2</span><span class="p">,</span>
                                <span class="n">wl3</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">list_range</span><span class="p">,</span> <span class="n">plot_out</span><span class="p">)</span></div>



<span class="c1">#        if fname_list is not None:</span>
<span class="c1">#            self._execute_band_math(fname_list, base_dir_out, folder_name,</span>
<span class="c1">#                                    name_append, geotiff, method, wl1, wl2,</span>
<span class="c1">#                                    wl3, b1, b2, b3, list_range, plot_out)</span>
<span class="c1">#        elif base_dir is not None:</span>
<span class="c1">#            fname_list = self._recurs_dir(base_dir, search_ext, dir_level)</span>
<span class="c1">#            self._execute_band_math(fname_list, base_dir_out, folder_name,</span>
<span class="c1">#                                    name_append, geotiff, method, wl1, wl2,</span>
<span class="c1">#                                    wl3, b1, b2, b3, list_range, plot_out)</span>
<span class="c1">#        else:  # fname_list and base_dir are both `None`</span>
<span class="c1">#            # base_dir may have been stored to the `batch` object</span>
<span class="c1">#            base_dir = self.base_dir</span>
<span class="c1">#            msg = (&#39;Please set `fname_list` or `base_dir` to indicate which &#39;</span>
<span class="c1">#                   &#39;datacubes should be processed.\n&#39;)</span>
<span class="c1">#            assert base_dir is not None, msg</span>
<span class="c1">#            fname_list = self._recurs_dir(base_dir, search_ext, dir_level)</span>
<span class="c1">#            self._execute_band_math(fname_list, base_dir_out, folder_name,</span>
<span class="c1">#                                    name_append, geotiff, method, wl1, wl2,</span>
<span class="c1">#                                    wl3, b1, b2, b3, list_range, plot_out)</span>

<div class="viewcode-block" id="batch.segment_create_mask"><a class="viewcode-back" href="../../api/hs_process.batch.batch.html#hs_process.batch.batch.segment_create_mask">[docs]</a>    <span class="k">def</span> <span class="nf">segment_create_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;bip&#39;</span><span class="p">,</span> <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">base_dir_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">folder_name</span><span class="o">=</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="n">name_append</span><span class="o">=</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span>
                            <span class="n">geotiff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mask_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">mask_percentile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask_side</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                            <span class="n">out_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_force</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">out_interleave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_byteorder</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Batch processing tool to create a masked array on many datacubes.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            mask_thresh (`float` or `int`): The value for which to mask the</span>
<span class="sd">                array; should be used with `side` parameter (default: `None`).</span>
<span class="sd">            mask_percentile (`float` or `int`): The percentile of pixels to</span>
<span class="sd">                mask; if `percentile`=95 and `side`=&#39;lower&#39;, the lowest 95% of</span>
<span class="sd">                pixels will be masked following the band math operation</span>
<span class="sd">                (default: `None`; range: 0-100).</span>
<span class="sd">            mask_side (`str`): The side of the threshold or percentile for</span>
<span class="sd">                which to apply the mask. Must be either &#39;lower&#39; or &#39;upper&#39;; if</span>
<span class="sd">                &#39;lower&#39;, everything below the threshold/percentile will be</span>
<span class="sd">                masked (default: &#39;lower&#39;).</span>
<span class="sd">            geotiff (`bool`): whether to save the masked RGB image as a geotiff</span>
<span class="sd">                alongside the masked datacube.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">set_io_defaults</span><span class="p">(</span><span class="n">out_dtype</span><span class="p">,</span> <span class="n">out_force</span><span class="p">,</span> <span class="n">out_ext</span><span class="p">,</span> <span class="n">out_interleave</span><span class="p">,</span>
                                <span class="n">out_byteorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the `batch` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set `fname_list` or `base_dir` to indicate which &#39;</span>
                   <span class="s1">&#39;datacubes should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">force</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># otherwise just overwrites if it exists</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_processed</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span>
                                               <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_mask</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">mask_dir</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                           <span class="n">name_append</span><span class="p">,</span> <span class="n">geotiff</span><span class="p">,</span> <span class="n">mask_thresh</span><span class="p">,</span>
                           <span class="n">mask_percentile</span><span class="p">,</span> <span class="n">mask_side</span><span class="p">)</span></div>

<span class="c1">#        if fname_list is not None:</span>
<span class="c1">#            self._execute_mask(fname_list, base_dir_out, folder_name,</span>
<span class="c1">#                               name_append, geotiff, mask_thresh,</span>
<span class="c1">#                               mask_percentile, mask_side)</span>
<span class="c1">#        elif base_dir is not None:</span>
<span class="c1">#            fname_list = self._recurs_dir(base_dir, search_ext, dir_level)</span>
<span class="c1">#            self._execute_mask(fname_list, base_dir_out, folder_name,</span>
<span class="c1">#                               name_append, geotiff, mask_thresh,</span>
<span class="c1">#                               mask_percentile, mask_side)</span>
<span class="c1">#        else:  # fname_list and base_dir are both `None`</span>
<span class="c1">#            # base_dir may have been stored to the `batch` object</span>
<span class="c1">#            base_dir = self.base_dir</span>
<span class="c1">#            msg = (&#39;Please set `fname_list` or `base_dir` to indicate which &#39;</span>
<span class="c1">#                   &#39;datacubes should be processed.\n&#39;)</span>
<span class="c1">#            assert base_dir is not None, msg</span>
<span class="c1">#            fname_list = self._recurs_dir(base_dir, search_ext, dir_level)</span>
<span class="c1">#            self._execute_mask(fname_list, base_dir_out, folder_name,</span>
<span class="c1">#                               name_append, geotiff, mask_thresh,</span>
<span class="c1">#                               mask_percentile, mask_side)</span>

<div class="viewcode-block" id="batch.spatial_crop"><a class="viewcode-back" href="../../api/hs_process.batch.batch.html#hs_process.batch.batch.spatial_crop">[docs]</a>    <span class="k">def</span> <span class="nf">spatial_crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_sheet</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">folder_name</span><span class="o">=</span><span class="s1">&#39;spatial_crop&#39;</span><span class="p">,</span> <span class="n">name_append</span><span class="o">=</span><span class="s1">&#39;spatial-crop&#39;</span><span class="p">,</span>
                     <span class="n">geotiff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="n">gdf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">out_force</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_interleave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">out_byteorder</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Iterates through spreadsheet that provides necessary information about</span>
<span class="sd">        how each image should be cropped and how it should be saved.</span>

<span class="sd">        If `gdf` is passed (a geopandas.GoeDataFrame polygon file), the cropped</span>
<span class="sd">        images will be shifted to the center of appropriate &quot;plot&quot; polygon.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fname_sheet (`fname` or `Pandas.DataFrame): The filename of the</span>
<span class="sd">                spreadsheed that provides the necessary information for batch</span>
<span class="sd">                process cropping. See below for more information about the</span>
<span class="sd">                required and optional contents of `fname_sheet` and how to</span>
<span class="sd">                properly format it. Optionally, `fname_sheet` can be a</span>
<span class="sd">                `Pandas.DataFrame`</span>
<span class="sd">            base_dir_out (`str`): output directory of the cropped image</span>
<span class="sd">                (default: `None`).</span>
<span class="sd">            folder_name (`str`): folder to add to `base_dir_out` to save all</span>
<span class="sd">                the processed datacubes (default: &#39;spatial_crop&#39;).</span>
<span class="sd">            name_append (`str`): name to append to the filename (default:</span>
<span class="sd">                &#39;spatial-crop&#39;).</span>
<span class="sd">            geotiff (`bool`): whether to save an RGB image as a geotiff</span>
<span class="sd">                alongside the cropped datacube.</span>
<span class="sd">            method (`str`): Must be one of &quot;single&quot;, &quot;many_grid&quot;, or</span>
<span class="sd">                &quot;many_gdf&quot;. Indicates whether a single plot should be cropped</span>
<span class="sd">                from the input datacube or if many/multiple plots should be</span>
<span class="sd">                cropped from the input datacube. The &quot;single&quot; method leverages</span>
<span class="sd">                `spatial_mod.crop_single()`, the &quot;many_grid&quot; method leverages</span>
<span class="sd">                `spatial_mod.crop_many_grid()`, and the &quot;many_gdf&quot; method</span>
<span class="sd">                leverages `spatial_mod.crop_many_gdf()` (there are two methods</span>
<span class="sd">                available to peform cropping for many/mulitple plots). Please</span>
<span class="sd">                see the `spatial_mod` documentation for more information</span>
<span class="sd">                (default: &quot;single&quot;).</span>
<span class="sd">            gdf (`geopandas.GeoDataFrame`): the plot names and polygon</span>
<span class="sd">                geometery of each of the plots; &#39;plot&#39; must be used as a column</span>
<span class="sd">                name to identify each of the plots, and should be an integer.</span>
<span class="sd">            out_XXX: Settings for saving the output files can be adjusted here</span>
<span class="sd">                if desired. They are stored in `batch.io.defaults, and are</span>
<span class="sd">                therefore accessible at a high level. See</span>
<span class="sd">                `hsio.set_io_defaults()` for more information on each of the</span>
<span class="sd">                settings.</span>

<span class="sd">        Note:</span>
<span class="sd">            `fname_sheet` may have the following required column headings:</span>
<span class="sd">                1. &quot;directory&quot;</span>
<span class="sd">                2. &quot;name_short&quot;</span>
<span class="sd">                3. &quot;name_long&quot;</span>
<span class="sd">                4. &quot;ext&quot;</span>
<span class="sd">                5. &quot;pix_e_ul&quot;</span>
<span class="sd">                6. &quot;pix_n_ul&quot;.</span>
<span class="sd">            With this minimum input, `batch.spatial_crop` will read in each</span>
<span class="sd">            image, crop from the upper left pixel (determined as</span>
<span class="sd">            `pix_e_ul`/`pix_n_ul`) to the lower right pixel calculated</span>
<span class="sd">            based on `crop_e_pix`/`crop_n_pix` (which is the width of the</span>
<span class="sd">            cropped area in units of pixels). `crop_e_pix` and `crop_n_pix`</span>
<span class="sd">            have default values, but they can also be set in `fname_sheet`,</span>
<span class="sd">            which will take precedence over the defaults.</span>

<span class="sd">            `fname_sheet` may also have the following optional column headings:</span>
<span class="sd">                7. &quot;crop_e_pix&quot;</span>
<span class="sd">                8. &quot;crop_n_pix&quot;</span>
<span class="sd">                9. &quot;crop_e_m&quot;</span>
<span class="sd">                10. &quot;crop_n_m&quot;</span>
<span class="sd">                11. &quot;buf_e_pix&quot;</span>
<span class="sd">                12. &quot;buf_n_pix&quot;,</span>
<span class="sd">                13. &quot;buf_e_m&quot;</span>
<span class="sd">                14. &quot;buf_n_m&quot;</span>
<span class="sd">                15. &quot;plot_id&quot;.</span>
<span class="sd">            These optional inputs allow more control over exactly how the image</span>
<span class="sd">            will be cropped, and hopefully are self-explanatory until</span>
<span class="sd">            adequate documentation is written. Any other columns can</span>
<span class="sd">            be added to `fname_sheet`, but `batch.spatial_crop` does not</span>
<span class="sd">            use them in any way.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;many_gdf&#39;</span><span class="p">:</span>
            <span class="n">msg1</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please pass a valid `geopandas.GeoDataFrame` if using &#39;</span>
                    <span class="s1">&#39;the &quot;many_gdf&quot; method.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">msg2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please be sure the passed `geopandas.GeoDataFrame` has a &#39;</span>
                    <span class="s1">&#39;column by the name of &quot;plot&quot;, indicating the plot ID for &#39;</span>
                    <span class="s1">&#39;each polygon geometry if using the &quot;many_gdf&quot; method.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">),</span> <span class="n">msg1</span>
            <span class="k">assert</span> <span class="s1">&#39;plot&#39;</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">msg2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">set_io_defaults</span><span class="p">(</span><span class="n">out_dtype</span><span class="p">,</span> <span class="n">out_force</span><span class="p">,</span> <span class="n">out_ext</span><span class="p">,</span> <span class="n">out_interleave</span><span class="p">,</span>
                                <span class="n">out_byteorder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_spat_crop</span><span class="p">(</span><span class="n">fname_sheet</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                                <span class="n">name_append</span><span class="p">,</span> <span class="n">geotiff</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">gdf</span><span class="p">)</span></div>

<div class="viewcode-block" id="batch.spectral_clip"><a class="viewcode-back" href="../../api/hs_process.batch.batch.html#hs_process.batch.batch.spectral_clip">[docs]</a>    <span class="k">def</span> <span class="nf">spectral_clip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;bip&#39;</span><span class="p">,</span>
                      <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">folder_name</span><span class="o">=</span><span class="s1">&#39;spec_clip&#39;</span><span class="p">,</span>
                      <span class="n">name_append</span><span class="o">=</span><span class="s1">&#39;spec-clip&#39;</span><span class="p">,</span>
                      <span class="n">wl_bands</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">420</span><span class="p">],</span> <span class="p">[</span><span class="mi">760</span><span class="p">,</span> <span class="mi">776</span><span class="p">],</span> <span class="p">[</span><span class="mi">813</span><span class="p">,</span> <span class="mi">827</span><span class="p">],</span> <span class="p">[</span><span class="mi">880</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]],</span>
                      <span class="n">out_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_force</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">out_interleave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_byteorder</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Batch processing tool to spectrally clip multiple datacubes in the same</span>
<span class="sd">        way.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fname_list (`list`, optional): list of filenames to process; if</span>
<span class="sd">                left to `None`, will look at `base_dir`, `search_ext`, and</span>
<span class="sd">                `dir_level` parameters for files to process (default: `None`).</span>
<span class="sd">            base_dir (`str`, optional): directory path to search for files to</span>
<span class="sd">                spectrally clip; if `fname_list` is not `None`, `base_dir` will</span>
<span class="sd">                be ignored (default: `None`).</span>
<span class="sd">            search_ext (`str`): file format/extension to search for in all</span>
<span class="sd">                directories and subdirectories to determine which files to</span>
<span class="sd">                process; if `fname_list` is not `None`, `search_ext` will</span>
<span class="sd">                be ignored (default: &#39;bip&#39;).</span>
<span class="sd">            dir_level (`int`): The number of directory levels to search; if</span>
<span class="sd">                `None`, searches all directory levels (default: 0).</span>
<span class="sd">            base_dir_out (`str`): directory path to save all processed</span>
<span class="sd">                datacubes; if set to `None`, a folder named according to the</span>
<span class="sd">                `folder_name` parameter is added to `base_dir`</span>
<span class="sd">            folder_name (`str`): folder to add to `base_dir_out` to save all</span>
<span class="sd">                the processed datacubes (default: &#39;spec-clip&#39;).</span>
<span class="sd">            name_append (`str`): name to append to the filename (default:</span>
<span class="sd">                &#39;spec-clip&#39;).</span>
<span class="sd">            wl_bands (`list` or `list of lists`): minimum and maximum</span>
<span class="sd">                wavelenths to clip from image; if multiple groups of</span>
<span class="sd">                wavelengths should be cut, this should be a list of lists. For</span>
<span class="sd">                example, wl_bands=[760, 776] will clip all bands greater than</span>
<span class="sd">                760.0 nm and less than 776.0 nm;</span>
<span class="sd">                wl_bands = [[0, 420], [760, 776], [813, 827], [880, 1000]]</span>
<span class="sd">                will clip all band less than 420.0 nm, bands greater than 760.0</span>
<span class="sd">                nm and less than 776.0 nm, bands greater than 813.0 nm and less</span>
<span class="sd">                than 827.0 nm, and bands greater than 880 nm (default).</span>
<span class="sd">            out_XXX: Settings for saving the output files can be adjusted here</span>
<span class="sd">                if desired. They are stored in `batch.io.defaults, and are</span>
<span class="sd">                therefore accessible at a high level. See</span>
<span class="sd">                `hsio.set_io_defaults()` for more information on each of the</span>
<span class="sd">                settings.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">set_io_defaults</span><span class="p">(</span><span class="n">out_dtype</span><span class="p">,</span> <span class="n">out_force</span><span class="p">,</span> <span class="n">out_ext</span><span class="p">,</span> <span class="n">out_interleave</span><span class="p">,</span>
                                <span class="n">out_byteorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the `batch` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set `fname_list` or `base_dir` to indicate which &#39;</span>
                   <span class="s1">&#39;datacubes should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">force</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># otherwise just overwrites if it exists</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_processed</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span>
                                               <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_spec_clip</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                                    <span class="n">name_append</span><span class="p">,</span> <span class="n">wl_bands</span><span class="p">)</span></div>

<span class="c1">#        if fname_list is not None:</span>
<span class="c1">#            self._execute_spec_clip(fname_list, base_dir_out, folder_name,</span>
<span class="c1">#                                    name_append, wl_bands)</span>
<span class="c1">#        elif base_dir is not None:</span>
<span class="c1">#            fname_list = self._recurs_dir(base_dir, search_ext, dir_level)</span>
<span class="c1">#            self._execute_spec_clip(fname_list, base_dir_out, folder_name,</span>
<span class="c1">#                                    name_append, wl_bands)</span>
<span class="c1">#        else:  # fname_list and base_dir are both `None`</span>
<span class="c1">#            # base_dir may have been stored to the `batch` object</span>
<span class="c1">#            base_dir = self.base_dir</span>
<span class="c1">#            msg = (&#39;Please set `fname_list` or `base_dir` to indicate which &#39;</span>
<span class="c1">#                   &#39;datacubes should be processed.\n&#39;)</span>
<span class="c1">#            assert base_dir is not None, msg</span>
<span class="c1">#            fname_list = self._recurs_dir(base_dir, search_ext, dir_level)</span>
<span class="c1">#            self._execute_spec_clip(fname_list, base_dir_out, folder_name,</span>
<span class="c1">#                                    name_append, wl_bands)</span>

<div class="viewcode-block" id="batch.spectral_smooth"><a class="viewcode-back" href="../../api/hs_process.batch.batch.html#hs_process.batch.batch.spectral_smooth">[docs]</a>    <span class="k">def</span> <span class="nf">spectral_smooth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;bip&#39;</span><span class="p">,</span>
                        <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">folder_name</span><span class="o">=</span><span class="s1">&#39;spec_smooth&#39;</span><span class="p">,</span> <span class="n">name_append</span><span class="o">=</span><span class="s1">&#39;spec-smooth&#39;</span><span class="p">,</span>
                        <span class="n">window_size</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">out_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_force</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">out_interleave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_byteorder</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Batch processing tool to spectrally smooth multiple datacubes in the</span>
<span class="sd">        same way.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fname_list (`list`, optional): list of filenames to process; if</span>
<span class="sd">                left to `None`, will look at `base_dir`, `search_ext`, and</span>
<span class="sd">                `dir_level` parameters for files to process (default: `None`).</span>
<span class="sd">            base_dir (`str`, optional): directory path to search for files to</span>
<span class="sd">                spectrally clip; if `fname_list` is not `None`, `base_dir` will</span>
<span class="sd">                be ignored (default: `None`).</span>
<span class="sd">            search_ext (`str`): file format/extension to search for in all</span>
<span class="sd">                directories and subdirectories to determine which files to</span>
<span class="sd">                process; if `fname_list` is not `None`, `search_ext` will</span>
<span class="sd">                be ignored (default: &#39;bip&#39;).</span>
<span class="sd">            dir_level (`int`): The number of directory levels to search; if</span>
<span class="sd">                `None`, searches all directory levels (default: 0).</span>
<span class="sd">            base_dir_out (`str`): directory path to save all processed</span>
<span class="sd">                datacubes; if set to `None`, a folder named according to the</span>
<span class="sd">                `folder_name` parameter is added to `base_dir`</span>
<span class="sd">            folder_name (`str`): folder to add to `base_dir_out` to save all</span>
<span class="sd">                the processed datacubes (default: &#39;spec-smooth&#39;).</span>
<span class="sd">            name_append (`str`): name to append to the filename (default:</span>
<span class="sd">                &#39;spec-smooth&#39;).</span>
<span class="sd">            window_size (`int`): the length of the window; must be an odd</span>
<span class="sd">                integer number (default: 11).</span>
<span class="sd">            order (`int`): the order of the polynomial used in the filtering;</span>
<span class="sd">                must be less than `window_size` - 1 (default: 2).</span>
<span class="sd">            stats (`bool`): whether to compute some basic descriptive</span>
<span class="sd">                statistics (mean, st. dev., and coefficient of variation) of</span>
<span class="sd">                the smoothed data array (default: `False`)</span>
<span class="sd">            out_XXX: Settings for saving the output files can be adjusted here</span>
<span class="sd">                if desired. They are stored in `batch.io.defaults, and are</span>
<span class="sd">                therefore accessible at a high level. See</span>
<span class="sd">                `hsio.set_io_defaults()` for more information on each of the</span>
<span class="sd">                settings.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">set_io_defaults</span><span class="p">(</span><span class="n">out_dtype</span><span class="p">,</span> <span class="n">out_force</span><span class="p">,</span> <span class="n">out_ext</span><span class="p">,</span> <span class="n">out_interleave</span><span class="p">,</span>
                                <span class="n">out_byteorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the `batch` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set `fname_list` or `base_dir` to indicate which &#39;</span>
                   <span class="s1">&#39;datacubes should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">force</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># otherwise just overwrites if it exists</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_processed</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span>
                                               <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">)</span>
        <span class="n">df_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_spec_smooth</span><span class="p">(</span>
                <span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">name_append</span><span class="p">,</span>
                <span class="n">window_size</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span>

<span class="c1">#        if fname_list is not None:</span>
<span class="c1">#            df_stats = self._execute_spec_smooth(</span>
<span class="c1">#                    fname_list, base_dir_out, folder_name, name_append,</span>
<span class="c1">#                    window_size, order, stats)</span>
<span class="c1">#        elif base_dir is not None:</span>
<span class="c1">#            fname_list = self._recurs_dir(base_dir, search_ext, dir_level)</span>
<span class="c1">#            df_stats = self._execute_spec_smooth(</span>
<span class="c1">#                    fname_list, base_dir_out, folder_name, name_append,</span>
<span class="c1">#                    window_size, order, stats)</span>
<span class="c1">#        else:  # fname_list and base_dir are both `None`</span>
<span class="c1">#            # base_dir may have been stored to the `batch` object</span>
<span class="c1">#            base_dir = self.base_dir</span>
<span class="c1">#            msg = (&#39;Please set `fname_list` or `base_dir` to indicate which &#39;</span>
<span class="c1">#                   &#39;datacubes should be processed.\n&#39;)</span>
<span class="c1">#            assert base_dir is not None, msg</span>
<span class="c1">#            fname_list = self._recurs_dir(base_dir, search_ext, dir_level)</span>
<span class="c1">#            df_stats = self._execute_spec_smooth(</span>
<span class="c1">#                    fname_list, base_dir_out, folder_name, name_append,</span>
<span class="c1">#                    window_size, order, stats)</span>
        <span class="k">if</span> <span class="n">df_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df_stats</span></div>

<div class="viewcode-block" id="batch.spectra_combine"><a class="viewcode-back" href="../../api/hs_process.batch.batch.html#hs_process.batch.batch.spectra_combine">[docs]</a>    <span class="k">def</span> <span class="nf">spectra_combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;bip&#39;</span><span class="p">,</span> <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">out_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_force</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_ext</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">out_interleave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_byteorder</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Batch processing tool to gather all pixels from every image in a</span>
<span class="sd">        directory, compute the mean and standard deviation, and save as a</span>
<span class="sd">        single spectra (i.e., equivalent to a single spectral pixel with no</span>
<span class="sd">        spatial information).</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fname_list (`list`, optional): list of filenames to process; if</span>
<span class="sd">                left to `None`, will look at `base_dir`, `search_ext`, and</span>
<span class="sd">                `dir_level` parameters for files to process (default: `None`).</span>
<span class="sd">            base_dir (`str`, optional): directory path to search for files to</span>
<span class="sd">                spectrally clip; if `fname_list` is not `None`, `base_dir` will</span>
<span class="sd">                be ignored (default: `None`).</span>
<span class="sd">            search_ext (`str`): file format/extension to search for in all</span>
<span class="sd">                directories and subdirectories to determine which files to</span>
<span class="sd">                process; if `fname_list` is not `None`, `search_ext` will</span>
<span class="sd">                be ignored (default: &#39;bip&#39;).</span>
<span class="sd">            dir_level (`int`): The number of directory levels to search; if</span>
<span class="sd">                `None`, searches all directory levels (default: 0).</span>
<span class="sd">            base_dir_out (`str`): directory path to save all processed</span>
<span class="sd">                datacubes; if set to `None`, a folder named according to the</span>
<span class="sd">                `folder_name` parameter is added to `base_dir`</span>
<span class="sd">            out_XXX: Settings for saving the output files can be adjusted here</span>
<span class="sd">                if desired. They are stored in `batch.io.defaults, and are</span>
<span class="sd">                therefore accessible at a high level. See</span>
<span class="sd">                `hsio.set_io_defaults()` for more information on each of the</span>
<span class="sd">                settings.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">set_io_defaults</span><span class="p">(</span><span class="n">out_dtype</span><span class="p">,</span> <span class="n">out_force</span><span class="p">,</span> <span class="n">out_ext</span><span class="p">,</span> <span class="n">out_interleave</span><span class="p">,</span>
                                <span class="n">out_byteorder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the `batch` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set `fname_list` or `base_dir` to indicate which &#39;</span>
                   <span class="s1">&#39;datacubes should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_spec_combine</span><span class="p">(</span><span class="n">fname_list</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="p">)</span></div>

<div class="viewcode-block" id="batch.spectra_to_csv"><a class="viewcode-back" href="../../api/hs_process.batch.batch.html#hs_process.batch.batch.spectra_to_csv">[docs]</a>    <span class="k">def</span> <span class="nf">spectra_to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;spec&#39;</span><span class="p">,</span>
                       <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_dir_out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reads all the .spec files in a direcory and saves their reflectance</span>
<span class="sd">        information to a .csv</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fname_list (`list`, optional): list of filenames to process; if</span>
<span class="sd">                left to `None`, will look at `base_dir`, `search_ext`, and</span>
<span class="sd">                `dir_level` parameters for files to process (default: `None`).</span>
<span class="sd">            base_dir (`str`, optional): directory path to search for files to</span>
<span class="sd">                spectrally clip; if `fname_list` is not `None`, `base_dir` will</span>
<span class="sd">                be ignored (default: `None`).</span>
<span class="sd">            search_ext (`str`): file format/extension to search for in all</span>
<span class="sd">                directories and subdirectories to determine which files to</span>
<span class="sd">                process; if `fname_list` is not `None`, `search_ext` will</span>
<span class="sd">                be ignored (default: &#39;bip&#39;).</span>
<span class="sd">            dir_level (`int`): The number of directory levels to search; if</span>
<span class="sd">                `None`, searches all directory levels (default: 0).</span>
<span class="sd">            base_dir_out (`str`): directory path to save all processed</span>
<span class="sd">                datacubes; if set to `None`, a folder named according to the</span>
<span class="sd">                `folder_name` parameter is added to `base_dir`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the `batch` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set `fname_list` or `base_dir` to indicate which &#39;</span>
                   <span class="s1">&#39;datacubes should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>

        <span class="c1"># load the data from the Spectral Python (SpyFile) object</span>
        <span class="n">df_spec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_spec</span><span class="p">(</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span><span class="p">)</span>
            <span class="n">meta_bands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">meta_bands</span>
            <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile_spec</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">name_plot</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">df_spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">meta_bands</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;wavelength&#39;</span><span class="p">)</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">bands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">meta_bands</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">bands</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;plot_id&#39;</span><span class="p">)</span>
                <span class="n">bands</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;fname&#39;</span><span class="p">)</span>
                <span class="n">df_spec</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">bands</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">df_spec_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">df_spec</span> <span class="o">=</span> <span class="n">df_spec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_spec_temp</span><span class="p">)</span>
        <span class="n">fname_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;stats-spectra.csv&#39;</span><span class="p">)</span>
        <span class="n">df_spec</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="batch.spectra_to_df"><a class="viewcode-back" href="../../api/hs_process.batch.batch.html#hs_process.batch.batch.spectra_to_df">[docs]</a>    <span class="k">def</span> <span class="nf">spectra_to_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_ext</span><span class="o">=</span><span class="s1">&#39;spec&#39;</span><span class="p">,</span>
                      <span class="n">dir_level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reads all the .spec files in a direcory and returns their data as a</span>
<span class="sd">        pandas.DataFrame object.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            fname_list (`list`, optional): list of filenames to process; if</span>
<span class="sd">                left to `None`, will look at `base_dir`, `search_ext`, and</span>
<span class="sd">                `dir_level` parameters for files to process (default: `None`).</span>
<span class="sd">            base_dir (`str`, optional): directory path to search for files to</span>
<span class="sd">                spectrally clip; if `fname_list` is not `None`, `base_dir` will</span>
<span class="sd">                be ignored (default: `None`).</span>
<span class="sd">            search_ext (`str`): file format/extension to search for in all</span>
<span class="sd">                directories and subdirectories to determine which files to</span>
<span class="sd">                process; if `fname_list` is not `None`, `search_ext` will</span>
<span class="sd">                be ignored (default: &#39;bip&#39;).</span>
<span class="sd">            dir_level (`int`): The number of directory levels to search; if</span>
<span class="sd">                `None`, searches all directory levels (default: 0).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fname_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_dir may have been stored to the `batch` object</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Please set `fname_list` or `base_dir` to indicate which &#39;</span>
                   <span class="s1">&#39;datacubes should be processed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">fname_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurs_dir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">search_ext</span><span class="p">,</span> <span class="n">dir_level</span><span class="p">)</span>

        <span class="c1"># load the data from the Spectral Python (SpyFile) object</span>
        <span class="n">df_spec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fname_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_spec</span><span class="p">(</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.hdr&#39;</span><span class="p">)</span>
            <span class="n">meta_bands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">meta_bands</span>
            <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">spyfile_spec</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
            <span class="n">data</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">name_plot</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">df_spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">meta_bands</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">bands</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;plot_id&#39;</span><span class="p">)</span>
                <span class="n">bands</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;fname&#39;</span><span class="p">)</span>
                <span class="n">df_spec</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">bands</span><span class="p">)</span>
            <span class="n">df_spec_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">bands</span><span class="p">)</span>
            <span class="n">df_spec</span> <span class="o">=</span> <span class="n">df_spec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_spec_temp</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df_spec</span><span class="p">[</span><span class="s1">&#39;plot_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df_spec</span><span class="p">[</span><span class="s1">&#39;plot_id&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unable to convert &quot;plot_id&quot; column to numeric type.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_spec</span></div></div>
<span class="c1">#        if isinstance(df, pd.DataFrame):</span>
<span class="c1">#            df_data = df.copy()</span>
<span class="c1">#        elif isinstance(df, str):</span>
<span class="c1">#            df_data = pd.read_csv(df)</span>
<span class="c1">#        df_join = pd.merge(df_spec, df_data, on=[join_field])</span>
<span class="c1">#        return df_spec</span>

<span class="c1">#    def combine_kmeans_bandmath(self, fname_sheet, base_dir_out=None,</span>
<span class="c1">#                                folder_name=&#39;mask_combine&#39;,</span>
<span class="c1">#                                name_append=&#39;mask-combine&#39;,</span>
<span class="c1">#                                geotiff=True, kmeans_mask_classes=1,</span>
<span class="c1">#                                kmeans_filter=&#39;mcari2&#39;,</span>
<span class="c1">#                                mask_percentile=90, mask_side=&#39;lower&#39;,</span>
<span class="c1">#                                out_dtype=False, out_force=None, out_ext=False,</span>
<span class="c1">#                                out_interleave=False, out_byteorder=False):</span>
<span class="c1">#        &#39;&#39;&#39;</span>
<span class="c1">#</span>
<span class="c1">#        Parameters:</span>
<span class="c1">#            fname_sheet (`fname` or `Pandas.DataFrame): The filename of the</span>
<span class="c1">#                spreadsheed that provides the necessary information for batch</span>
<span class="c1">#                process cropping. See below for more information about the</span>
<span class="c1">#                required and optional contents of `fname_sheet` and how to</span>
<span class="c1">#                properly format it. Optionally, `fname_sheet` can be a</span>
<span class="c1">#                `Pandas.DataFrame`</span>
<span class="c1">#            kmeans_mask_classes (`int`): number of K-means classes to mask from</span>
<span class="c1">#                the datacube. By default, the classes with the lowest average</span>
<span class="c1">#                spectral value (e.g., NDVI, GNDVI, MCARI2, etc.; based on</span>
<span class="c1">#                `kmeans_filter` parameter) will be masked (default: 1).</span>
<span class="c1">#            kmeans_filter (`str`): the spectral index to base the K-means mask</span>
<span class="c1">#                on. Must be one of &#39;ndvi&#39;, &#39;gndvi&#39;, &#39;ndre&#39;, or &#39;mcari2&#39;. Note</span>
<span class="c1">#                that the K-means aglorithm does not use the in its clustering</span>
<span class="c1">#                algorithm (default: &#39;mcari2&#39;).</span>
<span class="c1">#        Mask steps:</span>
<span class="c1">#            1. load kmeans-stats.csv</span>
<span class="c1">#            2. for each row, load spyfile based on &quot;fname&quot;</span>
<span class="c1">#            3. get class to mask based on:</span>
<span class="c1">#                a. find class with min ndvi: min_class = np.nanmin(class_X_ndvi)</span>
<span class="c1">#            4. mask all pixels of min_class</span>
<span class="c1">#            5. calculate band math (or load images with band math already calculated)</span>
<span class="c1">#            6. mask all pixels below threshold/perecentile</span>
<span class="c1">#                a. if percentile, use pctl to determine number of pixels to keep</span>
<span class="c1">#                b. if pctl = 90, we should keep 10% of total pixels:</span>
<span class="c1">#                    i. find total number of pixels</span>
<span class="c1">#                    ii. calculate what 10% is (155*46 = 7130); 7130 * .1 = 713</span>
<span class="c1">#                    iii. of pixels that are not masked by kmeans, find 713 pixels with highest bandmath</span>
<span class="c1">#                c. if thresh, number doesn&#39;t matter</span>
<span class="c1">#            7. apply the mask to the datacube and save spectra</span>
<span class="c1">#        &#39;&#39;&#39;</span>
<span class="c1">#        self.io.set_io_defaults(out_dtype, out_force, out_ext, out_interleave,</span>
<span class="c1">#                                out_byteorder)</span>
<span class="c1">#</span>
<span class="c1">#        if isinstance(fname_sheet, pd.DataFrame):</span>
<span class="c1">#            df_kmeans = fname_sheet.copy()</span>
<span class="c1">#            fname_sheet = &#39;dataframe passed&#39;</span>
<span class="c1">#        elif os.path.splitext(fname_sheet)[1] == &#39;.csv&#39;:</span>
<span class="c1">#            df_kmeans = pd.read_csv(fname_sheet)</span>
<span class="c1">#</span>
<span class="c1">#        msg = (&#39;&lt;kmeans_filter&gt; must be one of &quot;ndvi&quot;, &quot;gndvi&quot;, &quot;ndre&quot;, &#39;</span>
<span class="c1">#               &#39;or &quot;mcari2&quot;.&#39;)</span>
<span class="c1">#        assert kmeans_filter in [&#39;ndvi&#39;, &#39;gndvi&#39;, &#39;ndre&#39;, &#39;mcari2&#39;], msg</span>
<span class="c1">#        filter_str = &#39;_{0}&#39;.format(kmeans_filter)</span>
<span class="c1">#        filter_cols = [col for col in df_kmeans.columns if filter_str in col]</span>
<span class="c1">#</span>
<span class="c1">#        bandmath_pctl_str = &#39;{0}_pctl&#39;.format(kmeans_filter)</span>
<span class="c1">#        bandmath_side_str = &#39;{0}_side&#39;.format(kmeans_filter)</span>
<span class="c1">#        columns = [&#39;fname&#39;, &#39;kmeans_class&#39;, &#39;kmeans_nonmasked_pct&#39;,</span>
<span class="c1">#                   bandmath_pctl_str, bandmath_side_str, &#39;total_nonmasked_pct&#39;]</span>
<span class="c1">#        df_stats = pd.DataFrame(columns=columns)</span>
<span class="c1">#</span>
<span class="c1">#        if self.io.defaults.force is False:  # otherwise just overwrites if it exists</span>
<span class="c1">#            fname_list = df_kmeans[&#39;fname&#39;].tolist()</span>
<span class="c1">#            fname_list = self._check_processed(fname_list, base_dir_out,</span>
<span class="c1">#                                               folder_name, name_append)</span>
<span class="c1">#            df_kmeans = df_kmeans[df_kmeans[&#39;plot_id&#39;].isin(fname_list)]</span>
<span class="c1">#</span>
<span class="c1">#        for idx, row in df_kmeans.iterrows():  # using stats-kmeans.csv</span>
<span class="c1">#            class_mask = self._get_class_mask(row, filter_cols,</span>
<span class="c1">#                                              n_classes=kmeans_mask_classes)</span>
<span class="c1">#            fname = row[&#39;fname&#39;]</span>
<span class="c1">#            self.io.read_cube(fname)</span>
<span class="c1">#            if base_dir_out is None:</span>
<span class="c1">#                dir_out, name_append = self._save_file_setup(</span>
<span class="c1">#                        os.path.dirname(fname), folder_name, name_append)</span>
<span class="c1">#            else:</span>
<span class="c1">#                dir_out, name_append = self._save_file_setup(</span>
<span class="c1">#                        base_dir_out, folder_name, name_append)</span>
<span class="c1">#            name_print = self._get_name_print()</span>
<span class="c1">#</span>
<span class="c1">#            dir_search = os.path.join(self.io.base_dir, &#39;kmeans&#39;)</span>
<span class="c1">#            array_kmeans, metadata_kmeans = self._get_array_similar(dir_search)</span>
<span class="c1">#            dir_search = os.path.join(self.io.base_dir, &#39;band_math&#39;)</span>
<span class="c1">#            array_bandmath, metadata_bandmath = self._get_array_similar(</span>
<span class="c1">#                    dir_search)</span>
<span class="c1">#</span>
<span class="c1">#            array_kmeans, metadata_kmeans = self.io.tools.mask_array(</span>
<span class="c1">#                    array_kmeans, metadata_kmeans, thresh=class_mask,</span>
<span class="c1">#                    side=None)  # when side=None, masks the exact match</span>
<span class="c1">#            kmeans_pct = (100 * (array_kmeans.count() /</span>
<span class="c1">#                            (array_kmeans.shape[0]*array_kmeans.shape[1])))</span>
<span class="c1">#</span>
<span class="c1">#            # by adding the kmeans mask, hstools.mask_array will consider that</span>
<span class="c1">#            # mask when masking by bandmath values (applicable for percentile)</span>
<span class="c1">#            array_bandmath = np.ma.masked_array(</span>
<span class="c1">#                    array_bandmath, mask=array_kmeans.mask)</span>
<span class="c1">#            mask_combined, metadata_bandmath = self.io.tools.mask_array(</span>
<span class="c1">#                    array_bandmath, metadata_bandmath,</span>
<span class="c1">#                    percentile=mask_percentile, side=mask_side)</span>
<span class="c1">#            total_pct = (100 * (mask_combined.count() /</span>
<span class="c1">#                            (mask_combined.shape[0]*mask_combined.shape[1])))</span>
<span class="c1">#            spec_mean, spec_std, datacube_masked = self.io.tools.mean_datacube(</span>
<span class="c1">#                    self.io.spyfile, mask_combined)</span>
<span class="c1">#</span>
<span class="c1">#            data = [os.path.basename(fname), class_mask, kmeans_pct,</span>
<span class="c1">#                    mask_percentile, mask_side, total_pct]</span>
<span class="c1">#            df_stats_temp = pd.DataFrame(data=[data], columns=columns)</span>
<span class="c1">#            df_stats = df_stats.append(df_stats_temp)</span>
<span class="c1">#            name_label = (name_print + name_append + &#39;.&#39; +</span>
<span class="c1">#                          self.io.defaults.interleave)</span>
<span class="c1">#            metadata = self.io.spyfile.metadata.copy()</span>
<span class="c1">#            # because this is specialized, we should make our own history str</span>
<span class="c1">#            hist_str = (&quot; -&gt; hs_process.batch.combine_kmeans_bandmath[&lt;&quot;</span>
<span class="c1">#                        &quot;label: &#39;fname_sheet?&#39; value:{0}; &quot;</span>
<span class="c1">#                        &quot;label: &#39;kmeans_class?&#39; value:{1}; &quot;</span>
<span class="c1">#                        &quot;label: &#39;mask_percentile?&#39; value:{2}; &quot;</span>
<span class="c1">#                        &quot;label: &#39;mask_side?&#39; value:{3}&gt;]&quot;</span>
<span class="c1">#                        &quot;&quot;.format(fname_sheet, class_mask, mask_percentile,</span>
<span class="c1">#                                  mask_side))</span>
<span class="c1">#            metadata[&#39;history&#39;] += hist_str</span>
<span class="c1">#            self._write_datacube(dir_out, name_label, datacube_masked,</span>
<span class="c1">#                                 metadata)</span>
<span class="c1">#</span>
<span class="c1">#            name_label_spec = (os.path.splitext(name_label)[0] +</span>
<span class="c1">#                               &#39;-spec-mean.spec&#39;)</span>
<span class="c1">#            self._write_spec(dir_out, name_label_spec, spec_mean, spec_std,</span>
<span class="c1">#                             metadata)</span>
<span class="c1">#        fname_stats = os.path.join(dir_out, name_append[1:] + &#39;-stats.csv&#39;)</span>
<span class="c1">#        if os.path.isfile(fname_stats) and self.io.defaults.force is False:</span>
<span class="c1">#            df_stats_in = pd.read_csv(fname_stats)</span>
<span class="c1">#            df_stats = df_stats_in.append(df_stats)</span>
<span class="c1">#        df_stats.to_csv(fname_stats, index=False)</span>

<span class="c1">#    def segment_kmeans(self, fname_list=None, base_dir=None, search_ext=&#39;bip&#39;,</span>
<span class="c1">#                       dir_level=0, base_dir_out=None, folder_name=&#39;kmeans&#39;,</span>
<span class="c1">#                       name_append=&#39;kmeans&#39;, geotiff=True,</span>
<span class="c1">#                       n_classes=3, max_iter=100, plot_out=True,</span>
<span class="c1">#                       out_dtype=False, out_force=None,</span>
<span class="c1">#                       out_ext=False, out_interleave=False,</span>
<span class="c1">#                       out_byteorder=False):</span>
<span class="c1">#        &#39;&#39;&#39;</span>
<span class="c1">#        Batch processing tool to perform kmeans clustering on multiple</span>
<span class="c1">#        datacubes in the same way (uses Spectral Python kmeans tool).</span>
<span class="c1">#</span>
<span class="c1">#        Parameters:</span>
<span class="c1">#            n_classes (`int`): number of classes to cluster (default: 3).</span>
<span class="c1">#            max_iter (`int`): maximum iterations before terminating process</span>
<span class="c1">#                (default: 100).</span>
<span class="c1">#            plot_out (`bool`): whether to save a line plot of the spectra for</span>
<span class="c1">#                each class (default: `True`).</span>
<span class="c1">#            geotiff (`bool`): whether to save the masked RGB image as a geotiff</span>
<span class="c1">#                alongside the masked datacube.</span>
<span class="c1">#        &#39;&#39;&#39;</span>
<span class="c1">#        self.io.set_io_defaults(out_dtype, out_force, out_ext, out_interleave,</span>
<span class="c1">#                                out_byteorder)</span>
<span class="c1">#        if fname_list is None and base_dir is not None:</span>
<span class="c1">#            fname_list = self._recurs_dir(base_dir, search_ext, dir_level)</span>
<span class="c1">#        elif fname_list is None and base_dir is None:</span>
<span class="c1">#            # base_dir may have been stored to the `batch` object</span>
<span class="c1">#            base_dir = self.base_dir</span>
<span class="c1">#            msg = (&#39;Please set `fname_list` or `base_dir` to indicate which &#39;</span>
<span class="c1">#                   &#39;datacubes should be processed.\n&#39;)</span>
<span class="c1">#            assert base_dir is not None, msg</span>
<span class="c1">#            fname_list = self._recurs_dir(base_dir, search_ext, dir_level)</span>
<span class="c1">#</span>
<span class="c1">#        if self.io.defaults.force is False:  # otherwise just overwrites if it exists</span>
<span class="c1">#            fname_list = self._check_processed(fname_list, base_dir_out,</span>
<span class="c1">#                                               folder_name, name_append)</span>
<span class="c1">#        self._execute_kmeans(fname_list, base_dir_out, folder_name,</span>
<span class="c1">#                             name_append, geotiff, n_classes, max_iter,</span>
<span class="c1">#                             plot_out)</span>
<span class="c1">#</span>
<span class="c1">##        if fname_list is not None:</span>
<span class="c1">##            self._execute_kmeans(fname_list, base_dir_out, folder_name,</span>
<span class="c1">##                                 name_append, geotiff, n_classes, max_iter,</span>
<span class="c1">##                                 plot_out, mask_soil=False)</span>
<span class="c1">##        elif base_dir is not None:</span>
<span class="c1">##            fname_list = self._recurs_dir(base_dir, search_ext, dir_level)</span>
<span class="c1">##            self._execute_kmeans(fname_list, base_dir_out, folder_name,</span>
<span class="c1">##                                 name_append, geotiff, n_classes, max_iter,</span>
<span class="c1">##                                 plot_out, mask_soil=False)</span>
<span class="c1">##        else:  # fname_list and base_dir are both `None`</span>
<span class="c1">##            # base_dir may have been stored to the `batch` object</span>
<span class="c1">##            base_dir = self.base_dir</span>
<span class="c1">##            msg = (&#39;Please set `fname_list` or `base_dir` to indicate which &#39;</span>
<span class="c1">##                   &#39;datacubes should be processed.\n&#39;)</span>
<span class="c1">##            assert base_dir is not None, msg</span>
<span class="c1">##            fname_list = self._recurs_dir(base_dir, search_ext, dir_level)</span>
<span class="c1">##            self._execute_kmeans(fname_list, base_dir_out, folder_name,</span>
<span class="c1">##                                 name_append, geotiff, n_classes, max_iter,</span>
<span class="c1">##                                 plot_out, mask_soil=False)</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2020, Tyler J. Nigon.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.1.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>